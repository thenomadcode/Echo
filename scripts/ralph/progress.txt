## Codebase Patterns
- Schema tables use `defineTable()` with `v` validators from "convex/values"
- TailwindCSS 4: custom fonts defined in `@theme inline` block with `--font-*` variables
- Google Fonts: use preconnect hints + `display=swap` for optimal loading
- Auth pattern: `authComponent.safeGetAuthUser(ctx)` returns authUser with `userId` property - always check `!authUser || !authUser.userId`
- After auth check, store userId in const: `const userId = authUser.userId;` to avoid TypeScript narrowing issues
- Owner references use `ownerId: v.string()` (not v.id) since authUser.userId is a string
- Timestamps stored as `v.number()` in UTC, populated with `Date.now()` in mutations
- Optional fields use `v.optional(v.type)` wrapper
- Enum-like fields use `v.union(v.literal("value1"), v.literal("value2"))`
- Indexes defined with `.index("indexName", ["field"])` chained after defineTable
- Nested objects use `v.object({ field: v.type })`
- Mutations use `Record<string, unknown>` for update objects to avoid optional field type conflicts
- Uniqueness validation: query by index in loop, append suffix if exists
- Queries return null/empty arrays for unauthorized access; mutations throw errors
- Lib utilities: create under `convex/lib/` using `GenericDatabaseReader<DataModel>` for db access
- Dashboard conversation status: active | escalated | closed (separate from AI state machine)
- Human assignment: assignedTo field with v.string() (user ID from better-auth), null/undefined means AI handling
- TanStack Router layout routes: `_authenticated.tsx` creates pathless layout, child routes go in `_authenticated/` folder
- Base UI AlertDialog: does NOT support asChild prop - use controlled open state instead of AlertDialogTrigger
- Sidebar context pattern: use SidebarContext + SidebarProvider for shared collapsed state between Sidebar and layout
- Sidebar collapsible animation: use `transition-[width] duration-200` for smooth width changes
- Content area responds to sidebar state: use `transition-[padding-left]` to animate content offset

---

## 2026-01-21 16:34 - S26: Landing page features and social proof

**What was implemented:**
- Added 3 feature cards below hero in bento-style grid (md:grid-cols-3)
- Feature 1: "24/7 Support" with Clock icon - AI handles messages any time
- Feature 2: "Smart AI" with Brain icon - Understands context and intent
- Feature 3: "Easy Setup" with Zap icon - Connect in minutes
- Each card has: icon in primary/10 background, semibold title, muted description
- Cards have rounded-2xl, border, shadow-sm for depth
- Added social proof text: "Trusted by 500+ LATAM businesses"
- Mobile: cards stack vertically (grid default)
- CTAs remain above fold on mobile (in hero section)

**Files changed:**
- apps/web/src/routes/index.tsx

**Verification:**
- LSP diagnostics: no errors
- bunx tsc --noEmit: passes

---

## 2026-01-21 16:28 - S25: Landing page hero section redesign

**What was implemented:**
- Complete redesign of landing page with new hero section
- Removed ASCII art, added Echo logo with MessageSquare icon
- Hero tagline: "AI-Powered Customer Service for Your WhatsApp Business"
- Subheading explaining value proposition for LATAM businesses
- Warm gradient background using brand colors (terracotta oklch(0.58 0.2 35) to peach oklch(0.92 0.04 55))
- Two CTAs: "Get Started Free" (white primary button) and "Sign In" (outline button)
- Removed API health check display
- Added auth-aware routing:
  - Authenticated users redirected to /dashboard (or /onboarding if no businesses)
  - Unauthenticated users see landing page
- Added gradient fade at bottom of hero for smooth transition

**Files changed:**
- apps/web/src/routes/index.tsx (complete rewrite)

**Verification:**
- LSP diagnostics: no errors
- bunx tsc --noEmit: passes

---

## 2026-01-21 16:22 - S24: Products page empty state

**What was implemented:**
- Created dedicated empty state for when no products exist at all
- Large ShoppingBag icon (h-12 w-12) in rounded container (p-8)
- Heading: "Add your first product" with text-xl font-semibold
- Subtext: "Products you add will be available for customers to order through WhatsApp"
- Prominent "Add Product" CTA button with size="lg"
- Increased vertical padding (py-16) for better visual centering
- Separated empty state logic: no products vs filtered results empty
- Filter results empty state kept simpler with just "No products found" message

**Files changed:**
- apps/web/src/routes/_authenticated/products/index.tsx

**Verification:**
- LSP diagnostics: no errors
- bunx tsc --noEmit: passes

---

## 2026-01-21 16:18 - S23: Products page bulk action bar

**What was implemented:**
- Moved bulk action bar from inline to fixed position at bottom of screen
- Bar appears only when 1+ products selected using CSS transform animation
- Slide up animation: transform transition-transform duration-300 ease-out
- translate-y-full when hidden, translate-y-0 when visible
- Bar has solid background (bg-background) with border-t and shadow-lg
- Bar shows: "{count} selected" text, all bulk actions
- Clear selection button (X icon) on the left side
- Actions: Mark Available, Mark Unavailable, Delete, Move to category dropdown
- Uses z-50 for proper layering above page content

**Files changed:**
- apps/web/src/routes/_authenticated/products/index.tsx

**Verification:**
- LSP diagnostics: no errors
- bunx tsc --noEmit: passes

---

## 2026-01-21 16:10 - S22: Products page card design improvements

**What was implemented:**
- Redesigned ProductCard component with improved visual design:
  - Larger images using aspect-square ratio (fills card width)
  - Product name now uses font-semibold for better prominence
  - Price displayed with font-bold text-primary for clear visibility
  - Added line-clamp-2 to product name to handle long names
- Added availability indicator badge overlay on image:
  - Green badge with dot for available products
  - Gray badge with dot for unavailable products
  - Badge positioned top-right on the image
- Checkbox positioned top-left on image for selection
- Selected cards now have ring-2 ring-primary visual indicator
- Removed opacity dimming for unavailable products (badge provides status)
- Grid gap already gap-6 (was implemented in previous story)
- Category dropdown already in header filters (already existed)

**Files changed:**
- apps/web/src/components/products/ProductCard.tsx (complete redesign)

**Verification:**
- LSP diagnostics: no errors
- bunx tsc --noEmit: passes

---

## 2026-01-21 16:02 - S21: Orders detail page layout redesign

**What was implemented:**
- Redesigned order detail page with 2-column layout:
  - Left column (2/3): Order items table with totals, related conversation link, action buttons
  - Right column (1/3): Customer info, Delivery info, Payment info, Timeline
- Status badge prominent in page header next to order number
- Order items displayed in clean table format with inline totals section
- Added "Related Conversation" link card (navigates to conversation detail)
- Action buttons moved to card at bottom of left column
- Actions appropriate to current order status (Mark Preparing, Mark Ready, Mark Delivered, Cancel)
- Improved max-width to max-w-6xl for better two-column display
- Added MessageSquare icon for conversation link

**Files changed:**
- apps/web/src/routes/_authenticated/orders.$orderId.tsx (complete layout rewrite)

**Verification:**
- LSP diagnostics: no errors
- bunx tsc --noEmit: passes

---

## 2026-01-21 15:50 - S20: Orders page pagination and empty state

**What was implemented:**
- Added client-side pagination with ITEMS_PER_PAGE = 10
- Pagination state managed with currentPage useState
- Reset to page 1 when search or filter changes (useEffect)
- Added pagination controls showing:
  - "Showing X-Y of Z orders" text
  - Previous/Next buttons with ChevronLeft/ChevronRight icons
  - "Page N of M" indicator
- Buttons disabled when at first/last page
- Pagination only shows when totalPages > 1
- Enhanced empty state with larger icon (h-10 w-10) and improved text

**Files changed:**
- apps/web/src/routes/_authenticated/orders.tsx

**Verification:**
- LSP diagnostics: no errors
- bunx tsc --noEmit: passes

---

## 2026-01-21 15:42 - S19: Orders page search and table improvements

**What was implemented:**
- Added search input at top of orders list (filters by order # or customer phone)
- Client-side filtering using useMemo for performance
- Added Customer (contactPhone) column to orders table
- Added row hover effect with hover:bg-muted/50 transition-colors
- Updated date format to smart format using formatSmartDate:
  - "Today" for today's orders
  - "Yesterday" for yesterday's orders
  - "Jan 15" format for older orders
- Added Search icon from lucide-react to search input
- Added Input component from shadcn/ui

**Files changed:**
- apps/web/src/routes/_authenticated/orders.tsx

**Verification:**
- LSP diagnostics: no errors
- bunx tsc --noEmit: passes

---

## 2026-01-21 15:35 - S18: Conversations empty state

**What was implemented:**
- Enhanced empty state for conversations list with larger, more prominent design
- Added MessageCircle icon (h-10 w-10) in a larger rounded container (p-6)
- Updated heading to "No conversations yet" with text-lg font-semibold
- Updated subtext to "Conversations will appear here when customers message you on WhatsApp"
- Added WhatsApp connection status check using getConnectionStatus query
- Added "Connect WhatsApp" CTA button that appears when WhatsApp is not connected
- Button navigates to /settings/whatsapp
- Empty state is centered vertically with flex-1 and py-12 spacing

**Files changed:**
- apps/web/src/routes/_authenticated/conversations.tsx (added whatsappStatus query, enhanced empty state)

**Verification:**
- LSP diagnostics: no errors
- bunx tsc --noEmit: passes

---

## 2026-01-21 15:28 - S17: Conversations message bubbles and actions UI

**What was implemented:**
- Updated MessageBubble component with improved styling:
  - Changed from rounded-lg to rounded-2xl for softer bubble appearance
  - Increased padding from px-3 py-2 to px-4 py-3
  - Added max-w-[80%] to prevent bubbles from being too wide
- Visual distinction between message types:
  - Customer messages: bg-secondary (left-aligned)
  - AI messages: bg-muted with Bot icon indicator (right-aligned)
  - Human agent messages: bg-primary (right-aligned) with User icon indicator
- Added icon indicators (Bot/User from lucide-react) next to sender labels
- Added proper spacing between message groups:
  - Same sender as previous: mt-1 (small gap)
  - Different sender: mt-4 (larger gap for visual separation)
- Replaced date-fns formatDistanceToNow with custom relative time formatter
- Added leading-relaxed for better text readability

**Files changed:**
- apps/web/src/components/conversation/MessageBubble.tsx (rewrote styling)
- apps/web/src/routes/_authenticated/conversations.tsx (message group spacing)
- apps/web/src/routes/_authenticated/conversations.$conversationId.tsx (message group spacing)

**Verification:**
- LSP diagnostics: no errors
- bunx tsc --noEmit: passes

---

## 2026-01-21 15:21 - S16: Conversations page text and styling improvements

**What was implemented:**
- Increased min-height of conversation list items from 72px to 80px (min-h-20) for better touch targets
- Added avatar placeholder with customer initials (first letter of name or first digit of phone number)
- Added color-coded left border (4px) based on status:
  - active -> primary color (border-l-primary)
  - escalated -> yellow warning color (border-l-yellow-500)
  - closed -> muted color (border-l-muted-foreground/50)
- Updated timestamp format to short relative time: "Just now", "2m ago", "1h ago", "Yesterday"
- Made header with filters sticky at top of conversation list
- Changed empty state text from text-xs to text-sm for readability
- Restructured CardContent with p-0 and moved padding to sticky header and scrollable content area

**Files changed:**
- apps/web/src/routes/_authenticated/conversations.tsx

**Verification:**
- LSP diagnostics: no errors
- bunx tsc --noEmit: passes

---

## 2026-01-21 15:05 - S12: Typography and spacing audit across all routes

**What was implemented:**
- Updated select elements in conversations, orders, and products pages from text-xs to text-sm for readability
- Increased input heights from h-8 to h-9 for better touch targets
- Updated message preview text in conversations list from text-xs to text-sm
- Standardized settings pages max-width to max-w-5xl (settings.tsx, settings_.ai.tsx, settings_.whatsapp.tsx)
- Updated dashboard CardContent spacing from space-y-2 to space-y-4
- Increased product grid gap from gap-4 to gap-6 for better visual breathing room

**Files changed:**
- apps/web/src/routes/_authenticated/conversations.tsx (select text-sm, input h-9, message preview text-sm)
- apps/web/src/routes/_authenticated/orders.tsx (select text-sm, h-9)
- apps/web/src/routes/_authenticated/products/index.tsx (selects text-sm h-9, grid gap-6)
- apps/web/src/routes/_authenticated/settings.tsx (max-w-5xl)
- apps/web/src/routes/_authenticated/settings_.ai.tsx (max-w-5xl, px-6)
- apps/web/src/routes/_authenticated/settings_.whatsapp.tsx (max-w-5xl, px-6)
- apps/web/src/routes/_authenticated/dashboard.tsx (space-y-4)

**Learnings for future iterations:**
- Labels (text-xs) are acceptable but body text should be text-sm minimum
- Form inputs benefit from h-9 (36px) for better accessibility
- List pages use max-w-7xl, detail pages use max-w-4xl, settings pages use max-w-5xl

**Verification:**
- LSP diagnostics: no errors
- bunx tsc --noEmit: passes
- Committed as: feat: S12 - Typography and spacing audit across all routes (commit 9305408)

---

## 2026-01-21 14:54 - S08, S09, S10: Replace window.confirm and inline modals with AlertDialog

**What was implemented:**
- S08: Already implemented - orders.$orderId.tsx already had AlertDialog for Cancel Order
- S09: Updated conversations.$conversationId.tsx Hand Back dialog text to match spec:
  - Title: "Hand Back to AI"
  - Description: "Are you sure you want to hand this conversation back to the AI assistant?"
  - Cancel button: "Keep Control"
  - Confirm button: "Hand Back"
- S10: Replaced custom inline modals with AlertDialog in products:
  - products/$productId.tsx: Single product delete dialog
  - products/index.tsx: Bulk delete dialog
  - Both have consistent styling with destructive confirm button

**Files changed:**
- apps/web/src/routes/_authenticated/conversations.$conversationId.tsx (dialog text update)
- apps/web/src/routes/_authenticated/products/$productId.tsx (replaced custom modal)
- apps/web/src/routes/_authenticated/products/index.tsx (replaced custom modal)

**Verification:**
- LSP diagnostics: no errors
- bun run check-types: passes

---

## 2026-01-21 15:15 - S07: Remove duplicated navigation from all page components

**What was implemented:**
- Moved product routes from `/products/` to `/_authenticated/products/`:
  - `index.tsx` - Products list page
  - `$productId.tsx` - Edit product page
  - `new.tsx` - Add product page
  - `categories.tsx` - Category manager page
- Moved settings routes from root to `/_authenticated/`:
  - `settings_.ai.tsx` - AI settings page
  - `settings_.whatsapp.tsx` - WhatsApp integration settings
- Removed duplicated navigation components from all pages:
  - Removed `BusinessSwitcher`, `AppNav`, `UserMenu` imports and usage
  - Removed `Authenticated/Unauthenticated/AuthLoading` wrappers (handled by layout)
  - Removed duplicate auth checking logic in each page
- Updated route paths from `/products/...` to `/_authenticated/products/...`
- Regenerated route tree with TanStack Router CLI

**Files changed:**
- apps/web/src/routes/_authenticated/products/index.tsx (created, simplified from old)
- apps/web/src/routes/_authenticated/products/$productId.tsx (created, simplified)
- apps/web/src/routes/_authenticated/products/new.tsx (created, simplified)
- apps/web/src/routes/_authenticated/products/categories.tsx (created, simplified)
- apps/web/src/routes/_authenticated/settings_.ai.tsx (created, simplified)
- apps/web/src/routes/_authenticated/settings_.whatsapp.tsx (created, simplified)
- Deleted old route files from root level
- apps/web/src/routeTree.gen.ts (regenerated)

**Verification:**
- LSP diagnostics: no errors
- bunx tsc --noEmit: passes
- Committed as: feat: S07 - Remove duplicated navigation from all page components (commit 6519558)

---

## 2026-01-21 15:02 - S06: Create mobile BottomNav component

**Status:** Already implemented in S03 commit

**Verified implementation:**
- `apps/web/src/components/layout/BottomNav.tsx` contains all 5 nav items
- Each item has icon and label below
- Active item uses `text-primary`, inactive uses `text-muted-foreground`
- Touch targets minimum 44px (`min-h-[44px] min-w-[44px]`)
- z-index 50 via `z-50` class
- Hidden on desktop via `lg:hidden`
- Content area accounts for bottom nav with `pb-20 lg:pb-0` in main

**No additional changes needed.**

---

## 2026-01-21 14:58 - S05: Create AppHeader component

**What was implemented:**
- Updated `apps/web/src/components/layout/AppHeader.tsx`
  - Added NotificationBell between Command Palette trigger and UserMenu
  - Added Search icon to Command Palette trigger for visual clarity
  - Changed "Cmd" text to âŒ˜ symbol for cleaner appearance
  - Layout: BusinessSwitcher (left), Search/Cmd+K (center), NotificationBell + UserMenu (right)
  - Sticky header at top of content area with subtle bottom border

**Files changed:**
- apps/web/src/components/layout/AppHeader.tsx (+6 lines)

**Verification:**
- LSP diagnostics: no errors
- bunx tsc --noEmit: passes
- Committed as: feat: S05 - Create AppHeader component (commit ffd1453)

---

## 2026-01-21 14:53 - S04: Create collapsible Sidebar component

**What was implemented:**
- Created `apps/web/src/components/layout/SidebarContext.tsx`
  - React context for shared sidebar collapsed/expanded state
  - localStorage persistence with key "echo:sidebar-collapsed"
  - SidebarProvider wraps authenticated content, useSidebar hook for consuming
- Updated `apps/web/src/components/layout/Sidebar.tsx`
  - Two states: collapsed (64px/w-16) and expanded (240px/w-60)
  - Expand on hover using local isHovered state
  - isExpanded = !isCollapsed || isHovered (collapsed but hovered = visually expanded)
  - Smooth CSS width transition with `transition-[width] duration-200`
  - Logo text and nav labels fade out with `transition-opacity`
  - Collapse toggle button at bottom with ChevronLeft/ChevronRight icons
  - Tooltip (title attr) shows label when collapsed
- Updated `apps/web/src/routes/_authenticated.tsx`
  - Added SidebarProvider wrapping AuthenticatedContent
  - Dynamic content padding: lg:pl-16 (collapsed) or lg:pl-60 (expanded)
  - Smooth padding transition with `transition-[padding-left] duration-200`

**Files changed:**
- apps/web/src/components/layout/SidebarContext.tsx (created, 36 lines)
- apps/web/src/components/layout/Sidebar.tsx (rewritten, 113 lines)
- apps/web/src/routes/_authenticated.tsx (+27 lines)

**Verification:**
- LSP diagnostics: no errors on all changed files
- bunx tsc --noEmit in apps/web: passes
- Committed as: feat: S04 - Create collapsible Sidebar component (commit cd1f4b7)

---

## 2026-01-21 14:45 - S03: Create authenticated layout route structure

**What was implemented:**
- Created `apps/web/src/routes/_authenticated.tsx` as pathless layout route
  - Uses `createFileRoute("/_authenticated")` with beforeLoad auth check
  - Redirects to /login if not authenticated
  - Wraps content with Authenticated/Unauthenticated/AuthLoading from convex/react
  - Handles business loading and redirects to /onboarding if no businesses
  - Shell structure: Sidebar (left), AppHeader (top), Outlet (content), BottomNav (bottom mobile)
- Created `apps/web/src/components/layout/Sidebar.tsx`
  - Desktop navigation (hidden on mobile via `lg:flex`)
  - Fixed positioning with 64px width
  - Echo logo at top, navigation items, version at bottom
  - Active route highlighting with primary color
- Created `apps/web/src/components/layout/AppHeader.tsx`
  - Sticky header with BusinessSwitcher and UserMenu
  - Command palette trigger placeholder (Cmd+K hint)
- Created `apps/web/src/components/layout/BottomNav.tsx`
  - Mobile bottom navigation (hidden on desktop via `lg:hidden`)
  - Touch-friendly 44px minimum targets
  - Fixed at bottom with z-50
- Moved authenticated routes to `_authenticated/` folder:
  - dashboard.tsx, settings.tsx, conversations.tsx, conversations.$conversationId.tsx
  - orders.tsx, orders.$orderId.tsx
- Simplified child routes (auth handled by layout)
- Replaced window.confirm with AlertDialog for order cancellation (S08 partial)

**Files changed:**
- apps/web/src/routes/_authenticated.tsx (created, ~75 lines)
- apps/web/src/components/layout/Sidebar.tsx (created, ~55 lines)
- apps/web/src/components/layout/AppHeader.tsx (created, ~30 lines)
- apps/web/src/components/layout/BottomNav.tsx (created, ~40 lines)
- apps/web/src/routes/_authenticated/dashboard.tsx (moved and simplified)
- apps/web/src/routes/_authenticated/settings.tsx (moved and simplified)
- apps/web/src/routes/_authenticated/conversations.tsx (moved and simplified)
- apps/web/src/routes/_authenticated/conversations.$conversationId.tsx (moved and simplified)
- apps/web/src/routes/_authenticated/orders.tsx (moved and simplified)
- apps/web/src/routes/_authenticated/orders.$orderId.tsx (moved and simplified, AlertDialog added)
- apps/web/src/routeTree.gen.ts (regenerated)

**Verification:**
- bun run check-types: passes
- Route generation: successful
- Committed as: feat: S03 - Create authenticated layout route structure (commit e5016e5)

---

## 2026-01-21 14:27 - S02: Add Google Fonts for typography

**What was implemented:**
- Added Google Fonts link tags to apps/web/src/routes/__root.tsx head() function
  - Preconnect hints for fonts.googleapis.com and fonts.gstatic.com for faster loading
  - Font stylesheet with Plus Jakarta Sans (600, 700), DM Sans (400, 500), JetBrains Mono (400)
  - `display=swap` parameter to prevent FOUT (flash of unstyled text)
- Updated apps/web/src/index.css @theme inline block:
  - `--font-sans`: "DM Sans" for body text (replaces Inter Variable)
  - `--font-heading`: "Plus Jakarta Sans" for headings
  - `--font-mono`: "JetBrains Mono" for monospace/code

**Files changed:**
- apps/web/src/routes/__root.tsx (+15 lines: preconnect + font stylesheet links)
- apps/web/src/index.css (+2 lines: --font-heading, --font-mono; modified --font-sans)

**Verification:**
- LSP diagnostics: no errors
- bun run check-types: passes
- Committed as: feat: S02 - Add Google Fonts for typography (commit f9ea2ee)

---

## 2026-01-20 21:58 - S19: Add offline support with caching

**What was implemented:**
- Created apps/web/src/components/OfflineIndicator.tsx
  - Monitors navigator.onLine state for browser connectivity
  - Monitors Convex client connectionState() for WebSocket status
  - Three states: connected (hidden), disconnected (red banner), reconnecting (yellow banner)
  - Fixed position at bottom center with rounded pill design
  - Uses lucide-react icons: WifiOff for offline, RefreshCw (animated) for reconnecting
- Integrated OfflineIndicator into apps/web/src/routes/__root.tsx
  - Added after Toaster, before TanStackRouterDevtools
  - Appears globally on all pages

**Note:** Convex provides offline caching out of the box - cached conversations remain visible when offline. Optimistic updates queue mutations until reconnection. This story focused on the user-facing indicator.

**Files changed:**
- apps/web/src/components/OfflineIndicator.tsx (created, 76 lines)
- apps/web/src/routes/__root.tsx (+2 lines: import and component)

**Verification:**
- LSP diagnostics: no errors
- bun run check-types: passes

---

## 2026-01-20 22:39 - S18: Add mobile responsive layout

**What was implemented:**
- Single column layout for screens < 1024px (already implemented in S17)
- Full page navigation to detail page on mobile (already implemented)
- Back button on detail page returns to list (already existed)
- Touch-friendly button sizing:
  - MessageInput send button: h-11 w-11 (44px)
  - MessageInput text field: h-11 (44px)
  - Action buttons: min-h-[44px] on mobile, h-8 on desktop (lg:)
- Conversation list items: min-h-[72px] for adequate tap targets
- Flex-wrap on action buttons to handle narrow screens

**Files changed:**
- apps/web/src/components/conversation/MessageInput.tsx (h-11 for input and button)
- apps/web/src/routes/conversations.tsx (min-h-[72px] for list items)
- apps/web/src/routes/conversations_.$conversationId.tsx (min-h-[44px] for action buttons)

**Verification:**
- LSP diagnostics: no errors
- bun run check-types: passes
- Committed as: feat: S18 - Add mobile responsive layout (commit c1cd761)

---

## 2026-01-20 22:35 - S17: Add desktop split-view layout for conversations

**What was implemented:**
- Updated conversations.tsx with split-view layout for desktop (lg: >= 1024px)
- Added validateSearch for URL param type safety
- Left panel: fixed width (400px), scrollable conversation list
- Right panel: conversation detail with messages, action buttons, input
- Desktop: clicking conversation updates URL param without full page nav
- Mobile: clicking navigates to full-screen detail page
- Selected conversation highlighted with bg-muted
- Empty state placeholder when no conversation selected
- ConversationDetail inline component with:
  - Customer header + StatusBadge
  - Escalation banner
  - Related order card
  - Messages with MessageBubble
  - Action buttons (Take Over, Hand Back, Close, Reopen)
  - MessageInput (disabled unless assigned)

**Files changed:**
- apps/web/src/routes/conversations.tsx (+300 lines, restructured)
- apps/web/src/routeTree.gen.ts (updated)

**Verification:**
- LSP diagnostics: no errors
- bun run check-types: passes
- Committed as: feat: S17 - Add desktop split-view layout for conversations (commit 4c7ea10)

---

## 2026-01-20 22:32 - S16: Create notification bell UI component

**What was implemented:**
- Created apps/web/src/components/NotificationBell.tsx
- Bell icon with unread count badge (red, hidden when 0)
- DropdownMenu with notification list (limit 10)
- Type icons: AlertCircle (escalation), ShoppingCart (new_order)
- Message format: "Escalation: Customer needs help" / "New order received"
- Relative time using formatDistanceToNow
- Unread indicator (blue dot and bg highlight)
- Click marks notification as read and navigates to conversation
- "Mark all as read" link in dropdown header
- Empty state with BellOff icon
- Integrated into conversations.tsx and conversations_.$conversationId.tsx headers

**Files changed:**
- apps/web/src/components/NotificationBell.tsx (created, ~130 lines)
- apps/web/src/routes/conversations.tsx (+8 lines)
- apps/web/src/routes/conversations_.$conversationId.tsx (+10 lines)

**Verification:**
- LSP diagnostics: no errors
- bun run check-types: passes
- Committed as: feat: S16 - Create notification bell UI component (commit 34ab1b1)

---

## 2026-01-20 22:29 - S15: Create escalation notification trigger

**What was implemented:**
- Modified notifyEscalation in packages/backend/convex/ai/process.ts
- Now creates notification for business owner when conversation escalates
- Sets status to "escalated" in addition to state (for dashboard filtering)
- Inserts notification with type "escalation", userId = business.ownerId
- Modified takeOver mutation to mark related escalation notifications as read
- Queries notifications by userId and conversationId, patches read: true

**Files changed:**
- packages/backend/convex/ai/process.ts (+10 lines)
- packages/backend/convex/conversations.ts (+8 lines)

**Note:** Browser notification permission/push not implemented in this story (requires client-side integration). Backend creates DB notification which can trigger frontend real-time updates.

**Verification:**
- Convex dev compiles successfully
- LSP diagnostics: no errors
- bun run check-types: passes
- Committed as: feat: S15 - Create escalation notification trigger (commit be944cb)

---

## 2026-01-20 22:26 - S14: Create close conversation UI

**What was implemented:**
- Added Close button (destructive variant) visible for active conversations
- Added Reopen button visible for closed conversations
- Uses conversations.close and conversations.reopen mutations
- Toast notifications on success/error
- Loading state with spinner during processing
- Closed conversations disable message input
- isClosed check prevents sending messages to closed conversations

**Files changed:**
- apps/web/src/routes/conversations_.$conversationId.tsx (+45 lines)

**Verification:**
- LSP diagnostics: no errors
- bun run check-types: passes
- Committed as: feat: S14 - Create close conversation UI (commit b1bafe8)

---

## 2026-01-20 22:23 - S13: Create take over and hand back UI buttons

**What was implemented:**
- Added Take Over button to conversation detail page (visible when not assigned)
- Added Hand Back to AI button (visible when assigned)
- Uses conversations.takeOver and conversations.handBack mutations
- Confirmation dialog for Hand Back ("AI will resume handling...")
- Loading state with Loader2 spinner during processing
- Toast notifications on success/error
- MessageInput integrated at bottom of messages card
- Input disabled when conversation not assigned (shows "Take over to send messages")

**Files changed:**
- apps/web/src/routes/conversations_.$conversationId.tsx (+60 lines)

**Verification:**
- LSP diagnostics: no errors
- bun run check-types: passes
- Committed as: feat: S13 - Create take over and hand back UI buttons (commit 50e14fe)

---

## 2026-01-20 22:20 - S12: Create message input component with send functionality

**What was implemented:**
- Created apps/web/src/components/conversation/MessageInput.tsx
- Props: conversationId, disabled, onSend callback
- State: message (string), isSending (boolean)
- Enter key sends message, Shift+Enter for newline
- useMutation with api.messages.sendAsHuman
- Clear input after successful send
- Disabled state shows "Take over to send messages" placeholder
- Send button disabled when empty or disabled
- Error handling with toast.error from sonner

**Files changed:**
- apps/web/src/components/conversation/MessageInput.tsx (created, ~70 lines)

**Verification:**
- LSP diagnostics: no errors
- bun run check-types: passes
- Committed as: feat: S12 - Create message input component with send functionality (commit 1e96793)

---

## 2026-01-20 22:18 - S11: Create conversation detail page

**What was implemented:**
- Created apps/web/src/routes/conversations_.$conversationId.tsx (flat route pattern)
- Header with back button, BusinessSwitcher, AppNav, UserMenu
- Customer info card with customerId and StatusBadge
- Escalation banner (yellow) when status="escalated" showing escalationReason
- Related order card when order exists (shows order number as link, status)
- Messages container with MessageBubble components
- Sender mapping: "customer" -> customer, "human" -> human, else -> ai
- Auto-scroll to bottom using useRef and useEffect with smooth behavior
- 404 state if conversation not found
- Real-time updates via Convex reactive queries

**Files changed:**
- apps/web/src/routes/conversations_.$conversationId.tsx (created, ~200 lines)
- apps/web/src/routeTree.gen.ts (auto-generated)

**Verification:**
- LSP diagnostics: no errors
- bun run check-types: passes
- Committed as: feat: S11 - Create conversation detail page (commit 1f2702a)

---

## 2026-01-20 22:15 - S10: Create conversation list page with filtering

**What was implemented:**
- Created apps/web/src/routes/conversations.tsx
- Route with auth pattern (Authenticated/Unauthenticated/AuthLoading)
- BusinessSwitcher, AppNav, UserMenu in header
- statusFilter and searchQuery state
- Uses convexQuery with api.conversations.list
- Table with Customer, Last Message, Status (StatusBadge), Time columns
- Escalated conversations have bg-red-50 highlight
- Unread indicator (blue dot) when hasUnread is true
- Filter dropdown (All, Active, Escalated, Closed)
- Search input for customer phone
- Empty state with MessageSquare icon
- Row click navigates to /conversations/[id]
- Real-time updates via Convex reactive queries

**Files changed:**
- apps/web/src/routes/conversations.tsx (created, ~200 lines)
- apps/web/src/routeTree.gen.ts (auto-generated)

**Verification:**
- LSP diagnostics: no errors
- bun run check-types: passes
- Committed as: feat: S10 - Create conversation list page with filtering (commit ce3bd88)

---

## 2026-01-20 22:13 - S09: Create StatusBadge and MessageBubble components

**What was implemented:**
- Created apps/web/src/components/ui/badge.tsx with CVA variants (default, secondary, destructive, outline, success, warning)
- Created apps/web/src/components/conversation/StatusBadge.tsx
  - Props: status, assignedTo
  - AI Handling (green/success) when active and no assignedTo
  - Human Active (blue/default) when assignedTo is set
  - Escalated (red/destructive) when escalated
  - Closed (gray/secondary) when closed
- Created apps/web/src/components/conversation/MessageBubble.tsx
  - Customer messages: left-aligned, bg-muted
  - AI messages: right-aligned, bg-primary, labeled 'AI'
  - Human messages: right-aligned, bg-blue-500, labeled with senderName or 'Agent'
  - Relative timestamp using date-fns formatDistanceToNow
  - Image display support when mediaUrl ends with image extension
- Added date-fns dependency

**Files changed:**
- apps/web/src/components/ui/badge.tsx (created)
- apps/web/src/components/conversation/StatusBadge.tsx (created)
- apps/web/src/components/conversation/MessageBubble.tsx (created)

**Verification:**
- LSP diagnostics: no errors
- bun run check-types: passes
- Committed as: feat: S09 - Create StatusBadge and MessageBubble components (commit d05e7d1)

---

## 2026-01-20 22:11 - S08: Create notification mutations and queries

**What was implemented:**
- Created packages/backend/convex/notifications.ts
- notifications.create internalMutation: creates notification with userId, type, conversationId, read: false
- notifications.list query: returns user's notifications sorted by createdAt desc, default limit 20
- notifications.markRead mutation: sets read to true for specific notification
- notifications.markAllRead mutation: marks all user's unread notifications as read
- notifications.unreadCount query: returns count of unread notifications

**Files changed:**
- packages/backend/convex/notifications.ts (created, 96 lines)

**Verification:**
- Convex dev compiles successfully
- LSP diagnostics: no errors
- bun run check-types: passes
- Committed as: feat: S08 - Create notification mutations and queries (commit f917dc9)

---

## 2026-01-20 22:10 - S07: Create send message as human mutation

**What was implemented:**
- Created packages/backend/convex/messages.ts with sendAsHuman mutation
- Validates conversation exists and is assigned to current user
- Saves message to messages table with sender: "human"
- Uses ctx.scheduler.runAfter to trigger async WhatsApp send
- Created sendToWhatsApp internalMutation for Twilio API integration
- Handles failures gracefully: stores deliveryStatus "failed" with errorMessage
- On success: stores externalId (Twilio SID) and deliveryStatus "sent"

**Files changed:**
- packages/backend/convex/messages.ts (created, 115 lines)

**Learnings:**
- Use ctx.scheduler.runAfter(0, ...) for async operations to avoid blocking mutation
- internalMutation can do external API calls (fetch) in Convex
- Store both success and failure states in message for UI feedback

**Verification:**
- Convex dev compiles successfully
- LSP diagnostics: no errors
- bun run check-types: passes
- Committed as: feat: S07 - Create send message as human mutation (commit 89ad42c)

---

## 2026-01-20 22:08 - S06: Create close and reopen mutations

**What was implemented:**
- Created conversations.close mutation: sets status to 'closed', closedAt to Date.now()
- Created conversations.reopen mutation: sets status to 'active', clears closedAt
- Both mutations validate auth and business ownership
- Both mutations return the updated conversation

**Files changed:**
- packages/backend/convex/conversations.ts (+54 lines)

**Verification:**
- Convex dev compiles successfully
- LSP diagnostics: no errors
- bun run check-types: passes
- Committed as: feat: S06 - Create close and reopen mutations (commit c0869a4)

---

## 2026-01-20 22:07 - S05: Create take over and hand back mutations

**What was implemented:**
- Created conversations.takeOver mutation
- Sets assignedTo to current user's ID, updates lastReadAt
- If status was 'escalated', changes to 'active'
- Validates auth and business ownership
- Created conversations.handBack mutation
- Sets assignedTo to undefined (AI resumes handling)
- Validates conversation is currently assigned to this user
- Both mutations return the updated conversation
- Fixed schema: changed assignedTo and userId from v.id("users") to v.string() since better-auth user table is managed by component

**Files changed:**
- packages/backend/convex/conversations.ts (+55 lines)
- packages/backend/convex/schema.ts (changed v.id("users") to v.string() for assignedTo and notifications.userId)

**Learnings:**
- better-auth creates a "user" table managed by its component, not in our schema
- Use v.string() instead of v.id("user") for user ID references since authUser._id is a string

**Verification:**
- Convex dev compiles successfully
- LSP diagnostics: no errors
- bun run check-types: passes
- Committed as: feat: S05 - Create take over and hand back mutations (commit a87d4f0)

---

## 2026-01-20 22:03 - S04: Create conversation detail and messages queries

**What was implemented:**
- Enhanced conversations.get query with auth validation and order info
- Args: conversationId
- Returns conversation with all fields including escalationReason, assignedTo, status
- Includes related order info if exists (via by_conversation index on orders)
- Validates caller has access to conversation's business
- Created conversations.messages query with pagination
- Args: conversationId, limit (default 100), cursor (optional)
- Returns messages with sender, content, createdAt, mediaUrl, mediaType
- Sort messages by createdAt ascending (oldest first)
- Cursor-based pagination for message history

**Files changed:**
- packages/backend/convex/conversations.ts (+75 lines, modified get query)

**Verification:**
- Convex dev compiles successfully
- LSP diagnostics: no errors
- bun run check-types: passes
- Committed as: feat: S04 - Create conversation detail and messages queries (commit 8fd0a24)

---

## 2026-01-20 22:01 - S03: Create conversation list query with filtering

**What was implemented:**
- Created conversations.list query in packages/backend/convex/conversations.ts
- Args: businessId, status (optional filter), search (optional string), limit (default 50), cursor (optional)
- Returns conversations sorted by lastCustomerMessageAt (most recent first)
- Escalated conversations appear at top regardless of activity time
- Each conversation includes: customerId, lastMessagePreview, lastMessageAt, status, assignedTo, hasUnread
- Support pagination with cursor-based approach
- Filter by status when provided (active, escalated, closed)
- Search by customerId when search term provided
- Include unread indicator (messages after lastReadAt)
- Validates caller has access to business (business.ownerId === authUser._id)

**Files changed:**
- packages/backend/convex/conversations.ts (+95 lines)

**Verification:**
- Convex dev compiles successfully
- LSP diagnostics: no errors
- bun run check-types: passes
- Committed as: feat: S03 - Create conversation list query with filtering (commit 5e9b0a8)

---

## 2026-01-20 21:59 - S02: Create notifications table schema

**What was implemented:**
- Added notifications table to packages/backend/convex/schema.ts
- Fields: userId (v.id("users")), type (union of "escalation" | "new_order"), conversationId (v.id("conversations")), read (v.boolean()), createdAt (v.number())
- Index: by_user on [userId, read, createdAt] for efficient user notification queries

**Files changed:**
- packages/backend/convex/schema.ts (+8 lines)

**Verification:**
- Convex dev confirmed: "Added table indexes: notifications.by_user"
- LSP diagnostics: no errors
- Committed as: feat: S02 - Create notifications table schema (commit 52caa0c)

---

## 2026-01-20 21:55 - S01: Update conversations schema for dashboard features

**What was implemented:**
- Updated conversations table status field from `v.optional(v.string())` to `v.optional(v.union(v.literal("active"), v.literal("escalated"), v.literal("closed")))`
- Added `assignedTo: v.optional(v.id("users"))` - null means AI handling, user ID means human assigned
- Added `lastReadAt: v.optional(v.number())` - for unread message indicator
- Added `closedAt: v.optional(v.number())` - timestamp when conversation was closed
- Added `by_business_status` index on [businessId, status] for efficient filtered queries
- Added `by_status` index on [status] for global status filtering

**Files changed:**
- packages/backend/convex/schema.ts (+23 lines, -2 lines)

**Verification:**
- Convex dev confirmed schema compiles: "Added table indexes: conversations.by_business_status, conversations.by_status"
- LSP diagnostics: no errors on schema.ts
- apps/web tsc --noEmit: passes
- Committed as: feat: S01 - Update conversations schema for dashboard features (commit 3789be5)

---

## 2026-01-20 16:45 - S15: Add order status action handlers to detail page

**What was implemented:**
- Wired up Mark Preparing button to orders.markPreparing mutation
- Wired up Mark Ready button to orders.markReady mutation
- Wired up Mark Delivered button to orders.markDelivered mutation
- Wired up Cancel Order button to orders.cancel mutation with window.confirm dialog
- Toast notifications on success and error using sonner
- Loading state with isProcessing flag and Loader2 spinner
- Buttons disabled while processing
- Query invalidation after successful mutation

**Files changed:**
- apps/web/src/routes/dashboard/orders/$orderId.tsx (added ~90 lines of handlers)

---

## 2026-01-20 16:38 - S14: Create order detail dashboard page

**What was implemented:**
- Created apps/web/src/routes/dashboard/orders/$orderId.tsx with dynamic param
- Protected route with auth pattern
- Fetches order using orders.get query
- Shows 404 state if order not found
- Order header with order # and status badge
- Timestamps section (created, updated, cancelled if applicable)
- Items table with name, quantity, unit price, total price
- Totals section with subtotal, delivery fee, grand total
- Delivery section with type, address, notes
- Customer section with phone and name
- Payment section with method, status, payment link
- Action buttons rendered (not wired up): Mark Preparing, Mark Ready, Mark Delivered, Cancel Order

**Files changed:**
- apps/web/src/routes/dashboard/orders/$orderId.tsx (created)
- apps/web/src/routeTree.gen.ts (updated via router-cli)

---

## 2026-01-20 16:35 - S13: Create orders list dashboard page

**What was implemented:**
- Created apps/web/src/routes/dashboard/orders/index.tsx
- Protected route using Authenticated/Unauthenticated pattern
- Fetches orders using convexQuery with orders.listByBusiness
- Table with columns: Order #, Status, Items Count, Total, Date
- Status badges with color coding per spec
- Status filter dropdown (All + 7 statuses)
- Currency formatting (cents to dollars with Intl.NumberFormat)
- Row click navigates to order detail page
- Empty state with "No orders yet" message

**Files changed:**
- apps/web/src/routes/dashboard/orders/index.tsx (created)
- apps/web/src/routeTree.gen.ts (updated via router-cli)

---

## 2026-01-20 16:28 - S12: Create Stripe webhook handler

**What was implemented:**
- Added POST /webhook/stripe route in http.ts
- Verifies webhook signature using STRIPE_WEBHOOK_SECRET
- Pure JavaScript SHA-256 and HMAC implementation (Convex doesn't have Web Crypto API)
- Handles checkout.session.completed event - updates order status to 'paid' and paymentStatus to 'paid'
- Handles checkout.session.expired event - updates paymentStatus to 'failed'
- Handles payment_intent.payment_failed event - logs failure
- Returns 200 OK for all successfully processed events
- Returns 400 for invalid signatures
- Created updateOrderPaymentStatus internalMutation to update orders by stripeSessionId

**Files changed:**
- packages/backend/convex/http.ts (added ~200 lines)
- packages/backend/convex/orders.ts (added updateOrderPaymentStatus mutation)

**Learnings for future iterations:**
- Convex runtime doesn't have Web Crypto API, need pure JS crypto implementations
- Stripe webhook signature format: t={timestamp},v1={hmac_hex}
- Use by_payment_session index to look up orders by stripeSessionId

---

## 2026-01-20 16:18 - S11: Create payment link generation action

**What was implemented:**
- Created orders.generatePaymentLink action
- Validates order exists, has items, and is in draft status or payment link expired
- Uses Stripe API to create checkout session with order items as line items
- Sets currency from order.currency (lowercased for Stripe)
- Includes orderId in session metadata for webhook reconciliation
- Sets success_url and cancel_url to /dashboard/orders/{orderId}
- Stores stripeSessionId, paymentLinkUrl, paymentLinkExpiresAt on order
- Returns the payment link URL
- Handles Stripe API errors with descriptive messages
- Created internal helpers: getOrderForPayment (internalQuery) and updatePaymentLinkInternal (internalMutation)

**Files changed:**
- packages/backend/convex/orders.ts (added ~145 lines)
- packages/backend/convex/_generated/api.d.ts (auto-generated)

**Learnings for future iterations:**
- Convex actions use ctx.runQuery and ctx.runMutation with internal.module.function for internal functions
- Stripe API uses form-urlencoded body with nested bracket notation for arrays
- Need to run `bunx convex codegen` to regenerate internal API types when adding new internal functions
- OrderItem type helper avoids implicit any in forEach loops

---

## 2026-01-20 16:05 - S10: Add payment environment variables

**What was implemented:**
- Added STRIPE_SECRET_KEY, STRIPE_WEBHOOK_SECRET, STRIPE_PUBLISHABLE_KEY to packages/env/src/server.ts
- All Stripe env vars are optional (z.string().optional())
- Created packages/backend/.env.local.example with placeholder values and comment

**Files changed:**
- packages/env/src/server.ts (added 3 lines)
- packages/backend/.env.local.example (created)

---

## 2026-01-20 16:02 - S09: Create order queries

**What was implemented:**
- Created orders.get: returns single order by ID
- Created orders.getByConversation: returns most recent order for conversation
- Created orders.getByOrderNumber: returns order by human-readable number
- Created orders.listByBusiness: lists orders with optional status filter and pagination
- All queries validate caller has access to business via authComponent
- Pagination uses cursor-based approach with take(limit + 1) pattern

**Files changed:**
- packages/backend/convex/orders.ts (added 122 lines, now imports query and authComponent)

---

## 2026-01-20 15:58 - S08: Create order status update mutations

**What was implemented:**
- Created orders.markPreparing: transitions confirmed/paid -> preparing
- Created orders.markReady: transitions preparing -> ready
- Created orders.markDelivered: transitions ready -> delivered
- All mutations validate current status allows transition
- All mutations return updated order

**Files changed:**
- packages/backend/convex/orders.ts (added 66 lines)

---

## 2026-01-20 15:56 - S07: Create order cancel mutation

**What was implemented:**
- Created orders.cancel mutation
- Args: orderId, reason (optional)
- Only allows cancellation if status is 'draft' or 'confirmed'
- Throws error for paid/preparing/ready/delivered orders
- Sets cancelledAt and stores cancellationReason

**Files changed:**
- packages/backend/convex/orders.ts (added 27 lines)

---

## 2026-01-20 15:54 - S06: Create order payment method mutation

**What was implemented:**
- Created orders.setPaymentMethod mutation
- Args: orderId, paymentMethod (card|cash)
- If 'cash' selected, updates status to 'confirmed' (ready for fulfillment)
- If 'card' selected, keeps status as 'draft' (awaiting payment link)

**Files changed:**
- packages/backend/convex/orders.ts (added 24 lines)

---

## 2026-01-20 15:52 - S05: Create order delivery mutation

**What was implemented:**
- Created orders.setDeliveryInfo mutation
- Args: orderId, deliveryType, deliveryAddress (optional), deliveryNotes (optional), contactPhone (optional)
- Validates delivery address required when deliveryType is 'delivery'
- Clears deliveryAddress when deliveryType is 'pickup'
- Updates contactPhone if provided

**Files changed:**
- packages/backend/convex/orders.ts (added 38 lines)

---

## 2026-01-20 15:48 - S04: Create order item mutations

**What was implemented:**
- Created orders.addItem mutation: adds item or increments quantity if exists
- Created orders.removeItem mutation: removes item from order
- Created orders.updateItemQuantity mutation: updates quantity, removes if <= 0
- All mutations validate order exists and is in 'draft' status
- All mutations validate product exists and belongs to business
- All mutations recalculate subtotal and total (including deliveryFee)
- All mutations update updatedAt timestamp

**Files changed:**
- packages/backend/convex/orders.ts (expanded from 79 to 205 lines)

**Learnings for future iterations:**
- Use `typeof order.items` for items array type to match existing schema
- Total calculation includes deliveryFee: `subtotal + (order.deliveryFee ?? 0)`
- Default quantity parameter: `args.quantity ?? 1`

---

## 2026-01-20 15:42 - S03: Create orders.create mutation

**What was implemented:**
- Created packages/backend/convex/orders.ts with orders.create mutation
- Validates business exists
- Validates all products exist, belong to the business, and are not deleted
- Looks up product prices and names server-side
- Calculates unitPrice and totalPrice for each item
- Calculates subtotal as sum of all totalPrice values
- Generates unique orderNumber using the lib/orderNumber utility
- Creates order with status 'draft', paymentStatus 'pending', defaults to 'pickup' and 'cash'
- Gets currency from first product, falls back to 'USD'

**Files changed:**
- packages/backend/convex/orders.ts (created, 75 lines)

**Learnings for future iterations:**
- Use explicit type annotation for items array to satisfy Convex insert types
- Default values for enums (deliveryType, paymentMethod) set at creation time
- Currency derived from first product's currency field

---

## 2026-01-20 15:38 - S02: Create order number generation utility

**What was implemented:**
- Created packages/backend/convex/lib/orderNumber.ts with generateOrderNumber function
- Function accepts db context and businessId
- Derives 3-letter prefix from business name (first 3 letters uppercase, falls back to "BIZ" if short)
- Queries existing orders for the business to find max sequential number
- Generates format: ORD-{prefix}-{number} (e.g., ORD-BUR-001234)
- 6-digit zero-padded sequential number

**Files changed:**
- packages/backend/convex/lib/orderNumber.ts (created, 50 lines)

**Learnings for future iterations:**
- Use `GenericDatabaseReader<DataModel>` from convex/server for typed db access in utility functions
- Import types from `../_generated/dataModel` for Id<"tableName"> types
- Query-then-process pattern for sequential number generation is safe for order numbers (low collision risk)

---

## 2026-01-19 21:25 - S03: Receive customer message via webhook

**What was implemented:**
- Created HTTP GET endpoint at /webhook/whatsapp for Meta/Twilio webhook verification
  - Verifies hub.verify_token against WEBHOOK_VERIFY_TOKEN environment variable
  - Returns challenge for successful verification
- Created HTTP POST endpoint at /webhook/whatsapp for receiving messages
  - Handles both JSON and form-urlencoded payloads (Twilio uses form data)
  - Extracts recipient phone number from payload
  - Looks up business by phone number using by_phone index
  - Uses TwilioWhatsAppProvider.parseWebhook() to parse message
  - Calls processIncomingMessage internal mutation
  - Returns 200 OK immediately for fast webhook response
- Created whatsapp.processIncomingMessage internal mutation in webhook.ts
  - Creates channelId format: whatsapp:{customerPhone}:{businessId}
  - Creates new conversation or updates existing one via by_channel index
  - Updates lastCustomerMessageAt on existing conversations
  - Stores message in messages table with sender: "customer"
  - Handles message types: text, image, voice, document via mediaType
- Created whatsapp.getBusinessByPhoneNumber internal mutation
  - Looks up WhatsApp connection by phone number
  - Returns business credentials and provider info
- Fixed twilio.ts to remove Node.js-specific crypto import (not needed for current verification)
- Replaced Buffer.from() with btoa() for base64 encoding (Web API compatible)

**Files changed:**
- packages/backend/convex/http.ts (expanded from 10 to 107 lines)
- packages/backend/convex/integrations/whatsapp/webhook.ts (created, 111 lines)
- packages/backend/convex/integrations/whatsapp/twilio.ts (removed crypto import, replaced Buffer with btoa)
- packages/backend/convex/_generated/api.d.ts (auto-generated)

**Learnings for future iterations:**
- Convex HTTP actions use httpAction from _generated/server, not convex/server
- Nested module paths use dots in API: internal.integrations.whatsapp.webhook.functionName
- Convex runtime doesn't support Node.js crypto module - use Web Crypto API or format validation only
- Form-urlencoded webhooks need URLSearchParams parsing: new URLSearchParams(await request.text())
- Return 200 OK quickly for webhooks to avoid timeouts - process async if needed
- channelId pattern enables finding conversations across channels

**Verification:**
- Convex codegen passes successfully
- LSP diagnostics show no errors on new/modified backend files
- Pre-existing errors in dashboard.tsx and settings.tsx are unrelated to S03
- Committed as: feat: S03 - Receive customer message via webhook (commit 0c05eab)
- Updated PRD: S03 passes: true

---


**What was implemented:**
- Added `businesses.list` query that returns all businesses owned by authenticated user
- Query uses the `by_owner` index for efficient lookups by ownerId
- Returns empty array for unauthenticated users
- Added `businesses.get` query that returns a single business by businessId
- Validates ownership before returning business data
- Returns null for unauthenticated users or unauthorized access attempts
- Imported query function from Convex server module

**Files changed:**
- packages/backend/convex/businesses.ts (added 43 lines, lines 134-175)
- packages/backend/convex/_generated/api.d.ts (auto-generated to include businesses module)
- AGENTS.md (added note about preferring existing shadcn/ui components)

**Learnings for future iterations:**
- When using `authUser.userId` after null check, store it in a const to avoid TypeScript type narrowing issues
- Pattern: `const userId = authUser.userId;` then use `userId` in queries
- Queries should return null or empty arrays for unauthorized/unauthenticated users rather than throwing errors
- This allows graceful handling on the client side
- Auto-generated Convex API files should be committed as they reflect the actual module exports

**Verification:**
- `bun run check-types` passed successfully
- LSP diagnostics show no errors
- Committed as: feat: S03 - Create business queries (commit 703fefb)

---


**What was implemented:**
- Created complete businesses table schema in packages/backend/convex/schema.ts
- Defined all required fields: name, slug, type (union of 4 business types)
- Defined all optional fields: description, logoUrl, address, aiGreeting
- Added localization fields: defaultLanguage, timezone (defaults will be set in mutations)
- Implemented nested businessHours object with open, close, days fields
- Added ownerId for user ownership tracking (using v.string() per auth pattern)
- Added createdAt and updatedAt timestamp fields
- Created two indexes: by_owner (for listing user's businesses) and by_slug (for unique slug lookup)

**Files changed:**
- packages/backend/convex/schema.ts (added 42 lines)

**Learnings for future iterations:**
- Auth pattern discovered: `authComponent.safeGetAuthUser(ctx)` returns authUser object with `userId` as string, so ownerId fields should use `v.string()` not `v.id("users")`
- Convex schemas don't support default values - these must be handled in mutation layer
- Convex doesn't enforce uniqueness at schema level - must validate in mutations using indexes
- Type-safe enums created using `v.union(v.literal("val1"), v.literal("val2"))`
- Schema files benefit from grouping comments for organization of large table definitions
- Business hours stored as object with time strings (HH:mm format) and days array (0-6)

**Verification:**
- `bun run check-types` passed successfully
- Committed as: feat: S01 - Create businesses table schema (commit 5c50b91)

---
## 2026-01-16 13:40 - S02: Create business mutations

**What was implemented:**
- Created businesses.create mutation with name, type, and optional fields (description, logoUrl, address)
- Implemented generateSlug() helper function to convert business name to kebab-case slug
- Added slug uniqueness validation using by_slug index with automatic suffix incrementing
- Set ownerId from authUser.userId with proper null checking
- Applied default values: defaultLanguage='en', timezone='UTC'
- Created businesses.update mutation accepting businessId and all updatable fields
- Implemented ownership validation ensuring only business owner can update
- Auto-updates updatedAt timestamp on all mutations

**Files changed:**
- packages/backend/convex/businesses.ts (created, 132 lines)

**Learnings for future iterations:**
- Must check both `!authUser` AND `!authUser.userId` since userId can be null/undefined
- Slug generation regex patterns require inline comments explaining the pattern (Priority 3 necessary comments)
- For update mutations, use `Record<string, unknown>` instead of `Partial<typeof business>` to avoid type issues with optional fields
- Uniqueness check pattern: query with index, loop until no match found, append suffix if needed
- Convex mutations throw errors which propagate to client - no need for custom error objects

---

## 2026-01-16 - S04 & S05: Create sign up and login pages

**What was implemented:**
- Created /signup route (apps/web/src/routes/signup.tsx) using TanStack Router file-based routing
- Created /login route (apps/web/src/routes/login.tsx) using TanStack Router file-based routing
- Added Google OAuth button to SignUpForm component with Better-Auth social signin
- Added Google OAuth button to SignInForm component with Better-Auth social signin
- Integrated Google logo SVG inline for OAuth buttons
- Added visual separator ("Or continue with") between email/password and OAuth options
- Updated form redirect logic (currently redirects to /dashboard; will update to /onboarding in S06)
- Generated route types using @tanstack/router-cli
- Both pages properly link to each other (signup -> login and login -> signup)

**Files changed:**
- apps/web/src/routes/signup.tsx (created, 17 lines)
- apps/web/src/routes/login.tsx (created, 17 lines)
- apps/web/src/components/sign-up-form.tsx (added Google OAuth, 50 lines added)
- apps/web/src/components/sign-in-form.tsx (added Google OAuth, 50 lines added)
- apps/web/src/routeTree.gen.ts (auto-generated route types)

**Learnings for future iterations:**
- TanStack Router requires generating route types via CLI: `bunx @tanstack/router-cli generate`
- Route types are auto-generated in `src/routeTree.gen.ts` and must be committed
- Better-Auth social signin uses `authClient.signIn.social({ provider, callbackURL })`
- Google OAuth can be triggered before route exists; callbackURL just needs to be a valid path
- For S04/S05, temporarily redirected signup to /dashboard; will update to /onboarding in S06 when that route exists
- Login redirects to /dashboard; dashboard will handle redirecting to /onboarding if user has no businesses (cleaner separation of concerns)
- Type-safe navigation with TanStack Router only allows navigating to defined routes
- Google logo inline SVG is better than importing external assets for simple icons

**Verification:**
- `bunx tsc --noEmit` in apps/web passed successfully (0 errors)
- Route generation completed without errors
- Committed as: feat: S04 - Create sign up page (commit 93c38ec)
- Updated PRD: S04 passes: true, S05 passes: true

---

## 2026-01-16 16:30 - S06: Create onboarding page for business creation

**What was implemented:**
- Created /onboarding route (apps/web/src/routes/onboarding.tsx) with protected authentication
- Used Convex's Authenticated/Unauthenticated/AuthLoading components for auth flow
- Implemented business creation form with required fields (name, type) and optional fields (description, logoUrl, address)
- Added real-time slug preview that updates as user types business name using generateSlug helper
- Native HTML select element for business type dropdown (restaurant, pharmacy, retail, other)
- Native textarea for description field
- Progress indicator showing "Step 1: Create Your Business"
- Card-based layout using shadcn/ui Card components for clean presentation
- Mobile-responsive layout with container max-width and proper spacing
- Form validation using TanStack Form without separate Zod validator (simplified approach)
- Integrated businesses.create mutation from Convex backend
- Success toast notification and redirect to /dashboard on successful submission
- Generated route types using @tanstack/router-cli

**Files changed:**
- apps/web/src/routes/onboarding.tsx (created, 280 lines)
- apps/web/src/routeTree.gen.ts (auto-generated route types update)

**Learnings for future iterations:**
- TanStack Form validation can work without explicit Zod validators by doing validation in onSubmit
- For optional fields with conditional validation (like URL), use safeParse in onSubmit handler
- Convex's Authenticated/Unauthenticated components provide cleaner auth flow than beforeLoad redirects
- Native HTML select/textarea elements work well and don't require shadcn components for simple use cases
- generateSlug helper provides live preview without needing editable slug field
- Progress indicators can be simple div-based layouts without complex step components
- Card components from shadcn/ui provide excellent structure for multi-section forms
- Route type generation must run after creating new route files
- Comments describing form sections (like "Business Name") are unnecessary - the Label components make intent clear

**Verification:**
- `bun run check-types` passed successfully (0 errors)
- LSP diagnostics show no errors after route generation
- Committed as: feat: S06 - Create onboarding page for business creation (commit f2ac337)
- Updated PRD: S06 passes: true

---

## 2026-01-16 17:00 - S07: Create dashboard page

**What was implemented:**
- Completely rebuilt /dashboard route with proper authentication and business checking
- Used Authenticated/Unauthenticated/AuthLoading pattern from Convex
- Implemented automatic redirect to /onboarding if user has no businesses using useEffect
- Dashboard displays active business (first business from businesses.list query)
- Shows business name as large heading with capitalized business type as subheading
- Created two-column card layout using shadcn/ui Card components
- Business Information card displays type, description (if available), and address (if available)
- Quick Actions card contains button linking to /settings
- Integrated UserMenu component in header area
- Clean, minimal layout with proper spacing and responsive grid
- Created placeholder /settings route to enable TypeScript type-safe navigation
- Generated route types for new settings route

**Files changed:**
- apps/web/src/routes/dashboard.tsx (rebuilt, 119 lines)
- apps/web/src/routes/settings.tsx (created placeholder, 31 lines)
- apps/web/src/routeTree.gen.ts (auto-generated route types update)

**Learnings for future iterations:**
- useEffect with navigate is ideal for conditional redirects based on query results
- Check if query is undefined before checking length to avoid unnecessary renders
- Displaying the first business as "active" is simple MVP approach; business switcher (S09) will enhance this
- Card grid with md:grid-cols-2 provides clean responsive layout without custom breakpoints
- Capitalizing enum values for display: `type.charAt(0).toUpperCase() + type.slice(1)`
- Creating placeholder routes helps avoid TypeScript navigation errors when building incrementally
- Separating DashboardContent into its own component keeps auth logic clean

**Verification:**
- `bun run check-types` passed successfully (0 errors)
- LSP diagnostics show no errors
- Committed as: feat: S07 - Create dashboard page (commit bbdcb8b)
- Updated PRD: S07 passes: true

---

## 2026-01-16 17:45 - S08: Create business settings page

**What was implemented:**
- Completely rebuilt /settings route from placeholder into fully functional settings page
- Used same auth pattern as dashboard (Authenticated/Unauthenticated/AuthLoading)
- Implemented redirect to /onboarding if user has no businesses
- Created comprehensive settings form with four Card sections:
  1. Basic Information: name, description, logoUrl
  2. Localization: defaultLanguage dropdown (en, es, pt), timezone selector
  3. Business Hours: open/close time inputs, days of week checkboxes
  4. AI Configuration: aiGreeting textarea
- Language dropdown with full language names (English, Spanish (EspaÃ±ol), Portuguese (PortuguÃªs))
- Timezone selector with 15 common IANA timezones (UTC, Americas, Europe, Asia, Australia)
- Business hours uses native time inputs (HH:mm format) and checkbox grid for days
- Days of week stored as numbers (0=Sunday through 6=Saturday) matching schema
- Smart form submission only sends changed fields to businesses.update mutation
- Success toast notification on save
- Properly typed updateBusiness function with correct return type (Promise<string>)
- Mobile-responsive grid layouts (2 columns for time inputs, 2-4 columns for day checkboxes)

**Files changed:**
- apps/web/src/routes/settings.tsx (expanded from 32 to 420 lines)

**Learnings for future iterations:**
- Convex mutations return the document ID, not void - must type function signatures correctly
- Comparing arrays with JSON.stringify is pragmatic for detecting changes in simple arrays
- Native time inputs work excellently with browser UI, no need for custom time pickers
- Checkbox grids for days of week are more intuitive than multi-select dropdowns
- Smart diffing before mutation reduces unnecessary database writes
- COMMON_TIMEZONES constant provides good UX without overwhelming users
- Card-based sections make complex forms scannable and organized
- Type alias for Business interface improves readability when passing to components

**Verification:**
- `bun run check-types` passed successfully (0 errors)
- LSP diagnostics show no errors
- Committed as: feat: S08 - Create business settings page (commit 166b611)
- Updated PRD: S08 passes: true

---

## 2026-01-16 18:30 - S09: Create business switcher component

**What was implemented:**
- Created business-switcher component (apps/web/src/components/business-switcher.tsx)
- Used shadcn/ui DropdownMenu with Base UI primitives
- Button trigger displays current active business name with ChevronDown icon
- Dropdown lists all user's businesses from businesses.list query
- Each business item shows name (bold) and type (small muted text)
- Active business indicated with Check icon (checkmark) from lucide-react
- Implemented localStorage persistence with key "echo:activeBusinessId"
- Auto-selects first business if no active business is set or stored ID is invalid
- useEffect hook ensures active business is always valid when businesses list changes
- Dropdown includes separator and "Create new business" option with Plus icon
- Clicking "Create new business" navigates to /onboarding
- Integrated into dashboard page header (replaced business name heading)
- Integrated into settings page header (added to flex layout with title)
- Used render prop pattern for DropdownMenuTrigger (Base UI doesn't support asChild)

**Files changed:**
- apps/web/src/components/business-switcher.tsx (created, 90 lines)
- apps/web/src/routes/dashboard.tsx (integrated switcher, removed static business heading)
- apps/web/src/routes/settings.tsx (added switcher to header layout)

**Learnings for future iterations:**
- localStorage access must be guarded with typeof window !== "undefined" for SSR
- useEffect dependency array should include all values used for conditional logic
- Base UI DropdownMenuTrigger uses render prop pattern, not asChild like Radix UI
- Storing business ID in localStorage provides persistence across sessions
- Auto-fallback to first business provides good UX when stored ID becomes invalid
- lucide-react icons (Check, ChevronDown, Plus) integrate seamlessly with components
- Business switcher in header is more scalable than static business name display
- flex-col in dropdown items allows stacking name and metadata

**Patterns added to progress.txt:**
- Use localStorage with SSR-safe initialization: `typeof window !== "undefined"`
- DropdownMenuTrigger render prop: `render={(props) => <Button {...props}>...</Button>}`
- Active item indicator: conditional Check icon based on ID comparison

**Verification:**
- `bun run check-types` passed successfully (0 errors)
- LSP diagnostics show no errors
- Committed as: feat: S09 - Create business switcher component (commit 491aeb6)
- Updated PRD: S09 passes: true

---

## 2026-01-19 16:35 - S01: Create WhatsApp data model

**What was implemented:**
- Created whatsappConnections table in packages/backend/convex/schema.ts
  - Fields: businessId (v.id("businesses")), provider, phoneNumberId, phoneNumber, credentials (nested object with accountSid, authToken, apiKey), verified, createdAt
  - Indexes: by_business [businessId], by_phone [phoneNumber]
- Created conversations table for tracking customer conversations
  - Fields: businessId, customerId, channel, channelId, lastCustomerMessageAt, status (optional), createdAt, updatedAt
  - Indexes: by_business [businessId], by_channel [channelId, businessId]
- Created messages table for individual messages
  - Fields: conversationId, sender, content, externalId (optional), deliveryStatus (optional), mediaUrl (optional), mediaType (optional), createdAt
  - Index: by_conversation [conversationId]

**Files changed:**
- packages/backend/convex/schema.ts (added 41 lines for 3 new tables)

**Learnings for future iterations:**
- WhatsApp BSP credentials stored in nested object for flexibility across providers (Twilio, 360dialog)
- Conversations track channel type (whatsapp, web) and channelId for lookup
- lastCustomerMessageAt enables 24-hour messaging window tracking
- Messages use optional externalId for WhatsApp message ID correlation
- deliveryStatus tracks sent/delivered/read/failed states from webhook updates

**Verification:**
- LSP diagnostics show no TypeScript errors
- Committed as: feat: S01 - Create WhatsApp data model (commit 3760aca)
- Updated PRD: S01 passes: true

---

## 2026-01-19 21:10 - S02: Create BSP abstraction layer

**What was implemented:**
- Created packages/backend/convex/integrations/whatsapp/ directory structure
- Created types.ts (116 lines) with comprehensive WhatsApp BSP abstraction types:
  - WhatsAppProvider interface with sendText, sendImage, sendButtons, sendList, parseWebhook, verifyWebhook methods
  - Button type with id and title fields
  - ListRow type with id, title, description fields
  - ListSection type with title and rows fields
  - MessageResult type with success, messageId, error fields
  - ParsedMessage type with from, content, timestamp, mediaUrl, mediaType, messageType, externalId fields
  - MessageType union: "text" | "image" | "voice" | "document" | "buttons" | "list"
  - WebhookVerification type with valid and challenge fields
  - ProviderCredentials type for multi-provider support
- Created twilio.ts (216 lines) with TwilioWhatsAppProvider class implementing WhatsAppProvider:
  - sendText: Sends plain text via Twilio API
  - sendImage: Sends image with optional caption via MediaUrl
  - sendButtons: Falls back to numbered text options (Twilio requires pre-approved templates for buttons)
  - sendList: Falls back to formatted text sections (same template limitation)
  - parseWebhook: Parses Twilio webhook payload into ParsedMessage
  - verifyWebhook: Validates Twilio X-Twilio-Signature header format
  - computeSignature: Helper for full HMAC-SHA1 signature computation
  - sendTwilioMessage: Private method handling Twilio API HTTP requests with Basic auth

**Files changed:**
- packages/backend/convex/integrations/whatsapp/types.ts (created, 116 lines)
- packages/backend/convex/integrations/whatsapp/twilio.ts (created, 216 lines)

**Learnings for future iterations:**
- Twilio WhatsApp interactive messages (buttons, lists) require pre-approved templates - fallback to text format is practical
- WhatsApp phone numbers must be in E.164 format (e.g., +573001234567)
- Twilio webhooks use X-Twilio-Signature header with HMAC-SHA1 of URL + sorted POST params
- Provider abstraction enables easy switching between Twilio, 360dialog, Meta Cloud API
- MessageType union allows type-safe handling of different WhatsApp message formats
- externalId field in ParsedMessage enables message status tracking via webhooks

**Verification:**
- LSP diagnostics show no TypeScript errors on types.ts and twilio.ts
- Committed as: feat: S02 - Create BSP abstraction layer (commit 3b664ba)
- Updated PRD: S02 passes: true

---

## 2026-01-19 21:37 - S04: Send text response to customer

**What was implemented:**
- Created whatsapp.sendMessage action in packages/backend/convex/integrations/whatsapp/actions.ts
- Action accepts args: conversationId, content, type (text)
- Created loadConversationData internalQuery to load conversation, business, and WhatsApp credentials
- Created storeOutgoingMessage internalMutation to store sent messages
- Integrated TwilioWhatsAppProvider.sendText() for actual message delivery
- Implemented exponential backoff with max 3 retries for rate limit handling (1s, 2s, 4s delays)
- Detects rate limit errors via 429 status code or "rate limit" / "Too Many Requests" strings
- Stores successful messages with sender: "business", externalId from Twilio API, deliveryStatus: "sent"
- Stores failed messages with deliveryStatus: "failed" after all retries exhausted

**Files changed:**
- packages/backend/convex/integrations/whatsapp/actions.ts (created, 152 lines)
- packages/backend/convex/_generated/api.d.ts (auto-generated)

**Learnings for future iterations:**
- Convex actions use ctx.runQuery and ctx.runMutation for database operations
- Internal functions use internal.module.path.functionName syntax
- Rate limit handling requires explicit detection of 429 status or rate limit keywords
- Exponential backoff formula: Math.pow(2, attempt) * 1000 gives 1s, 2s, 4s delays
- Always store failed messages with status to enable retry/debugging later
- sleep() helper implemented with Promise and setTimeout

**Verification:**
- bun run check-types passed successfully
- LSP diagnostics show no errors on actions.ts
- Committed as: feat: S04 - Send text response to customer (commit e2cec92)
- Updated PRD: S04 passes: true

---

## 2026-01-19 22:17 - S05: Send rich messages with buttons and lists

**What was implemented:**
- Extended whatsapp.sendMessage action to support message types: text, buttons, list, image
- Added Convex validators for Button and ListSection types (buttonValidator, listRowValidator, listSectionValidator)
- Updated action args with optional fields: buttons, sections, imageUrl, caption, buttonText
- Implemented validation: buttons array required for buttons type (max 3), sections required for list type, imageUrl required for image type
- Implemented automatic fallback to plain text for all rich message types when API call fails
- Created formatButtonsAsFallback(): converts buttons to numbered list text
- Created formatListAsFallback(): converts sections to formatted text with asterisk-bold titles
- Created formatImageAsFallback(): includes image URL in text message
- Updated storeOutgoingMessage mutation with new fields: messageType, richContent, mediaUrl
- Updated messages table schema with messageType (string) and richContent (JSON-encoded structured data)
- Stores original structured content in richContent as JSON string for reconstruction/analytics
- Tracks usedFallback flag to correctly record messageType as "text" when fallback is used

**Files changed:**
- packages/backend/convex/integrations/whatsapp/actions.ts (expanded from 152 to 279 lines)
- packages/backend/convex/schema.ts (added messageType and richContent fields to messages table)

**Learnings for future iterations:**
- Rich message fallback should be attempted only once per send operation (usedFallback flag)
- Storing structured content as JSON string in richContent enables future analytics/reconstruction
- Convex validators can be composed: listSectionValidator uses listRowValidator via v.array()
- Type casting with `as Button[]` works when Convex validator structure matches TypeScript interface
- WhatsApp button limit (3) should be validated before attempting to send
- Image fallback includes URL in text so customers can still access the image

**Verification:**
- Convex codegen passes successfully (22:16:42)
- LSP diagnostics show no errors on actions.ts and schema.ts
- Pre-existing errors in dashboard.tsx and settings.tsx are unrelated to S05
- Committed as: feat: S05 - Send rich messages with buttons and lists (commit ef52aff)
- Updated PRD: S05 passes: true

---

## 2026-01-19 22:20 - S06: Handle WhatsApp 24-hour messaging window

**What was implemented:**
- Created packages/backend/convex/integrations/whatsapp/window.ts with:
  - isWithin24HourWindow(lastCustomerMessageAt) - checks if within 24h window
  - getWindowExpiresAt(lastCustomerMessageAt) - returns expiration timestamp
  - getWindowRemainingMs(lastCustomerMessageAt) - returns remaining ms in window
- Created packages/backend/convex/integrations/whatsapp/templates.ts with:
  - MessageTemplate and TemplateVariable interfaces
  - RE_ENGAGEMENT_TEMPLATE - re-engagement template with {{1}}=business name, {{2}}=context
  - ORDER_UPDATE_TEMPLATE - order status template with {{1}}=customer, {{2}}=order#, {{3}}=status
  - renderTemplate() - renders template with variable substitution
  - getTemplate() - retrieves template by name
- Updated sendMessage action in actions.ts:
  - Added type: "template" as valid message type
  - Added templateName and templateVariables arguments
  - Check isWithin24HourWindow before sending non-template messages
  - Throws error outside 24h window unless type is "template"
  - Template case renders template with provided variables
- Created packages/backend/convex/conversations.ts with queries:
  - get(conversationId) - returns conversation with windowExpiresAt computed field
  - listByBusiness(businessId) - lists all conversations with windowExpiresAt
  - getWithMessages(conversationId, limit?) - returns conversation with messages and windowExpiresAt
- Verified lastCustomerMessageAt already updated in processIncomingMessage (webhook.ts line 48)

**Files changed:**
- packages/backend/convex/integrations/whatsapp/window.ts (created, 25 lines)
- packages/backend/convex/integrations/whatsapp/templates.ts (created, 61 lines)
- packages/backend/convex/integrations/whatsapp/actions.ts (modified, added template support and 24h check)
- packages/backend/convex/conversations.ts (created, 57 lines)
- packages/backend/convex/_generated/api.d.ts (auto-generated)

**Learnings for future iterations:**
- WhatsApp 24h window uses customer's lastCustomerMessageAt timestamp + 24 hours
- Template variables are 1-indexed per WhatsApp Business API spec: {{1}}, {{2}}, etc.
- getWindowExpiresAt returns null if no customer message yet (window never opened)
- Convex queries can add computed fields by spreading document and adding new properties
- Template rendering should provide default values for optional variables

**Verification:**
- Convex codegen passes successfully
- LSP diagnostics show no errors on all new/modified files
- Pre-existing errors in dashboard.tsx and settings.tsx are unrelated to S06
- Committed as: feat: S06 - Handle WhatsApp 24-hour messaging window (commit aae5f0c)
- Updated PRD: S06 passes: true

---

## 2026-01-19 22:25 - S07: Process webhook status updates

**What was implemented:**
- Extended /webhook/whatsapp POST handler in http.ts to detect status update payloads vs message payloads
- Added TwilioWhatsAppProvider.isStatusUpdate() static method to detect status callbacks (has MessageStatus and MessageSid, no Body)
- Added TwilioWhatsAppProvider.parseStatusUpdate() method to parse status webhooks into StatusUpdate type
- Created StatusUpdate interface and DeliveryStatus type ("sent" | "delivered" | "read" | "failed" | "undelivered") in types.ts
- Added ErrorCode and ErrorMessage fields to TwilioWebhookPayload interface
- Created whatsapp.updateMessageStatus internal mutation in webhook.ts:
  - Looks up message by externalId using new by_external_id index
  - Updates deliveryStatus in database
  - Stores errorCode and errorMessage for failed/undelivered messages
  - Logs failed deliveries with console.error for debugging
- Added by_external_id index to messages table in schema.ts for efficient lookup
- Added errorCode and errorMessage optional fields to messages table for failure tracking
- Refactored http.ts POST handler into handleStatusUpdate() and handleIncomingMessage() helpers for clarity

**Files changed:**
- packages/backend/convex/http.ts (expanded from 111 to 145 lines, refactored into helper functions)
- packages/backend/convex/integrations/whatsapp/twilio.ts (added isStatusUpdate and parseStatusUpdate methods)
- packages/backend/convex/integrations/whatsapp/types.ts (added StatusUpdate interface and DeliveryStatus type)
- packages/backend/convex/integrations/whatsapp/webhook.ts (added updateMessageStatus mutation)
- packages/backend/convex/schema.ts (added by_external_id index, errorCode, errorMessage fields)

**Learnings for future iterations:**
- Twilio status callbacks have MessageStatus and MessageSid fields but no Body field - use this to distinguish from message webhooks
- Status values from Twilio: sent, delivered, read, failed, undelivered
- Failed/undelivered messages include ErrorCode (e.g., 30003) and ErrorMessage fields
- Using a static method for payload type detection (isStatusUpdate) avoids needing credentials for detection
- parseStatusUpdate can use a dummy provider instance since it only parses payload, doesn't send

**Verification:**
- Convex codegen passes successfully
- LSP diagnostics show no errors on all modified files
- Committed as: feat: S07 - Process webhook status updates
- Updated PRD: S07 passes: true

---

## 2026-01-19 22:30 - S08: Create WhatsApp connection settings page

**What was implemented:**
- Created packages/backend/convex/integrations/whatsapp/settings.ts with:
  - getConnectionStatus query - returns connection status, provider, phone, verified flag, lastMessageAt
  - saveCredentials mutation - stores/updates WhatsApp BSP credentials
  - markVerified internalMutation - marks connection as verified after test
  - getConnectionForTest internalQuery - loads connection for action
  - testConnection action - validates Twilio credentials via API call
- Created apps/web/src/routes/settings_.whatsapp.tsx (flat route for /settings/whatsapp):
  - Connection status card with visual indicator (green CheckCircle2 / red XCircle)
  - Setup instructions with numbered steps and links to Twilio docs
  - Webhook URL display with copy-to-clipboard button
  - Form with provider dropdown (Twilio), Account SID, Auth Token, Phone Number fields
  - Test Connection button (disabled until credentials saved)
  - Save Credentials button
  - Toast feedback for save/test operations
  - Business switcher integration
- Updated routeTree.gen.ts with new route

**Files changed:**
- packages/backend/convex/integrations/whatsapp/settings.ts (created, 217 lines)
- apps/web/src/routes/settings_.whatsapp.tsx (created, 375 lines)
- apps/web/src/routeTree.gen.ts (updated)
- packages/backend/convex/_generated/api.d.ts (auto-generated)

**Learnings for future iterations:**
- TanStack Router nested routes require parent to render <Outlet /> - use flat route pattern (settings_.whatsapp.tsx) to avoid this
- Flat route naming: use underscore (settings_.whatsapp.tsx) to create /settings/whatsapp without nesting
- Convex actions can test external APIs (Twilio) and then call mutations to update state
- internalMutation/internalQuery bypass auth for internal use but must be called from actions
- Connection test pattern: fetch Twilio account endpoint to verify credentials before marking verified

**Browser Test Results:**
- Navigate to /settings/whatsapp - PASSED (page renders with correct title)
- Connection status indicator visible - PASSED (shows red X for no connection)
- Form with provider dropdown and fields - PASSED (all 4 fields visible)
- Webhook URL in copyable format - PASSED (text input + copy button)
- Test Connection button present - PASSED (disabled until credentials saved)

**Verification:**
- Convex codegen passes successfully
- LSP diagnostics show no errors on new files
- Browser tests all pass
- Committed as: feat: S08 - Create WhatsApp connection settings page (commit c894d1e)
- Updated PRD: S08 passes: true

---

## 2026-01-20 11:40 - S01: Create AI data model and update conversations schema

**What was implemented:**
- Created aiLogs table in packages/backend/convex/schema.ts with fields:
  - conversationId (v.id("conversations"))
  - messageId (v.id("messages"))
  - intent (v.object with type, optional query, items, action, item, topic fields)
  - prompt, response, model (strings)
  - tokensUsed, latencyMs, createdAt (numbers)
- Added by_conversation index on aiLogs for efficient lookup by conversation
- Updated conversations table with new AI Conversation Engine fields:
  - state: union of 7 states (idle, browsing, ordering, confirming, payment, completed, escalated)
  - detectedLanguage: optional string for customer's language
  - pendingOrder: optional object with items array (productQuery, quantity, optional productId, price) and total
  - escalationReason: optional string for human handoff context

**Files changed:**
- packages/backend/convex/schema.ts (+55 lines)

**Learnings for future iterations:**
- Intent object structure designed to accommodate all intent types from S02 (greeting, product_question, order_start, etc.)
- pendingOrder items include productQuery string for fuzzy matching plus optional productId for resolved matches
- State machine uses union of literals for type-safe conversation state tracking
- All new fields are optional to maintain backward compatibility with existing conversations

**Verification:**
- Convex codegen passed successfully
- LSP diagnostics show no errors on schema.ts
- Committed as: feat: S01 - Create AI data model and update conversations schema (commit 5a00bf3)
- Updated PRD: S01 passes: true

---

## 2026-01-20 11:45 - S02: Create AI provider abstraction and types

**What was implemented:**
- Created packages/backend/convex/ai/types.ts with comprehensive AI provider abstraction
- AIProvider interface with complete(params) method returning CompleteResult
- Message type with role (system|user|assistant) and content (string)
- CompleteParams type with messages, systemPrompt, temperature, maxTokens, responseFormat
- CompleteResult type with content, tokensUsed, model fields
- Intent union type with 8 variants:
  - GreetingIntent, ProductQuestionIntent (with query), OrderStartIntent (with items)
  - OrderModifyIntent (with action, item), BusinessQuestionIntent (with topic)
  - EscalationRequestIntent, SmallTalkIntent, UnknownIntent
- OrderItem type with productQuery and quantity
- OrderAction type: add | remove | change_quantity
- AIResponse type with response, intent, shouldEscalate, detectedLanguage
- SerializedIntent type for database storage compatibility
- serializeIntent() and parseIntent() helper functions for type conversion

**Files changed:**
- packages/backend/convex/ai/types.ts (created, 159 lines)

**Learnings for future iterations:**
- Intent types use discriminated union pattern with BaseIntent interface
- SerializedIntent type mirrors aiLogs.intent schema structure for database compatibility
- Helper functions serializeIntent/parseIntent enable type-safe conversion between runtime types and database format
- Intent examples in comments help classify customer messages during implementation

**Verification:**
- LSP diagnostics show no errors on types.ts
- tsc --noEmit passes in apps/web
- Committed as: feat: S02 - Create AI provider abstraction and types (commit 96c54d8)
- Updated PRD: S02 passes: true

---

## 2026-01-20 11:50 - S03: Implement OpenAI provider

**What was implemented:**
- Created packages/backend/convex/ai/providers/openai.ts with OpenAIProvider class implementing AIProvider interface
- Constructor accepts optional apiKey and model, defaults to process.env.OPENAI_API_KEY and gpt-4o-mini
- Implemented complete() method calling OpenAI chat completions API via fetch
- Handles JSON response format via OpenAI's "json_object" response_format type
- Descriptive error handling with specific messages for 401/429/5xx errors
- Factory function createOpenAIProvider() for convenient instantiation

**Files changed:**
- packages/backend/convex/ai/providers/openai.ts (created, 163 lines)

**Learnings for future iterations:**
- OpenAI uses "json_object" as the response_format type value for JSON outputs
- process.env.OPENAI_API_KEY works in Convex actions (env vars accessible at runtime)
- Using fetch() directly (like TwilioWhatsAppProvider) is cleaner than SDK for simple API calls
- OpenAI error responses have nested structure: { error: { message, type, code } }
- Always guard response.json() in try-catch since it can throw on invalid JSON

**Verification:**
- LSP diagnostics show no errors on openai.ts
- bun run check-types passes
- Committed as: feat: S03 - Implement OpenAI provider (commit 5765286)
- Updated PRD: S03 passes: true

---

## 2026-01-20 11:50 - S04: Create language detection function

**What was implemented:**
- Created packages/backend/convex/ai/language.ts with detectLanguage action
- Action accepts message string and returns language code: "es", "pt", or "en"
- Uses lightweight prompt with gpt-4o-mini for classification
- Truncates input to 200 chars for fast processing
- Temperature set to 0 for deterministic responses
- maxTokens set to 5 to minimize latency
- Handles edge cases: empty messages, detection failures
- Defaults to "en" (English) if detection fails or is ambiguous
- Handles alternate responses like "spanish", "portuguese", "english" in addition to codes

**Files changed:**
- packages/backend/convex/ai/language.ts (created, 58 lines)

**Learnings for future iterations:**
- Convex actions use action() from _generated/server with handler returning Promise
- Low maxTokens (5) and temperature (0) optimize for speed in classification tasks
- Input truncation (200 chars) sufficient for language detection while keeping latency low
- Graceful fallback on errors ensures system remains functional even if AI provider fails

**Verification:**
- LSP diagnostics show no errors on language.ts
- bun run check-types passes
- Committed as: feat: S04 - Create language detection function
- Updated PRD: S04 passes: true

---

## 2026-01-20 11:52 - S05: Implement intent classification function

**What was implemented:**
- Created packages/backend/convex/ai/intent.ts with classifyIntent action
- Action accepts: message (string), conversationHistory (Message[]), productNames (string[])
- Uses structured JSON output (responseFormat: "json") for reliable intent extraction
- Prompt includes available products list for fuzzy matching with misspellings
- Extracts entities per intent type:
  - product_question: query string
  - order_start: items array with productQuery and quantity (default 1)
  - order_modify: action (add/remove/change_quantity) and item
  - business_question: topic (hours/location/delivery/payment)
- Includes last 5 conversation messages for context
- mapToIntent() function converts AI response to typed Intent object
- validateOrderAction() ensures valid action enum values
- Graceful fallback to "unknown" intent on parse errors

**Files changed:**
- packages/backend/convex/ai/intent.ts (created, 143 lines)

**Learnings for future iterations:**
- Convex validators for arrays: v.array(v.object({...})) works for typed arrays
- JSON response format requires explicit examples in prompt for consistent structure
- Limiting conversation history (last 5 messages) balances context vs token cost
- Type mapping functions ensure AI output conforms to TypeScript types
- Default values in mapping (quantity: 1, action: "add") handle missing fields gracefully

**Verification:**
- LSP diagnostics show no errors on intent.ts
- bun run check-types passes
- Committed as: feat: S05 - Implement intent classification function
- Updated PRD: S05 passes: true

---

## 2026-01-20 11:55 - S06: Create system prompt builder

**What was implemented:**
- Created packages/backend/convex/ai/prompts.ts with buildSystemPrompt function
- Accepts BuildSystemPromptParams: business info, products list, conversation state, detected language
- Business section includes: name, type, address, business hours (formatted with day names)
- Products section formats each product: name, price (converted from cents), description
- Filters to only show available products
- formatPrice() helper converts cents to display format with currency symbols (USD, COP, BRL, MXN)
- Conversation state context explains current state to AI
- Language instruction in target language (en/es/pt)
- Configurable AI tone from business.aiTone
- 6 rules for AI behavior: only real products, admit uncertainty, offer human help, be concise
- Suggested greeting included when state is "idle" and aiGreeting is configured
- Exports types: BusinessInfo, Product, BuildSystemPromptParams, ConversationState, LanguageCode

**Files changed:**
- packages/backend/convex/ai/prompts.ts (created, 133 lines)

**Learnings for future iterations:**
- Prices stored in cents (integer) must be divided by 100 for display
- Record<number, string> works well for day-of-week mapping (0-6)
- Separating prompt into sections with ## headers improves AI comprehension
- Language instructions in target language reinforce the desired response language
- Filtering products by availability prevents AI from mentioning unavailable items

**Verification:**
- LSP diagnostics show no errors on prompts.ts
- bun run check-types passes
- Committed as: feat: S06 - Create system prompt builder
- Updated PRD: S06 passes: true

---

## 2026-01-20 11:58 - S07: Implement response generation function

**What was implemented:**
- Created packages/backend/convex/ai/response.ts with generateResponse action
- Accepts: intent, conversationHistory, businessContext, products, language, conversationState
- Uses buildSystemPrompt() to create context-aware system prompt
- buildContextInstruction() adds intent-specific guidance to prompt:
  - greeting: friendly welcome
  - product_question: includes matching products from database
  - order_start: confirms items and looks up prices
  - order_modify: acknowledges change
  - business_question: uses business info
  - escalation_request: acknowledges and offers human
  - small_talk: brief friendly response
  - unknown: asks for clarification
- Temperature 0.7 for natural conversation, maxTokens 500 for responses
- getFallbackResponse() provides localized fallbacks in en/es/pt for all intent types
- Validation helpers for language and conversation state
- Uses last 10 conversation messages for context

**Files changed:**
- packages/backend/convex/ai/response.ts (created, 247 lines)

**Learnings for future iterations:**
- Context instructions appended to system prompt help AI focus on current task
- Fallback responses in all supported languages ensure graceful degradation
- Product matching uses case-insensitive search on name and description
- Type casting needed when Convex validators don't exactly match TypeScript types
- Record<LanguageCode, Record<string, string>> provides clean fallback lookup structure

**Verification:**
- LSP diagnostics show no errors on response.ts
- bun run check-types passes
- Committed as: feat: S07 - Implement response generation function
- Updated PRD: S07 passes: true

---

## 2026-01-20 12:02 - S08: Implement escalation detection function

**What was implemented:**
- Created packages/backend/convex/ai/escalation.ts with detectEscalation function
- Accepts: message (string), conversationHistory (Message[]), failureCount (number)
- Returns EscalationResult: { shouldEscalate: boolean, reason: string }
- Explicit escalation phrases in en/es/pt: "talk to person", "human help", "hablar con alguien", etc.
- Urgent keywords: "urgent", "urgente", "emergency", "asap"
- Frustration keywords in en/es/pt: "angry", "frustrated", "furioso", "irritado", etc.
- Failure threshold: 3 consecutive AI failures triggers escalation
- calculateFrustrationScore() analyzes:
  - Current message frustration keywords (+1 each)
  - Recent conversation history keywords (+0.5 each)
  - Multiple exclamation marks (+0.5)
  - All caps messages (+1)
- Score >= 2 triggers frustration escalation
- Reasons included: explicit request, urgent matter, frustrated customer, AI failures

**Files changed:**
- packages/backend/convex/ai/escalation.ts (created, 133 lines)

**Learnings for future iterations:**
- Pure function (no Convex action/mutation) for stateless escalation detection
- Multilingual keyword lists support LATAM market (Spanish, Portuguese)
- Frustration scoring combines immediate message + conversation history
- All-caps detection needs length check to avoid false positives on short messages
- Exclamation count >= 3 indicates urgency/frustration

**Verification:**
- LSP diagnostics show no errors on escalation.ts
- bun run check-types passes
- Committed as: feat: S08 - Implement escalation detection function
- Updated PRD: S08 passes: true

---

## 2026-01-20 12:05 - S09: Create main processMessage orchestrator

**What was implemented:**
- Created packages/backend/convex/ai/process.ts with processMessage action
- processMessage orchestrates the full AI conversation flow:
  1. loadContext internalQuery: loads conversation, business, products, messages
  2. detectLanguage: called on first message or when language not set
  3. classifyIntent: classifies customer intent
  4. detectEscalation: checks if human handoff needed
  5. generateResponse: generates AI response based on context
  6. State update: determines new conversation state based on intent
  7. Logging: stores response message and logs to aiLogs table
- updateConversation internalMutation: updates language and state
- logAIInteraction internalMutation: logs AI interaction metrics
- storeMessage internalMutation: stores AI response message
- determineNewState(): maps intents to state transitions (order_start->ordering, product_question->browsing)
- Returns ProcessMessageResult matching AIResponse type
- Uses api.ai.* for public actions (language, intent, response)
- Uses internal.ai.process.* for internal queries/mutations

**Files changed:**
- packages/backend/convex/ai/process.ts (created, 260 lines)
- packages/backend/convex/_generated/api.d.ts (auto-generated)

**Learnings for future iterations:**
- Public actions called with api.module.function, internal functions with internal.module.function
- Convex codegen must run to update _generated/api.d.ts when adding new modules
- Actions can call other actions via ctx.runAction(api.module.action, args)
- InternalQuery/Mutation used for database operations within actions
- satisfies operator validates return type matches interface
- Type casting needed for conversation state from optional to union type

**Verification:**
- Convex codegen passes successfully
- LSP diagnostics show no errors on process.ts
- bun run check-types passes
- Committed as: feat: S09 - Create main processMessage orchestrator
- Updated PRD: S09 passes: true

---

## 2026-01-20 12:08 - S10: Handle order intent state transitions

**What was implemented:**
- Extended updateConversation to accept pendingOrder and escalationReason
- Added pendingOrderItemValidator and pendingOrderValidator for type-safe order handling
- handleOrderIntent() processes order_start and order_modify intents:
  - order_start: creates new pendingOrder with matched products
  - order_modify add: adds item to order or increments quantity if exists
  - order_modify remove: removes item from order with graceful message if not found
  - order_modify change_quantity: placeholder for quantity changes
- findMatchingProduct() matches product queries to catalog:
  - Exact name match (case-insensitive)
  - Partial name match (product name contains query)
  - Reverse partial match (query contains product name)
- calculateOrderTotal() computes order total from matched prices
- determineNewState() updated: order_modify transitions idle->ordering
- Products matched to orders include productId and price for totals

**Files changed:**
- packages/backend/convex/ai/process.ts (expanded from 271 to 395 lines)

**Learnings for future iterations:**
- PendingOrder items need productId to track resolved product matches
- Three-tier product matching (exact, partial, reverse) handles variations
- Order total stored in cents for consistency with product prices
- Return message from handleOrderIntent for graceful "item not in order" responses
- State transitions should handle order_modify from idle state gracefully

**Verification:**
- Convex codegen passes successfully
- LSP diagnostics show no errors
- bun run check-types passes
- Committed as: feat: S10 - Handle order intent state transitions
- Updated PRD: S10 passes: true

---

## 2026-01-20 12:10 - S11: Handle escalation and conversation handoff

**What was implemented:**
- Added notifyEscalation internal mutation to process.ts:
  - Updates conversation state to "escalated"
  - Stores escalationReason in conversation
  - Logs escalation event with business ID, customer ID, reason
- Updated processMessage to check for escalated state at start:
  - Returns localized message if conversation already escalated
  - Prevents AI from generating new responses for escalated conversations
- Updated processMessage escalation flow:
  - When shouldEscalate is true, calls notifyEscalation
  - Sets newState to "escalated"
  - Escalation reason comes from detectEscalation or defaults to "Customer requested human assistance"
- getEscalatedConversationResponse() provides localized responses in en/es/pt
  - Informs customer that conversation is escalated to human
  - Assures them a team member will respond shortly

**Files changed:**
- packages/backend/convex/ai/process.ts (added ~50 lines)

**Learnings for future iterations:**
- Early return pattern for state-based guards keeps processMessage clean
- console.log in Convex functions shows in deployment logs for debugging
- Escalation notification currently logs - can be extended to send push notifications
- Language-specific responses ensure good UX for LATAM market

**Verification:**
- Convex codegen passes successfully
- LSP diagnostics show no errors
- bun run check-types passes
- Committed as: feat: S11 - Handle escalation and conversation handoff
- Updated PRD: S11 passes: true

---

## 2026-01-20 12:12 - S12: Create AI settings page

**What was implemented:**
- Extended businesses schema with aiTone and aiEscalationKeywords fields
- Created packages/backend/convex/ai/settings.ts with:
  - getSettings query: returns AI config (aiTone, aiGreeting, aiEscalationKeywords)
  - updateSettings mutation: updates AI configuration for business
  - Both validate ownership via authComponent
- Created apps/web/src/routes/settings_.ai.tsx page:
  - Uses flat route pattern for /settings/ai
  - Authenticated/Unauthenticated/AuthLoading pattern
  - BusinessSwitcher integration
  - TanStack Form for form management
- Form fields:
  - AI Tone/Personality: text input for custom tone description
  - Custom Greeting Message: textarea for greeting message
  - Escalation Keywords: comma-separated input
- Created apps/web/src/components/ui/textarea.tsx component
- Save button calls updateSettings with toast feedback
- Settings loaded on mount via useQuery and populated to form

**Files changed:**
- packages/backend/convex/schema.ts (+2 lines for new fields)
- packages/backend/convex/ai/settings.ts (created, 74 lines)
- apps/web/src/routes/settings_.ai.tsx (created, 202 lines)
- apps/web/src/components/ui/textarea.tsx (created, 17 lines)
- apps/web/src/routeTree.gen.ts (auto-generated)

**Learnings for future iterations:**
- Flat route pattern (settings_.ai.tsx) creates /settings/ai without requiring Outlet in parent
- Escalation keywords stored as string array, converted to/from comma-separated for UI
- useEffect with form.setFieldValue populates form when settings load
- Textarea component follows same styling pattern as Input for consistency

**Browser tests (manual verification required):**
- Navigate to /settings/ai: page should render with title
- Form renders with tone, greeting, escalation fields
- Save button visible and clickable

**Verification:**
- Convex codegen passes successfully
- LSP diagnostics show no errors
- bun run check-types passes
- Committed as: feat: S12 - Create AI settings page
- Updated PRD: S12 passes: true

---

## 2026-01-20 12:15 - S13: Create AI usage stats component

**What was implemented:**
- Added getUsageStats query to packages/backend/convex/ai/settings.ts:
  - Aggregates from aiLogs table for the business's conversations
  - Filters to last 30 days
  - Returns: totalTokens, totalConversations, avgLatencyMs, estimatedCostUsd
  - Cost calculation: $0.00015 per 1K tokens (gpt-4o-mini rate)
- Created apps/web/src/components/ai/usage-stats.tsx:
  - Displays stats in 4-column grid
  - Uses lucide-react icons (Zap, MessageSquare, Activity, DollarSign)
  - StatCard subcomponent for consistent stat display
  - Loading and error states handled
- Integrated UsageStats into /settings/ai page below Save button

**Files changed:**
- packages/backend/convex/ai/settings.ts (+52 lines)
- apps/web/src/components/ai/usage-stats.tsx (created, 82 lines)
- apps/web/src/routes/settings_.ai.tsx (+3 lines for import and usage)

**Learnings for future iterations:**
- aiLogs doesn't have direct business index, so query via conversations first
- Set for unique conversation counting avoids duplicates
- Cost estimation uses gpt-4o-mini pricing ($0.15 per 1M tokens)
- Grid layout (2 cols mobile, 4 cols desktop) works well for stats cards

**Browser tests (manual verification required):**
- Navigate to /settings/ai: usage stats section visible
- Stats show token count, conversation count, latency, and cost

**Verification:**
- Convex codegen passes successfully
- LSP diagnostics show no errors
- bun run check-types passes
- Committed as: feat: S13 - Create AI usage stats component
- Updated PRD: S13 passes: true

---


## 2026-01-20 15:35 - S01: Create orders schema and data model

**What was implemented:**
- Created orders table in packages/backend/convex/schema.ts
- Added businessId (Id<businesses>) and conversationId (Id<conversations>) relationships
- Added orderNumber string field for human-readable order identification
- Added status union type: draft, confirmed, paid, preparing, ready, delivered, cancelled
- Added items array with productId, name, quantity, unitPrice, totalPrice per item
- Added pricing fields: subtotal, deliveryFee (optional), total, currency
- Added deliveryType union: delivery, pickup
- Added deliveryAddress and deliveryNotes optional fields
- Added contactPhone and contactName fields
- Added paymentMethod union: card, cash
- Added paymentStatus union: pending, paid, failed, refunded
- Added Stripe payment fields: paymentLinkUrl, paymentLinkExpiresAt, stripeSessionId
- Added fulfillment fields: estimatedReadyTime, notes
- Added timestamps: createdAt, updatedAt, cancelledAt, cancellationReason
- Created indexes: by_business [businessId, status, createdAt], by_conversation [conversationId], by_number [orderNumber], by_payment_session [stripeSessionId]

**Files changed:**
- packages/backend/convex/schema.ts (+54 lines for orders table)

**Learnings for future iterations:**
- Orders table follows same pattern as conversations: relationships via v.id(), timestamps as v.number()
- Composite index by_business includes status and createdAt for efficient filtered queries
- Items stored as array of objects - denormalized product name/price to capture values at order time
- stripeSessionId index enables webhook reconciliation when payment completes
- All prices stored in smallest currency unit (centavos) as integers per AGENTS.md

**Verification:**
- Convex codegen passes successfully
- LSP diagnostics show no errors on schema.ts
- Committed as: feat: S01 - Create orders schema and data model (commit 7828f11)
- Updated PRD: S01 passes: true

---

## 2026-01-21 14:25 - S01: Update CSS variables with Warm Signal color palette

**What was implemented:**
- Updated apps/web/src/index.css with complete Warm Signal color palette
- Light mode (:root) CSS variables:
  - --background: oklch(0.985 0.002 90) - warm off-white
  - --foreground: oklch(0.145 0.015 60) - warm dark gray
  - --primary: oklch(0.58 0.2 35) - terracotta
  - --secondary: oklch(0.92 0.04 55) - peach
  - --destructive: oklch(0.55 0.2 25) - red-orange
  - --success: oklch(0.6 0.19 145) - green
- Dark mode (.dark) CSS variables with adjusted tones
- Added spacing scale --space-1 through --space-16 (0.25rem to 4rem)
- Added border radius variables: --radius-sm (6px), --radius-md (10px), --radius-lg (16px), --radius-full (9999px)
- Updated @theme inline block to include new variables for Tailwind CSS v4

**Files changed:**
- apps/web/src/index.css (100 insertions, 70 deletions)

**Verification:**
- bun run check-types: passes
- Committed as: feat: S01 - Update CSS variables with Warm Signal color palette (commit 1a4d4a0)

---

## 2026-01-21 14:56 - S11: Create unified StatusBadge component

**What was implemented:**
- Created `apps/web/src/components/composed/StatusBadge.tsx` - unified component for all status badges
- Added `info` variant to badge.tsx for "preparing" status
- Order status mapping: draft->secondary, pending->secondary, confirmed->default, preparing->info, ready->warning, delivered->success, cancelled->destructive
- Conversation status mapping: active->default (AI Handling), escalated->warning, closed->success
- Special handling for active + assignedTo showing "Human Active"
- Replaced inline StatusBadge in orders.tsx and orders.$orderId.tsx
- Updated conversations.tsx and conversations.$conversationId.tsx to use unified component
- Removed old inline STATUS_CONFIG objects from order pages

**Files changed:**
- apps/web/src/components/composed/StatusBadge.tsx (created, 62 lines)
- apps/web/src/components/ui/badge.tsx (added info variant)
- apps/web/src/routes/_authenticated/orders.tsx (replaced inline StatusBadge)
- apps/web/src/routes/_authenticated/orders.$orderId.tsx (replaced inline StatusBadge)
- apps/web/src/routes/_authenticated/conversations.tsx (updated import)
- apps/web/src/routes/_authenticated/conversations.$conversationId.tsx (updated import)

**Learnings for future iterations:**
- Unified components in `components/composed/` folder for app-specific composed components
- Badge component uses CVA with info variant: bg-blue-500/10 text-blue-600 dark:text-blue-400
- When status is optional in schema, provide default value: `status ?? "active"`
- Type prop required to distinguish order vs conversation status mapping

**Verification:**
- LSP diagnostics: no errors on all changed files
- bunx tsc --noEmit: passes
- Committed as: feat: S11 - Create unified StatusBadge component (commit face365)

---

---

## 2026-01-21 15:10 - S13: Create dashboard backend queries

**What was implemented:**
- Created packages/backend/convex/dashboard.ts with two queries
- `getMetrics` query returns:
  - activeConversations: count of conversations with status='active'
  - escalatedCount: count of conversations with status='escalated'
  - ordersToday: count of orders created today (excluding cancelled)
  - revenueToday: sum of order totals created today (in cents)
  - weeklyConversations: count of conversations created this week
  - weeklyChange: percentage change vs previous week
- `getActivity` query returns:
  - Array of recent events with type ('conversation' | 'order'), description, timestamp, link
  - Limit defaults to 5, configurable via args
  - Merges and sorts conversations and orders by timestamp
- Both queries use auth pattern with business ownership validation
- Uses by_business_status index for efficient conversation filtering

**Files changed:**
- packages/backend/convex/dashboard.ts (created, 195 lines)

**Verification:**
- LSP diagnostics: no errors
- Convex codegen: passes
- Committed as: feat: S13 - Create dashboard backend queries (commit ae17da9)

## 2026-01-21 15:12 - S14: Create Dashboard metric cards UI

**What was implemented:**
- Created `apps/web/src/components/composed/MetricCard.tsx` component
  - Props: title, value, subtitle, icon (LucideIcon), link (optional), variant (default | warning)
  - Clickable card that links to relevant page when link prop provided
  - Warning variant for escalated conversations (border-warning, bg-warning)
  - Hover effect with bg-accent/50
- Updated `apps/web/src/routes/_authenticated/dashboard.tsx`
  - Added personalized time-aware greeting: Good morning/afternoon/evening, {userName}!
  - Added subheading: "Here's what's happening at {businessName}"
  - Bento grid layout (3 columns on md+) with MetricCard components
  - Card 1: Conversations - activeConversations count, escalatedCount as warning subtitle
  - Card 2: Orders Today - ordersToday count, revenueToday formatted as currency
  - Card 3: Weekly Trend - weeklyConversations with percentage change indicator
  - Each metric card links to relevant page (/conversations, /orders)
  - Uses TrendingUp/TrendingDown icons based on weeklyChange
- Fixed unused variable warning in dashboard.ts backend

**Files changed:**
- apps/web/src/components/composed/MetricCard.tsx (created, 62 lines)
- apps/web/src/routes/_authenticated/dashboard.tsx (rewritten, 145 lines)
- packages/backend/convex/dashboard.ts (removed unused `now` variable)

**Verification:**
- LSP diagnostics: no errors
- bunx tsc --noEmit: passes
- Committed as: feat: S14 - Create Dashboard metric cards UI (commit 524d66c)

---

## 2026-01-21 15:16 - S15: Create Dashboard activity feed and quick actions

**What was implemented:**
- Created apps/web/src/components/composed/ActivityItem.tsx component
  - Props: type, description, timestamp, link, isEscalation
  - Displays icon based on type (conversation, order, or escalation warning)
  - Escalation items highlighted with warning background
  - Relative timestamp using date-fns formatDistanceToNow
  - Clickable link to relevant page
- Updated apps/web/src/routes/_authenticated/dashboard.tsx
  - Added Recent Activity section below metric cards (takes 2 columns on large screens)
  - Activity section shows last 5 events from getActivity query
  - "See all" link navigates to /conversations
  - Empty state with MessageSquare icon when no activity
- Added Quick Actions sidebar section on right
  - Add Product button
  - Settings button
  - Connect WhatsApp button (shown only if not connected)
- Added onboarding checklist for new businesses
  - Shows when products or WhatsApp not set up
  - Three items: Create business (always complete), Add first product, Connect WhatsApp
  - Each item links to relevant page with completion indicator (CheckCircle2/Circle)
- Uses existing getActivity query from dashboard.ts
- Queries whatsappStatus and products to determine checklist state

**Files changed:**
- apps/web/src/components/composed/ActivityItem.tsx (created, 50 lines)
- apps/web/src/routes/_authenticated/dashboard.tsx (updated from 157 to 254 lines)

**Learnings for future iterations:**
- products.list returns object with { products, hasMore, nextCursor } not just array
- Use optional chaining for nested property access: products?.products?.length

**Verification:**
- LSP diagnostics: no errors
- bunx tsc --noEmit: passes
- Committed as: feat: S15 - Create Dashboard activity feed and quick actions (commit a5cc231)

---
