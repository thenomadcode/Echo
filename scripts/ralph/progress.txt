## Codebase Patterns

### Convex Schema Patterns
- Use `v` from `convex/values` for type validators
- All tables define `createdAt` and `updatedAt` as `v.number()` (UTC timestamps)
- Multi-tenant: All business-specific tables have `businessId: v.id("businesses")` or `v.string()`
- Indexes follow pattern: `.index("by_[field]", ["field1", "field2"])`
- Relationships use `v.id("tableName")` for foreign keys
- Common optional fields use `v.optional(v.type())`
- Nested objects use `v.object({ ... })`
- Unions for enums: `v.union(v.literal("a"), v.literal("b"))`

### Backend Query/Mutation Patterns
- Import from `"./_generated/server"`
- Use `query({ args: {...}, handler: async (ctx) => {...} })`
- Use `mutation({ args: {...}, handler: async (ctx, args) => {...} })`
- Always define args with validators, even if empty: `args: {}`

### AI & Intent Patterns
- Intent classification returns array of intents for multi-intent support
- State machine in `ai/process.ts` handles conversation flow
- Tool-based flow (`ai/agent.ts`) vs intent-based flow (`ai/process.ts`)
- Intent types: product_question, order_start, order_modify, order_confirm, delivery_choice, address_provided, payment_choice, escalation_request
- Customer data persistence via `ai/customerHistory.ts` actions
- Order creation flow: pendingOrder → checkout → validate → create order → Shopify sync

### Frontend Patterns
- TanStack Router with file-based routes
- Use `createFileRoute` and export `Route` constant
- Forms use `@tanstack/react-form` with Zod validators
- UI components from `@/components/ui/` (shadcn/ui)
- Use `cn()` utility for className merging
- Named exports for components: `export function MyComponent() {}`

---


## 2026-01-31 19:50 - US-001
- Implemented multi-intent detection in intent classifier
- Updated classifyIntent action to return { intents: Intent[], tokensUsed: number }
- Modified INTENT_CLASSIFICATION_PROMPT to enable multi-intent detection with examples
- Updated parseJsonResponse to handle both array and single object for backwards compatibility
- Modified processMessage to use intents[0] for backwards compatibility (US-002 will expand this)
- Files changed:
  - packages/backend/convex/ai/intent.ts (added multi-intent support)
  - packages/backend/convex/ai/process.ts (backwards compatible change)
- **Learnings for future iterations:**
  - Multi-intent detection requires updating the prompt to explicitly request array format
  - parseJsonResponse needs robust fallback handling for malformed AI responses
  - Backwards compatibility achieved by using intents[0] in existing code
  - All intent examples in prompt must be converted to array format for consistency
---

## 2026-01-31 19:57 - US-002
- Implemented multi-intent processing in processMessage workflow
- Modified intent handling to iterate through all intents in intents array instead of using intents[0]
- Added state progression tracking: currentState updates after each intent is processed
- Added accumulation of pendingOrder and pendingDelivery across multiple intents
- Order creation now happens when final intent satisfies all conditions (items + delivery + payment)
- Example: "Ship to 123 Main St, I'll pay cash" now processes both delivery_choice and payment_choice intents sequentially
- Files changed:
  - packages/backend/convex/ai/process.ts (refactored processMessage action to support multi-intent flow)
- **Learnings for future iterations:**
  - Multi-intent processing requires accumulating state across the loop (pendingOrder, pendingDelivery)
  - State transitions must happen sequentially: confirming → payment → completed
  - Each intent sees the accumulated data from previous intents in the same message
  - Type annotations (currentState: string, newState: string) needed to avoid TypeScript inference issues
  - The last intent is used for response generation context
---

## 2026-01-31 20:19 - US-003
- Implemented customer name extraction and persistence
- Added updateNameInternal mutation in packages/backend/convex/customers.ts
  - Internal mutation (no auth checks) for AI flow use
  - Prefers longer names (e.g., "John Smith" over "John")
  - Only updates if name not set or new name is more complete
- Created extractCustomerName function in packages/backend/convex/ai/process.ts
  - Detects names from delivery addresses: "Ship to John Smith, 123 Main St"
  - Detects from explicit statements: "My name is Sarah", "Me llamo Juan"
  - Detects from "for" patterns: "This is for Maria"
  - Multi-language support (English, Spanish, Portuguese)
- Integrated into processMessage intent loop
  - Checks each intent for potential name extraction
  - Saves name via updateNameInternal if customerRecordId exists
- Files changed:
  - packages/backend/convex/customers.ts (added updateNameInternal mutation)
  - packages/backend/convex/ai/process.ts (added extractCustomerName function and integration)
- **Learnings for future iterations:**
  - Name extraction from addresses requires careful regex to avoid false positives
  - Capitalization check ensures we extract proper names, not common words
  - Multi-language patterns needed for LATAM market (Spanish/Portuguese)
  - Prefer longer names when updating to capture full names vs nicknames
  - Integration point is the intent loop, not individual intent handlers
---

## 2026-01-31 20:19 - US-004
- Implemented customer address persistence in handleCheckoutIntent
- Added calls to api.ai.customerHistory.updateCustomerAddress for both delivery_choice and address_provided intents
- Address saved in try-catch blocks before order creation to ensure persistence even if order fails
- Leverages existing fuzzy matching logic to prevent duplicate addresses
- Auto-generates label ("Home", "Work", or "Address") and sets isDefault=true for first address
- Files changed:
  - packages/backend/convex/ai/process.ts (added address persistence in handleCheckoutIntent)
- **Learnings for future iterations:**
  - Address persistence should happen before order creation so it persists even on order failure
  - Use try-catch with error logging but continue execution on address save failures
  - The updateCustomerAddress action already handles all the complexity (fuzzy matching, labeling, default setting)
  - Two intents can trigger address saving: delivery_choice (with address) and address_provided
  - Pattern: External actions should be resilient - log errors but don't block the main flow
---

## 2026-01-31 20:19 - US-005
- Implemented order validation before AI confirmation
- Added success: boolean field to CheckoutResult interface in ai/process.ts
- Implemented order verification after creation using getOrderDetails query
- Updated CheckoutContext interface and validator in ai/response.ts to include success and error fields
- Updated payment_choice case in buildContextInstruction to check success flag before confirming order
- Modified processMessage to pass success field to response generator in checkoutContext
- Added explicit handling for order creation failure: reverts state to 'confirming' for customer retry
- Updated both ai/prompts.ts and ai/agentPrompt.ts with ORDER VALIDATION rule mandating AI never says "order placed" without success=true
- Files changed:
  - packages/backend/convex/ai/process.ts (CheckoutResult interface, order verification, state handling)
  - packages/backend/convex/ai/response.ts (CheckoutContext interface, payment_choice handling)
  - packages/backend/convex/ai/prompts.ts (ORDER VALIDATION rule added)
  - packages/backend/convex/ai/agentPrompt.ts (submit_order tool documentation updated)
- **Learnings for future iterations:**
  - Order verification should happen immediately after creation before any subsequent operations
  - Failure handling requires explicit state management - reverting to 'confirming' allows customer to retry
  - Success/failure flags must propagate through the entire chain: mutation → action → response generation → AI prompt
  - AI prompts need explicit, unambiguous rules about when to confirm vs apologize - use CRITICAL/ABSOLUTE language
  - The condition for clearing pending data changed from checking orderId to checking success===true
---
## 2026-01-31 20:25 - US-006
- Implemented Shopify draft order creation for card payments with graceful error handling
- Enhanced generatePaymentLink in packages/backend/convex/orders/payments.ts:
  - Added try-catch block around Shopify createOrder call (lines 60-82)
  - Logs success when Shopify draft order created (shopifyDraftOrderId)
  - Logs error and falls back to Stripe if Shopify fails
  - Ensures customers can complete payment even if Shopify has issues
- Added logging in handleCheckoutIntent (packages/backend/convex/ai/process.ts):
  - Logs when payment link generation starts for card payments (line 915)
  - Logs when payment link generation completes successfully (line 921)
- Verified complete flow:
  1. handleCheckoutIntent detects payment_choice='card' intent
  2. Creates Convex order via orders.mutations.create
  3. Sets delivery info and payment method
  4. Calls generatePaymentLink action
  5. generatePaymentLink checks for Shopify connection
  6. If connected, calls integrations.shopify.orders.createOrder
  7. createOrder creates Shopify draft order via REST API
  8. Returns invoiceUrl from draft_order.invoice_url
  9. Saves shopifyDraftOrderId to Echo order (via updateOrderWithDraftOrderInfo)
  10. invoiceUrl flows back through paymentLink variable
  11. checkoutResult includes paymentLink field
  12. AI response includes payment link in instruction (response.ts line 292)
- Files changed:
  - packages/backend/convex/orders/payments.ts (enhanced error handling, added logging)
  - packages/backend/convex/ai/process.ts (added checkout logging)
- **Learnings for future iterations:**
  - When integrating external APIs (Shopify), always provide fallback mechanisms
  - Log both success and failure paths for better debugging
  - Try-catch error boundaries prevent entire checkout flow from failing
  - Graceful degradation: Stripe fallback ensures business continuity if Shopify has issues
  - Console.log is acceptable for informational/operational logging (not just errors)
  - Pattern: Try primary provider → log error → fall back to secondary provider
---
## 2026-01-31 20:32 - US-007
- Implemented Shopify regular order creation for cash payments
- Modified createOrderInternal in packages/backend/convex/integrations/shopify/orders.ts:
  - Added payment method detection (lines 399-402)
  - For cash payments: calls createRegularOrder helper function (creates regular Shopify order via /admin/api/2026-01/orders.json)
  - For card payments: maintains existing draft order flow (creates draft via /admin/api/2026-01/draft_orders.json)
- Created createRegularOrder helper function (lines 202-357):
  - Creates regular Shopify orders with financial_status='paid' for cash payments
  - Includes transaction record marking payment as successful
  - Saves shopifyOrderId to Echo orders table (not shopifyDraftOrderId)
  - Handles line items, customer info, shipping address same as draft orders
  - Comprehensive error handling with console.error for failures
- Added types to support regular order creation:
  - ShopifyOrderResponse type in integrations/shopify/types.ts
  - Uses existing updateOrderWithShopifyInfo mutation to save shopifyOrderId
- Inventory sync verification:
  - Convex: decrementInventory already called in setPaymentMethod (orders/delivery.ts line 72-74)
  - Shopify: Regular orders automatically decrement inventory when created (unlike drafts)
- Files changed:
  - packages/backend/convex/integrations/shopify/orders.ts (added createRegularOrder, modified createOrderInternal)
  - packages/backend/convex/integrations/shopify/types.ts (added ShopifyOrderResponse type)
- **Learnings for future iterations:**
  - Shopify has two order APIs: draft_orders.json (for payment-pending) vs orders.json (for completed/paid)
  - Draft orders don't affect inventory until converted to regular orders
  - Regular orders automatically decrement inventory and mark financial_status='paid'
  - Must include transactions array when creating paid orders via API
  - Payment method distinction (cash vs card) requires different Shopify order types
  - updateOrderWithShopifyInfo saves shopifyOrderId, updateOrderWithDraftOrderInfo saves shopifyDraftOrderId
  - Logging pattern: use console.error for errors (console.log/info automatically removed by linter)
---
