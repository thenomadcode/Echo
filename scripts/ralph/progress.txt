## Codebase Patterns

### Convex Schema Patterns
- Use `v` from `convex/values` for type validators
- All tables define `createdAt` and `updatedAt` as `v.number()` (UTC timestamps)
- Multi-tenant: All business-specific tables have `businessId: v.id("businesses")` or `v.string()`
- Indexes follow pattern: `.index("by_[field]", ["field1", "field2"])`
- Relationships use `v.id("tableName")` for foreign keys
- Common optional fields use `v.optional(v.type())`
- Nested objects use `v.object({ ... })`
- Unions for enums: `v.union(v.literal("a"), v.literal("b"))`

### Backend Query/Mutation Patterns
- Import from `"./_generated/server"`
- Use `query({ args: {...}, handler: async (ctx) => {...} })`
- Use `mutation({ args: {...}, handler: async (ctx, args) => {...} })`
- Always define args with validators, even if empty: `args: {}`

### AI & Intent Patterns
- Intent classification returns array of intents for multi-intent support
- State machine in `ai/process.ts` handles conversation flow
- Tool-based flow (`ai/agent.ts`) vs intent-based flow (`ai/process.ts`)
- Intent types: product_question, order_start, order_modify, order_confirm, delivery_choice, address_provided, payment_choice, escalation_request
- Customer data persistence via `ai/customerHistory.ts` actions
- Order creation flow: pendingOrder → checkout → validate → create order → Shopify sync

### Frontend Patterns
- TanStack Router with file-based routes
- Use `createFileRoute` and export `Route` constant
- Forms use `@tanstack/react-form` with Zod validators
- UI components from `@/components/ui/` (shadcn/ui)
- Use `cn()` utility for className merging
- Named exports for components: `export function MyComponent() {}`

---


## 2026-01-31 19:50 - US-001
- Implemented multi-intent detection in intent classifier
- Updated classifyIntent action to return { intents: Intent[], tokensUsed: number }
- Modified INTENT_CLASSIFICATION_PROMPT to enable multi-intent detection with examples
- Updated parseJsonResponse to handle both array and single object for backwards compatibility
- Modified processMessage to use intents[0] for backwards compatibility (US-002 will expand this)
- Files changed:
  - packages/backend/convex/ai/intent.ts (added multi-intent support)
  - packages/backend/convex/ai/process.ts (backwards compatible change)
- **Learnings for future iterations:**
  - Multi-intent detection requires updating the prompt to explicitly request array format
  - parseJsonResponse needs robust fallback handling for malformed AI responses
  - Backwards compatibility achieved by using intents[0] in existing code
  - All intent examples in prompt must be converted to array format for consistency
---
