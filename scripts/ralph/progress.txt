## Codebase Patterns

### Convex Schema Patterns
- Use `v` from `convex/values` for type validators
- All tables define `createdAt` and `updatedAt` as `v.number()` (UTC timestamps)
- Multi-tenant: All business-specific tables have `businessId: v.id("businesses")` or `v.string()`
- Indexes follow pattern: `.index("by_[field]", ["field1", "field2"])`
- Relationships use `v.id("tableName")` for foreign keys
- Common optional fields use `v.optional(v.type())`
- Nested objects use `v.object({ ... })`
- Unions for enums: `v.union(v.literal("a"), v.literal("b"))`

### Backend Query/Mutation Patterns
- Import from `"./_generated/server"`
- Use `query({ args: {...}, handler: async (ctx) => {...} })`
- Use `mutation({ args: {...}, handler: async (ctx, args) => {...} })`
- Always define args with validators, even if empty: `args: {}`

### AI & Intent Patterns
- Intent classification returns array of intents for multi-intent support
- State machine in `ai/process.ts` handles conversation flow
- Tool-based flow (`ai/agent.ts`) vs intent-based flow (`ai/process.ts`)
- Intent types: product_question, order_start, order_modify, order_confirm, delivery_choice, address_provided, payment_choice, escalation_request
- Customer data persistence via `ai/customerHistory.ts` actions
- Order creation flow: pendingOrder → checkout → validate → create order → Shopify sync

### Frontend Patterns
- TanStack Router with file-based routes
- Use `createFileRoute` and export `Route` constant
- Forms use `@tanstack/react-form` with Zod validators
- UI components from `@/components/ui/` (shadcn/ui)
- Use `cn()` utility for className merging
- Named exports for components: `export function MyComponent() {}`

---


## 2026-01-31 19:50 - US-001
- Implemented multi-intent detection in intent classifier
- Updated classifyIntent action to return { intents: Intent[], tokensUsed: number }
- Modified INTENT_CLASSIFICATION_PROMPT to enable multi-intent detection with examples
- Updated parseJsonResponse to handle both array and single object for backwards compatibility
- Modified processMessage to use intents[0] for backwards compatibility (US-002 will expand this)
- Files changed:
  - packages/backend/convex/ai/intent.ts (added multi-intent support)
  - packages/backend/convex/ai/process.ts (backwards compatible change)
- **Learnings for future iterations:**
  - Multi-intent detection requires updating the prompt to explicitly request array format
  - parseJsonResponse needs robust fallback handling for malformed AI responses
  - Backwards compatibility achieved by using intents[0] in existing code
  - All intent examples in prompt must be converted to array format for consistency
---

## 2026-01-31 19:57 - US-002
- Implemented multi-intent processing in processMessage workflow
- Modified intent handling to iterate through all intents in intents array instead of using intents[0]
- Added state progression tracking: currentState updates after each intent is processed
- Added accumulation of pendingOrder and pendingDelivery across multiple intents
- Order creation now happens when final intent satisfies all conditions (items + delivery + payment)
- Example: "Ship to 123 Main St, I'll pay cash" now processes both delivery_choice and payment_choice intents sequentially
- Files changed:
  - packages/backend/convex/ai/process.ts (refactored processMessage action to support multi-intent flow)
- **Learnings for future iterations:**
  - Multi-intent processing requires accumulating state across the loop (pendingOrder, pendingDelivery)
  - State transitions must happen sequentially: confirming → payment → completed
  - Each intent sees the accumulated data from previous intents in the same message
  - Type annotations (currentState: string, newState: string) needed to avoid TypeScript inference issues
  - The last intent is used for response generation context
---
