## Codebase Patterns

### Convex Schema Patterns
- Use `v` from `convex/values` for type validators
- All tables define `createdAt` and `updatedAt` as `v.number()` (UTC timestamps)
- Multi-tenant: All business-specific tables have `businessId: v.id("businesses")` or `v.string()`
- Indexes follow pattern: `.index("by_[field]", ["field1", "field2"])`
- Relationships use `v.id("tableName")` for foreign keys
- Common optional fields use `v.optional(v.type())`
- Nested objects use `v.object({ ... })`
- Unions for enums: `v.union(v.literal("a"), v.literal("b"))`

### Backend Query/Mutation Patterns
- Import from `"./_generated/server"`
- Use `query({ args: {...}, handler: async (ctx) => {...} })`
- Use `mutation({ args: {...}, handler: async (ctx, args) => {...} })`
- Always define args with validators, even if empty: `args: {}`

### AI & Intent Patterns
- Intent classification returns array of intents for multi-intent support
- State machine in `ai/process.ts` handles conversation flow
- Tool-based flow (`ai/agent.ts`) vs intent-based flow (`ai/process.ts`)
- Intent types: product_question, order_start, order_modify, order_confirm, delivery_choice, address_provided, payment_choice, escalation_request
- Customer data persistence via `ai/customerHistory.ts` actions
- Order creation flow: pendingOrder → checkout → validate → create order → Shopify sync

### Frontend Patterns
- TanStack Router with file-based routes
- Use `createFileRoute` and export `Route` constant
- Forms use `@tanstack/react-form` with Zod validators
- UI components from `@/components/ui/` (shadcn/ui)
- Use `cn()` utility for className merging
- Named exports for components: `export function MyComponent() {}`

---

