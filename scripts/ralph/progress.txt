## Codebase Patterns

### Convex Schema Patterns
- Use `v` from `convex/values` for type validators
- All tables define `createdAt` and `updatedAt` as `v.number()` (UTC timestamps)
- Multi-tenant: All business-specific tables have `businessId: v.id("businesses")` or `v.string()`
- Indexes follow pattern: `.index("by_[field]", ["field1", "field2"])`
- Relationships use `v.id("tableName")` for foreign keys
- Common optional fields use `v.optional(v.type())`
- Nested objects use `v.object({ ... })`
- Unions for enums: `v.union(v.literal("a"), v.literal("b"))`

### Backend Query/Mutation Patterns
- Import from `"./_generated/server"`
- Use `query({ args: {...}, handler: async (ctx) => {...} })`
- Use `mutation({ args: {...}, handler: async (ctx, args) => {...} })`
- Always define args with validators, even if empty: `args: {}`

---

## 2026-01-30 20:53 - US-001
- Implemented productVariants table schema in packages/backend/convex/schema.ts
- Added all required fields: productId, name, sku, price, inventoryQuantity, option1-3 Name/Value pairs, imageId, externalVariantId, available, position, createdAt, updatedAt
- Added optional fields: compareAtPrice, costPrice, barcode, weight, weightUnit, requiresShipping, lastSyncAt
- Created indexes: by_product, by_sku, by_external_id
- Files changed: packages/backend/convex/schema.ts
- **Learnings for future iterations:**
  - Convex schema uses `v.id("tableName")` for foreign key references (not just v.string())
  - Product variants follow Shopify-compatible model: up to 3 option name/value pairs
  - Weight units stored as enum: kg, g, lb, oz
  - All prices stored in smallest currency unit (centavos/cents) as integers
  - Soft delete pattern: use `available: v.boolean()` instead of hard deletes
---

## 2026-01-30 20:56 - US-002
- Updated products table schema in packages/backend/convex/schema.ts:
  - Added hasVariants boolean field (default: false)
  - Expanded source field to support 'manual' | 'shopify' | 'woocommerce' | 'tiendanube'
  - Renamed shopifyProductId to externalProductId
  - Renamed lastShopifySyncAt to lastSyncAt
  - Updated index from by_shopify_id to by_external_id with [businessId, source, externalProductId]
- Updated all Shopify integration files:
  - packages/backend/convex/integrations/shopify/mutations.ts (upsertProduct, upsertProductWithStats, markProductsUnavailable, deleteConnectionAndClearProducts)
  - packages/backend/convex/integrations/shopify/products.ts (importProducts, syncProducts)
  - packages/backend/convex/integrations/shopify/webhooks.ts (handleWebhook)
- Updated all AI files to use new field names:
  - packages/backend/convex/ai/agentPrompt.ts
  - packages/backend/convex/ai/response.ts
  - packages/backend/convex/ai/agent.ts
  - packages/backend/convex/ai/prompts.ts
  - packages/backend/convex/ai/process.ts
- **Learnings for future iterations:**
  - When renaming schema fields, must update:
    1. Schema definition
    2. All mutations using the field
    3. All queries/filters using withIndex
    4. TypeScript interfaces in AI/integration code
  - The hasVariants field is now required on all product inserts (defaults to false for existing Shopify imports)
  - E-commerce provider source is now generic, supporting future integrations beyond Shopify
  - Compound indexes require all fields in the index definition when querying
---

## 2026-01-30 21:08 - US-003
- Updated orders table schema in packages/backend/convex/schema.ts:
  - Added variantId field (optional v.id("productVariants"))
  - Added variantName field (optional v.string())
  - Added sku field (optional v.string())
- Updated OrderItem type in packages/backend/convex/orders/types.ts with same fields
- Files changed: packages/backend/convex/schema.ts, packages/backend/convex/orders/types.ts
- **Learnings for future iterations:**
  - Order items schema changes are backward compatible with existing orders (all new fields are optional)
  - TypeScript types should match Convex schema validators exactly
  - Orders can now track both simple products and specific variants
  - Future mutations will use variantId to fetch price from productVariants table instead of products table
---
