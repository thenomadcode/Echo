{
  "projectName": "ai-conversation-engine",
  "branchName": "feature/ai-conversation-engine",
  "userStories": [
    {
      "id": "S01",
      "title": "Create AI data model and update conversations schema",
      "priority": 1,
      "passes": true,
      "ultrawork": true,
      "acceptanceCriteria": [
        "Create aiLogs table in packages/backend/convex/schema.ts with fields: conversationId (Id<conversations>), messageId (Id<messages>), intent (object), prompt (string), response (string), model (string), tokensUsed (number), latencyMs (number), createdAt (number)",
        "Add index by_conversation on aiLogs [conversationId]",
        "Update conversations table: add state (string: idle|browsing|ordering|confirming|payment|completed|escalated), detectedLanguage (string), pendingOrder (optional object), escalationReason (optional string)",
        "Run npx convex dev to verify schema compiles without errors"
      ]
    },
    {
      "id": "S02",
      "title": "Create AI provider abstraction and types",
      "priority": 2,
      "passes": true,
      "ultrawork": true,
      "acceptanceCriteria": [
        "Create packages/backend/convex/ai/types.ts with AIProvider interface including complete(params) method",
        "Define Message type with role (system|user|assistant) and content (string)",
        "Define CompleteParams type with messages (Message[]), systemPrompt (string), temperature (optional number), maxTokens (optional number), responseFormat (optional text|json)",
        "Define Intent union type with all intents: greeting, product_question (with query string), order_start (with items array), order_modify (with action and item), business_question (with topic string), escalation_request, small_talk, unknown",
        "Define OrderItem type with productQuery (string) and quantity (number)",
        "Define AIResponse type with response (string), intent (Intent), shouldEscalate (boolean), detectedLanguage (string)",
        "Export all types for use in other modules"
      ]
    },
    {
      "id": "S03",
      "title": "Implement OpenAI provider",
      "priority": 3,
      "passes": true,
      "ultrawork": false,
      "acceptanceCriteria": [
        "Create packages/backend/convex/ai/providers/openai.ts",
        "Implement OpenAIProvider class implementing AIProvider interface",
        "Use OPENAI_API_KEY from environment variables",
        "Support gpt-4o-mini as default model",
        "Implement complete() method that calls OpenAI chat completions API",
        "Handle JSON response format when responseFormat is json",
        "Return response content as string",
        "Handle API errors gracefully with descriptive error messages"
      ]
    },
    {
      "id": "S04",
      "title": "Create language detection function",
      "priority": 4,
      "passes": true,
      "ultrawork": false,
      "acceptanceCriteria": [
        "Create packages/backend/convex/ai/language.ts",
        "Create detectLanguage action that takes message string and returns language code (es|pt|en)",
        "Use lightweight prompt to classify language",
        "Default to 'en' if detection fails or is ambiguous",
        "Support Spanish, Portuguese, and English detection",
        "Return language code within 500ms"
      ]
    },
    {
      "id": "S05",
      "title": "Implement intent classification function",
      "priority": 5,
      "passes": true,
      "ultrawork": true,
      "acceptanceCriteria": [
        "Create packages/backend/convex/ai/intent.ts",
        "Create classifyIntent action accepting: message (string), conversationHistory (Message[]), productNames (string[])",
        "Use structured JSON output from AI to extract intent type and entities",
        "For product_question: extract the product query string",
        "For order_start/order_modify: extract product name and quantity (default 1)",
        "For business_question: extract the topic (hours, location, delivery, payment)",
        "Handle misspellings and variations in product names",
        "Return typed Intent object matching the Intent union type",
        "Complete classification within 500ms using gpt-4o-mini"
      ]
    },
    {
      "id": "S06",
      "title": "Create system prompt builder",
      "priority": 6,
      "passes": true,
      "ultrawork": false,
      "acceptanceCriteria": [
        "Create packages/backend/convex/ai/prompts.ts",
        "Create buildSystemPrompt function accepting: business info, products list, conversation state, detected language",
        "Include business name, type, hours, address, delivery info in prompt",
        "Format products with name, price, description",
        "Include current conversation state",
        "Add rules: only mention real products, admit when unsure, offer human help for frustrated customers",
        "Include configurable AI tone from business settings",
        "Support language instruction to respond in customer's language"
      ]
    },
    {
      "id": "S07",
      "title": "Implement response generation function",
      "priority": 7,
      "passes": true,
      "ultrawork": true,
      "acceptanceCriteria": [
        "Create packages/backend/convex/ai/response.ts",
        "Create generateResponse action accepting: intent, conversationHistory, businessContext, products, language",
        "Use system prompt builder to create context-aware prompt",
        "Generate natural, conversational responses in customer's language",
        "For product_question: include actual product info from database",
        "For order_start: confirm items and prices",
        "For business_question: use configured business info",
        "For greeting: friendly welcome with offer to help",
        "For unknown: politely redirect to what AI can help with",
        "Complete generation within 2s"
      ]
    },
    {
      "id": "S08",
      "title": "Implement escalation detection function",
      "priority": 8,
      "passes": true,
      "ultrawork": false,
      "acceptanceCriteria": [
        "Create packages/backend/convex/ai/escalation.ts",
        "Create detectEscalation function accepting: message, conversationHistory, failureCount",
        "Return shouldEscalate (boolean) and reason (string)",
        "Trigger escalation for explicit requests: 'talk to person', 'human help', 'speak to someone'",
        "Trigger escalation for 'urgent' keyword",
        "Trigger escalation after 3+ consecutive AI failures (failureCount >= 3)",
        "Detect frustrated/angry tone using sentiment keywords",
        "Include escalation reason in response"
      ]
    },
    {
      "id": "S09",
      "title": "Create main processMessage orchestrator",
      "priority": 9,
      "passes": true,
      "ultrawork": true,
      "acceptanceCriteria": [
        "Create packages/backend/convex/ai/process.ts",
        "Create processMessage action accepting: conversationId, message",
        "Load conversation and business context from database",
        "Load products for the business",
        "Call detectLanguage on first message, store in conversation",
        "Call classifyIntent with message and context",
        "Call detectEscalation to check if human handoff needed",
        "Call generateResponse with intent and context",
        "Update conversation state based on intent",
        "Log to aiLogs table: intent, prompt, response, model, tokens, latency",
        "Return AIResponse with response text, intent, shouldEscalate, language",
        "Total processing time under 3s"
      ]
    },
    {
      "id": "S10",
      "title": "Handle order intent state transitions",
      "priority": 10,
      "passes": false,
      "ultrawork": false,
      "acceptanceCriteria": [
        "Update processMessage to handle order_start intent",
        "Transition conversation state: idle -> ordering when order starts",
        "Store pending order items in conversation.pendingOrder",
        "Handle order_modify intent: add, remove, change quantity",
        "Update pendingOrder items list on modifications",
        "Generate confirmation response listing items and total price",
        "Transition to confirming state when customer confirms",
        "Provide graceful response for 'remove X' when item not in order"
      ]
    },
    {
      "id": "S11",
      "title": "Handle escalation and conversation handoff",
      "priority": 11,
      "passes": false,
      "ultrawork": false,
      "acceptanceCriteria": [
        "Update processMessage to handle shouldEscalate=true",
        "Transition conversation state to 'escalated'",
        "Store escalationReason in conversation",
        "Generate graceful handoff message explaining human will take over",
        "Create ai.notifyEscalation internal mutation to alert business",
        "Mark conversation as needing attention in database",
        "Stop AI from responding to escalated conversations until reset"
      ]
    },
    {
      "id": "S12",
      "title": "Create AI settings page",
      "priority": 12,
      "passes": false,
      "ultrawork": false,
      "acceptanceCriteria": [
        "Create apps/web/src/routes/settings/ai.tsx page",
        "Create ai.getSettings query returning current AI config for business",
        "Create ai.updateSettings mutation to save AI configuration",
        "Form field: AI tone/personality (text input for custom tone)",
        "Form field: Custom greeting message (textarea)",
        "Form field: Escalation keywords (comma-separated input)",
        "Save button calls updateSettings mutation with toast feedback",
        "Load existing settings on page mount",
        "BROWSER TEST: Navigate to /settings/ai, verify page renders",
        "BROWSER TEST: Form renders with tone, greeting, and escalation fields",
        "BROWSER TEST: Save button is visible and clickable"
      ]
    },
    {
      "id": "S13",
      "title": "Create AI usage stats component",
      "priority": 13,
      "passes": false,
      "ultrawork": false,
      "acceptanceCriteria": [
        "Create apps/web/src/components/ai/usage-stats.tsx component",
        "Create ai.getUsageStats query returning: totalTokens, totalConversations, avgLatency, estimatedCost",
        "Query aggregates from aiLogs table for current business",
        "Display total tokens used this month",
        "Display total AI conversations handled",
        "Display average response latency",
        "Display estimated cost (tokens * rate)",
        "Add usage stats section to /settings/ai page",
        "BROWSER TEST: Navigate to /settings/ai, verify usage stats section renders",
        "BROWSER TEST: Stats display token count, conversation count, latency, and cost"
      ]
    }
  ]
}
