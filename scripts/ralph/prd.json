{
	"project": "Echo AI Sales Assistant",
	"branchName": "tnc-241-improve-prompting",
	"description": "Fix critical AI conversation bugs: orders not created, customer data not saved, Shopify integration broken, and improve AI personality to be sales-focused with human-like messaging",
	"userStories": [
		{
			"id": "US-001",
			"title": "Implement multi-intent detection in intent classifier",
			"description": "As a developer, I need the intent classifier to detect multiple intents in a single message so customers can provide delivery info + payment method at once.",
			"acceptanceCriteria": [
				"Update packages/backend/convex/ai/intent.ts to return array of intents instead of single intent",
				"Change IntentResult type from { intent: Intent } to { intents: Intent[] }",
				"AI can detect both 'delivery_choice' and 'payment_choice' in same message",
				"Example: 'Ship to 123 Main St, I'll pay cash' detects both delivery and payment intents",
				"Backwards compatible: single intent returns as array with one element",
				"Typecheck passes"
			],
			"priority": 1,
			"passes": true,
			"ultrawork": true,
			"notes": "Completed: Updated intent classifier to return intents array, added multi-intent examples to prompt, maintained backwards compatibility"
		},
		{
			"id": "US-002",
			"title": "Update processMessage to handle multiple intents",
			"description": "As a developer, I need the message processing workflow to iterate through multiple intents so all customer information is processed in one message.",
			"acceptanceCriteria": [
				"Update packages/backend/convex/ai/process.ts processMessage() to iterate through intents array",
				"Apply each intent sequentially: state transitions, order updates, checkout handling",
				"Order created when final intent satisfies all conditions (items + delivery + payment)",
				"Customer data saved for each relevant intent (name, address, preferences)",
				"State machine progresses through multiple states if needed (e.g., confirming → payment → completed)",
				"Typecheck passes"
			],
			"priority": 2,
			"passes": true,
			"ultrawork": true,
			"notes": "Completed: Refactored processMessage to iterate through all intents, accumulating pendingOrder and pendingDelivery across intents. State transitions now happen sequentially, allowing multi-intent messages like 'Ship to 123 Main St, I'll pay cash' to be processed in one go."
		},
		{
			"id": "US-003",
			"title": "Add customer name extraction and persistence",
			"description": "As a business owner, I want customer names automatically extracted from messages and saved so I can personalize interactions.",
			"acceptanceCriteria": [
				"Detect customer name from patterns: 'My name is X', 'Ship to John Smith, ...', 'This is for Maria'",
				"Save extracted name to customers.name field via customers.update mutation",
				"Name extraction works in processMessage flow (intent-based, not just tool-based)",
				"Test: Message 'Ship to John Smith, 123 Main St' saves name='John Smith'",
				"Test: Message 'My name is Sarah' saves name='Sarah'",
				"Typecheck passes"
			],
			"priority": 3,
			"passes": true,
			"ultrawork": false,
			"notes": "Completed: Added extractCustomerName function that detects names from multiple patterns (delivery addresses, 'my name is', 'for <name>'), created updateNameInternal mutation in customers.ts, integrated into processMessage intent loop. Prefers longer names when updating."
		},
		{
			"id": "US-004",
			"title": "Persist customer addresses to customerAddresses table",
			"description": "As a returning customer, I want my delivery address remembered so I don't re-type it every order.",
			"acceptanceCriteria": [
				"When delivery_choice intent detected with address, save to customerAddresses table",
				"Call api.ai.customerHistory.updateCustomerAddress in handleCheckoutIntent",
				"Address saved with label 'Home' and isDefault=true for first address",
				"Fuzzy matching prevents duplicate addresses (uses existing logic)",
				"Address persists even if order creation fails",
				"Typecheck passes"
			],
			"priority": 4,
			"passes": true,
			"ultrawork": false,
			"notes": "Completed: Address persistence integrated into handleCheckoutIntent for both delivery_choice and address_provided intents. Uses existing updateCustomerAddress action with fuzzy matching and auto-labeling. Address saved in try-catch before order creation to ensure persistence even on order failure."
		},
		{
			"id": "US-005",
			"title": "Add order validation before AI confirmation",
			"description": "As a customer, I want accurate order status information so I know exactly what to expect.",
			"acceptanceCriteria": [
				"After order creation in handleCheckoutIntent, verify order exists in database",
				"Query orders table to confirm orderId is valid before returning success",
				"If order creation fails, return { success: false, error: 'message' } instead of order number",
				"AI prompt updated: NEVER say 'order placed' unless checkoutResult.success === true",
				"AI says 'Had trouble creating order. Let me try again.' if creation fails",
				"Typecheck passes"
			],
			"priority": 5,
			"passes": true,
			"ultrawork": true,
			"notes": "Completed: Added success field to CheckoutResult interface, implemented order verification after creation with getOrderDetails query, updated response.ts to check success before confirming orders, added failure handling that reverts state to 'confirming' for retry, updated both prompts.ts and agentPrompt.ts with ORDER VALIDATION rule"
		},
		{
			"id": "US-006",
			"title": "Fix Shopify draft order creation for card payments",
			"description": "As a customer paying by card, I want to receive a Shopify invoice URL so I can complete payment.",
			"acceptanceCriteria": [
				"When payment_choice intent = 'card' and Shopify connected, create Shopify draft order",
				"Call api.integrations.shopify.orders.createOrder after Convex order created",
				"Return invoiceUrl from Shopify in checkoutResult",
				"AI includes payment link in response: 'Here's your payment link: [URL]'",
				"Shopify draft order ID saved to order.shopifyDraftOrderId",
				"Add logging for Shopify API failures",
				"Typecheck passes"
			],
			"priority": 6,
			"passes": true,
			"ultrawork": true,
			"notes": "Completed: Enhanced error handling in generatePaymentLink to gracefully handle Shopify API failures with fallback to Stripe. Added comprehensive logging for Shopify draft order creation lifecycle. Payment flow verified: handleCheckoutIntent → generatePaymentLink → createOrder → invoiceUrl → checkoutResult → AI response."
		},
		{
			"id": "US-007",
			"title": "Verify Shopify order creation for cash payments",
			"description": "As a business owner, I want cash orders to sync to Shopify so I can track inventory and fulfillment.",
			"acceptanceCriteria": [
				"When payment_choice = 'cash' and Shopify connected, trigger Shopify order creation",
				"Verify orders/delivery.ts setPaymentMethod() calls internal.orders.shopify.triggerShopifyOrderCreation",
				"Shopify regular order (not draft) created in background",
				"Order status = 'confirmed' for cash payments",
				"Inventory decremented in both Convex and Shopify",
				"Add error handling and logging for Shopify sync failures",
				"Typecheck passes"
			],
			"priority": 7,
			"passes": false,
			"ultrawork": false,
			"notes": ""
		},
		{
			"id": "US-008",
			"title": "Update AI prompts to be sales-focused and directive",
			"description": "As a business owner, I want the AI to actively guide customers toward completing purchases so I don't lose sales.",
			"acceptanceCriteria": [
				"Update packages/backend/convex/ai/prompts.ts with 'YOUR CORE OBJECTIVE: SELL' section",
				"Add directive examples: 'Ready to order?' instead of 'Let me know if you have questions'",
				"Add urgency tactics: 'Only 2 left in stock - should I reserve one?'",
				"Add mandatory order creation rule: When items + delivery + payment present, MUST use submit_order",
				"Add validation rule: NEVER say 'order placed' unless submit_order returned success",
				"Remove passive phrases: 'Take your time', 'Anything else?', 'Is there anything...'",
				"Typecheck passes"
			],
			"priority": 8,
			"passes": false,
			"ultrawork": false,
			"notes": ""
		},
		{
			"id": "US-009",
			"title": "Update AI prompts for human-like text messaging style",
			"description": "As a customer, I want natural conversational responses so messaging feels like talking to a real person.",
			"acceptanceCriteria": [
				"Update packages/backend/convex/ai/agentPrompt.ts with 'Text Like a Human' guidelines",
				"Enforce 1-2 sentences max per message (60-80 characters)",
				"Add examples: 'Cool! That's $749. Should I add it?' instead of long explanations",
				"Prohibit bullet points and formatted lists in messages",
				"Use casual language: 'yeah', 'cool', 'awesome' instead of formal speak",
				"Use contractions: 'I'll' not 'I will', 'you're' not 'you are'",
				"Limit product mentions to 2-3 max at once",
				"Typecheck passes"
			],
			"priority": 9,
			"passes": false,
			"ultrawork": false,
			"notes": ""
		},
		{
			"id": "US-010",
			"title": "Enable customer preferences capture in intent flow",
			"description": "As a business owner, I want customer preferences (dietary restrictions, delivery times) saved so I can provide personalized service.",
			"acceptanceCriteria": [
				"Add preference detection to intent classification (allergies, restrictions, preferences, behaviors)",
				"When preference detected, call api.ai.customerHistory.saveCustomerPreference",
				"Save with correct category: 'restriction', 'preference', 'behavior', 'allergy'",
				"Preferences persist to customerMemory table",
				"Test: 'I don't like spicy food' → saves as restriction",
				"Test: 'Prefer delivery in morning' → saves as preference",
				"Typecheck passes"
			],
			"priority": 10,
			"passes": false,
			"ultrawork": false,
			"notes": ""
		},
		{
			"id": "US-011",
			"title": "Generate conversation summaries after order completion",
			"description": "As a business owner, I want conversation summaries created automatically so I can review customer interactions.",
			"acceptanceCriteria": [
				"When conversation state changes to 'completed', trigger summary generation",
				"Call api.ai.summary.generateConversationSummary after successful order creation",
				"Summary includes: customer intent, products ordered, key preferences mentioned",
				"Summary saved to conversationSummaries table with conversationId link",
				"Summary includes order outcome: order number, total amount, payment method",
				"Typecheck passes"
			],
			"priority": 11,
			"passes": false,
			"ultrawork": false,
			"notes": ""
		}
	]
}
