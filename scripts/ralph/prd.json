{
  "projectName": "shopify-integration",
  "branchName": "feature/shopify-integration",
  "userStories": [
    {
      "id": "S01",
      "title": "Connect Shopify Store - OAuth Flow",
      "priority": 1,
      "passes": true,
      "ultrawork": true,
      "acceptanceCriteria": [
        "Settings page shows 'Connect Shopify' button at /settings/integrations/shopify",
        "Clicking initiates OAuth flow to Shopify via shopify.getAuthUrl mutation",
        "OAuth requests only necessary scopes: read_products, write_draft_orders, read_orders",
        "After authorization, redirect back to Echo with success message",
        "Connection status clearly shown (Connected / Not Connected)",
        "Store name and URL displayed when connected",
        "Can disconnect at any time via shopify.disconnect action",
        "BROWSER TEST: Navigate to /settings/integrations/shopify, verify Connect Shopify button visible",
        "BROWSER TEST: When connected, verify store name displays",
        "BROWSER TEST: Verify Disconnect button appears when connected"
      ]
    },
    {
      "id": "S02",
      "title": "Initial Product Import",
      "priority": 2,
      "passes": true,
      "ultrawork": true,
      "acceptanceCriteria": [
        "'Import Products' button appears after Shopify connection",
        "Progress indicator during import (loading spinner)",
        "Imports: title, description, price, images, variants, availability via shopify.importProducts action",
        "Each Shopify variant becomes a separate Echo product with shopifyVariantId",
        "Skips draft and archived products (status !== 'ACTIVE')",
        "Products marked with source: 'shopify' in Echo",
        "Import summary shown via toast: 'Imported X products, skipped Y'",
        "Handles stores with 1000+ products via paginated GraphQL queries",
        "BROWSER TEST: After connecting Shopify, verify Import Products button visible",
        "BROWSER TEST: Click Import, verify loading indicator shows",
        "BROWSER TEST: After import, verify success toast with counts"
      ]
    },
    {
      "id": "S03",
      "title": "Real-time Product Sync via Webhooks",
      "priority": 3,
      "passes": true,
      "ultrawork": true,
      "acceptanceCriteria": [
        "Register Shopify webhooks on connection: products/create, products/update, products/delete",
        "Webhook handler at /webhook/shopify HTTP route",
        "New products in Shopify appear in Echo within 1 minute",
        "Price changes sync within 1 minute via upsertProduct mutation",
        "Availability changes sync within 1 minute",
        "Deleted products marked as available: false in Echo (soft delete)",
        "Webhook signature verified via HMAC using SHOPIFY_API_SECRET",
        "Sync status and last sync time visible in settings via getConnectionStatus query",
        "BROWSER TEST: Navigate to Shopify settings, verify Last Sync timestamp displays",
        "BROWSER TEST: Verify sync status badge shows success/partial/failed"
      ]
    },
    {
      "id": "S04",
      "title": "Manual Resync",
      "priority": 4,
      "passes": false,
      "ultrawork": false,
      "acceptanceCriteria": [
        "'Sync Now' button in Shopify settings page",
        "Shows last successful sync timestamp from connectionStatus.lastSyncAt",
        "Progress indicator during sync (loading spinner on button)",
        "Summary toast: 'Updated X, Added Y, Removed Z' via syncProducts action",
        "Does not duplicate products (matches by shopifyProductId + shopifyVariantId)",
        "BROWSER TEST: Navigate to Shopify settings, verify Sync Now button",
        "BROWSER TEST: Click Sync Now, verify loading state on button",
        "BROWSER TEST: After sync, verify toast shows sync summary"
      ]
    },
    {
      "id": "S05",
      "title": "Create Draft Order for Payment",
      "priority": 5,
      "passes": false,
      "ultrawork": true,
      "acceptanceCriteria": [
        "When AI confirms order AND business has Shopify connected, create Draft Order",
        "shopify.createOrder action creates Draft Order via Shopify Admin API",
        "Draft Order includes line items with correct Shopify variant IDs",
        "Draft Order includes customer phone number from conversation",
        "Draft Order includes delivery address if delivery type",
        "Retrieve invoice_url from Draft Order response",
        "Send invoice_url to customer via WhatsApp as payment link",
        "Store shopifyDraftOrderId and shopifyOrderNumber on Echo order",
        "Draft Order visible in Shopify Admin immediately after creation"
      ]
    },
    {
      "id": "S06",
      "title": "Handle Shopify Payment Completion",
      "priority": 6,
      "passes": false,
      "ultrawork": true,
      "acceptanceCriteria": [
        "Register webhook: orders/paid on Shopify connection",
        "When payment completes, Shopify converts Draft Order to Order",
        "Webhook triggers Echo order status update to 'paid' via handleWebhook",
        "AI sends confirmation message via WhatsApp with order number",
        "shopifyOrderId and shopifyOrderNumber stored on Echo order via updateOrderWithShopifyInfo",
        "Handle partial payments gracefully (check payment status)"
      ]
    },
    {
      "id": "S07",
      "title": "Payment Method Routing",
      "priority": 7,
      "passes": false,
      "ultrawork": true,
      "acceptanceCriteria": [
        "Update payment link generation in AI order flow",
        "If business has Shopify connected → use Shopify Draft Orders via createOrder",
        "If business has Stripe configured (no Shopify) → use existing Stripe Checkout",
        "If neither configured → show error, prompt to set up payments",
        "Cash on delivery always works regardless of payment provider",
        "Payment provider choice transparent to customer (just receives a link)",
        "Add paymentProvider field to orders: 'stripe' | 'shopify' | 'cash'"
      ]
    },
    {
      "id": "S08",
      "title": "Handle Variants in Chat",
      "priority": 8,
      "passes": false,
      "ultrawork": true,
      "acceptanceCriteria": [
        "Update AI agent to detect when product has multiple variants",
        "When product has variants (size, color), AI asks clarifying question",
        "AI presents options: 'Which size? Small ($10), Medium ($12), Large ($14)'",
        "Customer's choice maps to correct Shopify variant ID",
        "Correct variant price used in order total calculation",
        "Draft Order created with correct variant via shopifyVariantId",
        "Handle case where variant is out of stock gracefully"
      ]
    },
    {
      "id": "S09",
      "title": "Disconnect Shopify",
      "priority": 9,
      "passes": false,
      "ultrawork": false,
      "acceptanceCriteria": [
        "'Disconnect' button with AlertDialog confirmation in Shopify settings",
        "Warning message: 'Products will remain but won't sync. Future orders will use Stripe.'",
        "Shopify webhooks unregistered via API calls in disconnect action",
        "OAuth token revoked by calling Shopify API",
        "Products remain in Echo with source: 'shopify' but converted to source: 'manual'",
        "Future orders use Stripe (if configured) or cash only",
        "Connection record deleted via deleteConnectionAndClearProducts mutation",
        "BROWSER TEST: Navigate to Shopify settings when connected",
        "BROWSER TEST: Click Disconnect, verify AlertDialog shows warning",
        "BROWSER TEST: Confirm disconnect, verify connection status updates"
      ]
    },
    {
      "id": "S10",
      "title": "View Shopify Order in Dashboard",
      "priority": 10,
      "passes": false,
      "ultrawork": false,
      "acceptanceCriteria": [
        "Order detail page shows Shopify order number if shopifyOrderNumber exists",
        "Link to open order in Shopify Admin: https://{shop}/admin/orders/{orderId}",
        "Payment status displayed based on paymentStatus field",
        "Show payment provider badge: 'Paid via Shopify' or 'Paid via Stripe'",
        "BROWSER TEST: Navigate to order paid via Shopify",
        "BROWSER TEST: Verify Shopify order number displays",
        "BROWSER TEST: Verify 'View in Shopify' link is clickable"
      ]
    }
  ]
}
