{
  "projectName": "whatsapp-integration",
  "branchName": "feature/whatsapp-integration",
  "userStories": [
    {
      "id": "S01",
      "title": "Create WhatsApp data model",
      "priority": 1,
      "passes": true,
      "ultrawork": true,
      "acceptanceCriteria": [
        "Create whatsappConnections table in schema with fields: businessId (Id<businesses>), provider (string), phoneNumberId (string), phoneNumber (string), credentials (object), verified (boolean), createdAt (number)",
        "Add index by_business on whatsappConnections [businessId]",
        "Add index by_phone on whatsappConnections [phoneNumber]",
        "Update conversations table: add channel (string), channelId (string), lastCustomerMessageAt (number)",
        "Update messages table: add externalId (string), deliveryStatus (string), mediaUrl (string), mediaType (string)"
      ]
    },
    {
      "id": "S02",
      "title": "Create BSP abstraction layer",
      "priority": 2,
      "passes": true,
      "ultrawork": true,
      "acceptanceCriteria": [
        "Create packages/backend/convex/integrations/whatsapp/types.ts with WhatsAppProvider interface",
        "Interface includes: sendText(to, message), sendImage(to, imageUrl, caption?), sendButtons(to, body, buttons), sendList(to, body, sections), parseWebhook(payload), verifyWebhook(payload, signature) methods",
        "Define Button type with id and title fields",
        "Define ListSection type with title and rows fields",
        "Define MessageResult type with success, messageId, error fields",
        "Define ParsedMessage type with from, content, timestamp, mediaUrl, mediaType, messageType fields",
        "Create packages/backend/convex/integrations/whatsapp/twilio.ts with TwilioWhatsAppProvider class implementing WhatsAppProvider interface"
      ]
    },
    {
      "id": "S03",
      "title": "Receive customer message via webhook",
      "priority": 3,
      "passes": false,
      "ultrawork": false,
      "acceptanceCriteria": [
        "Create HTTP POST endpoint at /webhook/whatsapp in packages/backend/convex/http.ts",
        "Create GET endpoint at /webhook/whatsapp for webhook verification (Meta/Twilio requirement)",
        "Verify webhook signature using WEBHOOK_VERIFY_TOKEN environment variable",
        "Parse message payload: sender phone, content, timestamp, media URL",
        "Look up business by incoming phone number using by_phone index on whatsappConnections",
        "Create whatsapp.processIncomingMessage internal mutation",
        "Create or find existing conversation for customer using channelId",
        "Store incoming message in messages table with sender: customer",
        "Handle message types: text, image, voice, document",
        "Return 200 OK response within 500ms to avoid webhook timeout"
      ]
    },
    {
      "id": "S04",
      "title": "Send text response to customer",
      "priority": 4,
      "passes": false,
      "ultrawork": false,
      "acceptanceCriteria": [
        "Create whatsapp.sendMessage action in packages/backend/convex/integrations/whatsapp/actions.ts",
        "Accept args: conversationId, content, type (text)",
        "Load business WhatsApp credentials from whatsappConnections table",
        "Send plain text message via Twilio WhatsApp API",
        "Handle rate limits with exponential backoff (max 3 retries)",
        "Store sent message in messages table with sender: business, externalId from API response",
        "Set initial deliveryStatus to sent"
      ]
    },
    {
      "id": "S05",
      "title": "Send rich messages with buttons and lists",
      "priority": 5,
      "passes": false,
      "ultrawork": false,
      "acceptanceCriteria": [
        "Extend whatsapp.sendMessage action to support type: buttons, list, image",
        "For buttons: send interactive button message (up to 3 buttons per WhatsApp limit)",
        "For list: send list message with sections for product selection",
        "For image: send image message with imageUrl and optional caption",
        "Implement fallback to plain text if rich message API call fails",
        "Store message type and content structure in messages table"
      ]
    },
    {
      "id": "S06",
      "title": "Handle WhatsApp 24-hour messaging window",
      "priority": 6,
      "passes": false,
      "ultrawork": false,
      "acceptanceCriteria": [
        "Update lastCustomerMessageAt on conversation when receiving customer message",
        "Create isWithin24HourWindow helper function checking if lastCustomerMessageAt is within 24 hours",
        "In sendMessage action: within 24h allow any message type",
        "After 24h: only allow sending approved message templates",
        "Create packages/backend/convex/integrations/whatsapp/templates.ts with at least one re-engagement template definition",
        "Add windowExpiresAt computed field to conversation queries"
      ]
    },
    {
      "id": "S07",
      "title": "Process webhook status updates",
      "priority": 7,
      "passes": false,
      "ultrawork": false,
      "acceptanceCriteria": [
        "Extend /webhook/whatsapp POST handler to detect status update payloads vs message payloads",
        "Parse status updates: sent, delivered, read, failed",
        "Create whatsapp.updateMessageStatus internal mutation",
        "Update message deliveryStatus in database by matching externalId",
        "Log failed message deliveries with error details for debugging"
      ]
    },
    {
      "id": "S08",
      "title": "Create WhatsApp connection settings page",
      "priority": 8,
      "passes": false,
      "ultrawork": false,
      "acceptanceCriteria": [
        "Create apps/web/src/routes/settings/whatsapp.tsx page",
        "Display current connection status with visual indicator (Connected: green, Not Connected: red)",
        "Show step-by-step instructions for BSP setup with link to Twilio WhatsApp docs",
        "Form with fields: provider dropdown (Twilio selected), Account SID, Auth Token, WhatsApp Phone Number",
        "Display webhook URL for copy-paste into BSP dashboard configuration",
        "Create whatsapp.saveCredentials mutation to store encrypted credentials",
        "Create whatsapp.testConnection action to verify credentials work",
        "Create whatsapp.getConnectionStatus query for current business",
        "Test Connection button triggers testConnection with success/error toast feedback",
        "Show last message received timestamp when connection is verified",
        "BROWSER TEST: Navigate to /settings/whatsapp, verify page renders",
        "BROWSER TEST: Connection status indicator is visible (green or red)",
        "BROWSER TEST: Form renders with provider dropdown and credential fields",
        "BROWSER TEST: Webhook URL is displayed in a copyable format",
        "BROWSER TEST: Test Connection button is present and clickable"
      ]
    }
  ]
}
