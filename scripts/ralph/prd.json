{
  "projectName": "shopify-sync",
  "branchName": "feature/shopify-sync",
  "userStories": [
    {
      "id": "S01",
      "title": "Create shopifyConnections schema table",
      "priority": 1,
      "passes": true,
      "ultrawork": true,
      "acceptanceCriteria": [
        "Create shopifyConnections table in packages/backend/convex/schema.ts",
        "Include businessId field (v.id('businesses')) - parent business reference",
        "Include shop field (v.string()) - mystore.myshopify.com",
        "Include accessToken field (v.string()) - encrypted OAuth token",
        "Include scopes field (v.array(v.string())) - granted OAuth scopes",
        "Include webhookIds field (v.optional(v.array(v.string()))) - registered webhook IDs",
        "Include lastSyncAt field (v.optional(v.number())) - last successful sync timestamp",
        "Include lastSyncStatus field (v.optional(v.union(v.literal('success'), v.literal('partial'), v.literal('failed'))))",
        "Include createdAt field (v.number()) - timestamp",
        "Add index by_business on shopifyConnections: [businessId]",
        "Add index by_shop on shopifyConnections: [shop] for webhook lookup",
        "Run npx convex dev to verify schema compiles without errors"
      ]
    },
    {
      "id": "S02",
      "title": "Extend products and orders tables with Shopify fields",
      "priority": 2,
      "passes": true,
      "ultrawork": true,
      "acceptanceCriteria": [
        "Update products table in packages/backend/convex/schema.ts",
        "Add source field (v.optional(v.union(v.literal('manual'), v.literal('shopify')))) - defaults to 'manual'",
        "Add shopifyProductId field (v.optional(v.string())) - Shopify product ID",
        "Add shopifyVariantId field (v.optional(v.string())) - Shopify variant ID if variant",
        "Add lastShopifySyncAt field (v.optional(v.number())) - when last synced from Shopify",
        "Add index by_shopify_id on products: [businessId, shopifyProductId] for sync lookup",
        "Update orders table in packages/backend/convex/schema.ts",
        "Add shopifyOrderId field (v.optional(v.string())) - created Shopify order ID",
        "Add shopifyOrderNumber field (v.optional(v.string())) - Shopify order number (#1001)",
        "Run npx convex dev to verify schema compiles without errors"
      ]
    },
    {
      "id": "S03",
      "title": "Add Shopify environment variables to env package",
      "priority": 3,
      "passes": true,
      "ultrawork": false,
      "acceptanceCriteria": [
        "Update packages/env/src/server.ts to add Shopify env vars",
        "Add SHOPIFY_API_KEY (z.string()) - Shopify app client ID",
        "Add SHOPIFY_API_SECRET (z.string().min(32)) - Shopify app secret",
        "Add SHOPIFY_SCOPES (z.string().default('read_products,write_orders,read_orders')) - comma-separated scopes",
        "Update packages/backend/.env.local.example with placeholder values",
        "Document required scopes: read_products, write_orders, read_orders"
      ]
    },
    {
      "id": "S04",
      "title": "Implement Shopify OAuth URL generation mutation",
      "priority": 4,
      "passes": true,
      "ultrawork": false,
      "acceptanceCriteria": [
        "Create packages/backend/convex/shopify.ts file",
        "Create shopify.getAuthUrl mutation",
        "Args: businessId (Id<businesses>), shop (string - the myshopify.com URL)",
        "Require authentication - validate caller owns the business",
        "Generate state parameter for CSRF protection (random string stored temporarily)",
        "Build OAuth URL: https://{shop}/admin/oauth/authorize?client_id=X&scope=Y&redirect_uri=Z&state=W",
        "Redirect URI should be: {CONVEX_SITE_URL}/shopify/callback",
        "Return the authorization URL",
        "Handle invalid shop format (must end in .myshopify.com)"
      ]
    },
    {
      "id": "S05",
      "title": "Implement Shopify OAuth callback handler",
      "priority": 5,
      "passes": true,
      "ultrawork": true,
      "acceptanceCriteria": [
        "Create shopify.handleCallback mutation in packages/backend/convex/shopify.ts",
        "Args: code (string), shop (string), state (string), businessId (Id<businesses>)",
        "Verify state parameter matches stored state (CSRF protection)",
        "Exchange authorization code for access token via Shopify API",
        "POST to https://{shop}/admin/oauth/access_token with client_id, client_secret, code",
        "Store access token securely in shopifyConnections table",
        "Store granted scopes from response",
        "Return connection status (success/failure)",
        "Handle errors: invalid code, expired code, network failures"
      ]
    },
    {
      "id": "S06",
      "title": "Create Shopify OAuth HTTP route",
      "priority": 6,
      "passes": true,
      "ultrawork": false,
      "acceptanceCriteria": [
        "Update packages/backend/convex/http.ts to add Shopify callback route",
        "Add GET route: /shopify/callback",
        "Extract query params: code, shop, state",
        "Call shopify.handleCallback mutation with extracted params",
        "On success: redirect to /settings/integrations/shopify?connected=true",
        "On failure: redirect to /settings/integrations/shopify?error=auth_failed",
        "Handle missing params gracefully"
      ]
    },
    {
      "id": "S07",
      "title": "Create integrations settings page",
      "priority": 7,
      "passes": true,
      "ultrawork": false,
      "acceptanceCriteria": [
        "Create apps/web/src/routes/settings/integrations/index.tsx",
        "Create route as protected (requires auth)",
        "Page title: 'Integrations'",
        "Display list of available integrations (for now just Shopify)",
        "Shopify card shows: logo, name, brief description, connection status",
        "If not connected: show 'Connect' button",
        "If connected: show green 'Connected' badge",
        "Click card navigates to /settings/integrations/shopify",
        "Use existing settings layout/navigation pattern",
        "BROWSER TEST: Navigate to /settings/integrations, verify page renders",
        "BROWSER TEST: Verify Shopify integration card is visible",
        "BROWSER TEST: Click Shopify card, verify navigation to /settings/integrations/shopify"
      ]
    },
    {
      "id": "S08",
      "title": "Create Shopify settings page with Connect button",
      "priority": 8,
      "passes": true,
      "ultrawork": false,
      "acceptanceCriteria": [
        "Create apps/web/src/routes/settings/integrations/shopify.tsx",
        "Create route as protected (requires auth)",
        "Page title: 'Shopify Integration'",
        "Create shopify.getConnectionStatus query to check if connected",
        "If not connected: show 'Connect Shopify' button and shop URL input",
        "Shop URL input: text field for entering store name (e.g., 'mystore' or 'mystore.myshopify.com')",
        "Normalize input to always be full myshopify.com URL",
        "Connect button calls shopify.getAuthUrl and redirects to returned OAuth URL",
        "Show loading state during OAuth redirect",
        "BROWSER TEST: Navigate to /settings/integrations/shopify when not connected",
        "BROWSER TEST: Verify shop URL input and Connect button are visible",
        "BROWSER TEST: Enter shop URL, verify input accepts text"
      ]
    },
    {
      "id": "S09",
      "title": "Display Shopify connection status and options",
      "priority": 9,
      "passes": true,
      "ultrawork": false,
      "acceptanceCriteria": [
        "Update Shopify settings page to show connected state",
        "When connected: display store URL (e.g., myburgerplace.myshopify.com)",
        "Show connection status: green checkmark with 'Connected'",
        "Show last sync timestamp with relative time (e.g., '2 hours ago')",
        "Show sync status badge: success (green), partial (yellow), failed (red)",
        "Display options section with checkboxes (UI only for now, actual implementation later)",
        "Checkbox: 'Auto-sync products when changed in Shopify' (default checked)",
        "Checkbox: 'Create orders in Shopify' (default checked)",
        "Checkbox: 'Sync order status back to Shopify' (default unchecked)",
        "BROWSER TEST: When connected, verify store URL displays",
        "BROWSER TEST: Verify last sync timestamp shows",
        "BROWSER TEST: Verify options checkboxes are visible"
      ]
    },
    {
      "id": "S10",
      "title": "Implement initial product import mutation",
      "priority": 10,
      "passes": true,
      "ultrawork": true,
      "acceptanceCriteria": [
        "Create shopify.importProducts action in packages/backend/convex/shopify.ts",
        "Args: businessId (Id<businesses>)",
        "Require authentication and validate caller owns business",
        "Fetch Shopify connection from shopifyConnections table",
        "Use Shopify Admin GraphQL API to fetch all products",
        "Query products with: title, description, images, variants (price, sku, available)",
        "Handle pagination (Shopify limits to 250 products per request)",
        "For each product/variant: check if already exists by shopifyProductId",
        "If exists: update existing product",
        "If new: create new product with source='shopify'",
        "Map Shopify fields: title->name, body_html->description, images[0]->imageUrl, variant.price->price (convert to cents)",
        "Skip draft and archived products (status != 'active')",
        "Track import statistics: imported count, skipped count, error count",
        "Update lastSyncAt and lastSyncStatus on shopifyConnections",
        "Return import summary: { imported: number, skipped: number, errors: string[] }"
      ]
    },
    {
      "id": "S11",
      "title": "Create product import UI with progress",
      "priority": 11,
      "passes": true,
      "ultrawork": false,
      "acceptanceCriteria": [
        "Add 'Import Products' button to Shopify settings page (visible after connection)",
        "Button disabled if import already in progress",
        "Clicking button calls shopify.importProducts action",
        "Show progress indicator during import (spinner or progress bar)",
        "After import completes: show summary dialog/toast",
        "Summary shows: X products imported, X skipped, X errors",
        "If errors: show expandable error details",
        "Add 'View Products' link to navigate to product list",
        "BROWSER TEST: Verify Import Products button is visible when connected",
        "BROWSER TEST: Click Import Products, verify progress indicator shows",
        "BROWSER TEST: After import, verify summary toast appears"
      ]
    },
    {
      "id": "S12",
      "title": "Create Shopify webhook HTTP route",
      "priority": 12,
      "passes": true,
      "ultrawork": true,
      "acceptanceCriteria": [
        "Add POST route /webhook/shopify to packages/backend/convex/http.ts",
        "Extract shop domain from X-Shopify-Shop-Domain header",
        "Extract topic from X-Shopify-Topic header (e.g., 'products/update')",
        "Verify webhook signature using HMAC-SHA256 with SHOPIFY_API_SECRET",
        "Compare computed HMAC with X-Shopify-Hmac-SHA256 header",
        "If signature invalid: return 401 Unauthorized",
        "Parse JSON body for webhook payload",
        "Route to appropriate handler based on topic",
        "Return 200 OK immediately (process async to avoid timeout)",
        "Log webhook receipt for debugging"
      ]
    },
    {
      "id": "S13",
      "title": "Implement product webhook handlers",
      "priority": 13,
      "passes": true,
      "ultrawork": true,
      "acceptanceCriteria": [
        "Create shopify.handleWebhook action in packages/backend/convex/shopify.ts",
        "Args: topic (string), shop (string), data (webhook payload object)",
        "Handle 'products/create' topic: create new product in Echo",
        "Handle 'products/update' topic: update existing product by shopifyProductId",
        "Handle 'products/delete' topic: mark product as unavailable (don't hard delete)",
        "Look up business by shop domain in shopifyConnections",
        "Map webhook data to product fields same as import",
        "Update lastShopifySyncAt on affected products",
        "Handle variant changes within products/update",
        "Log sync operations for debugging",
        "Handle errors gracefully - don't crash on malformed data"
      ]
    },
    {
      "id": "S14",
      "title": "Register Shopify webhook subscriptions",
      "priority": 14,
      "passes": true,
      "ultrawork": false,
      "acceptanceCriteria": [
        "Create shopify.registerWebhooks internal function",
        "Call after successful OAuth connection",
        "Register webhooks via Shopify Admin API POST /admin/api/2024-01/webhooks.json",
        "Subscribe to topics: products/create, products/update, products/delete",
        "Webhook address: {CONVEX_SITE_URL}/webhook/shopify",
        "Store returned webhook IDs in shopifyConnections.webhookIds",
        "Handle already-registered webhooks (idempotent)",
        "Log registration success/failure"
      ]
    },
    {
      "id": "S15",
      "title": "Create sync status UI component",
      "priority": 15,
      "passes": true,
      "ultrawork": false,
      "acceptanceCriteria": [
        "Create apps/web/src/components/shopify/SyncStatus.tsx component",
        "Props: lastSyncAt (number | null), status ('success' | 'partial' | 'failed' | null)",
        "Display last sync time in relative format (e.g., '5 minutes ago')",
        "Display status icon: green check (success), yellow warning (partial), red X (failed)",
        "Tooltip with absolute timestamp on hover",
        "Show 'Never synced' if lastSyncAt is null",
        "Integrate component into Shopify settings page",
        "BROWSER TEST: Render SyncStatus with success status, verify green icon",
        "BROWSER TEST: Render SyncStatus with never synced, verify 'Never synced' text"
      ]
    },
    {
      "id": "S16",
      "title": "Implement manual resync mutation",
      "priority": 16,
      "passes": false,
      "ultrawork": false,
      "acceptanceCriteria": [
        "Create shopify.syncProducts action in packages/backend/convex/shopify.ts",
        "Args: businessId (Id<businesses>)",
        "Require authentication and validate caller owns business",
        "Fetch all products from Shopify API",
        "Compare with existing products by shopifyProductId",
        "Update changed products (price, availability, name, description)",
        "Add new products that don't exist in Echo",
        "Mark deleted products as unavailable",
        "Track sync statistics: updated count, added count, removed count",
        "Update lastSyncAt and lastSyncStatus on shopifyConnections",
        "Return sync summary: { updated: number, added: number, removed: number }"
      ]
    },
    {
      "id": "S17",
      "title": "Create manual resync UI",
      "priority": 17,
      "passes": false,
      "ultrawork": false,
      "acceptanceCriteria": [
        "Add 'Sync Now' button to Shopify settings page",
        "Button visible only when connected",
        "Button shows loading spinner during sync",
        "Clicking calls shopify.syncProducts action",
        "After sync: show toast with summary",
        "Summary shows: X updated, X added, X removed",
        "Update SyncStatus component with new timestamp",
        "Disable button during sync to prevent double-clicks",
        "BROWSER TEST: Verify Sync Now button visible when connected",
        "BROWSER TEST: Click Sync Now, verify loading state",
        "BROWSER TEST: After sync, verify toast shows summary"
      ]
    },
    {
      "id": "S18",
      "title": "Implement variant handling in import",
      "priority": 18,
      "passes": false,
      "ultrawork": true,
      "acceptanceCriteria": [
        "Update shopify.importProducts to handle product variants properly",
        "Strategy: import each variant as a separate product in Echo",
        "Product name format: '{Product Title} - {Variant Title}' (e.g., 'T-Shirt - Large Blue')",
        "Each variant gets unique shopifyVariantId stored",
        "Skip variants with null/empty title (use just product title)",
        "Map variant.price to product price",
        "Map variant.inventory_quantity for availability (available if > 0)",
        "Store parent shopifyProductId on all variants for grouping",
        "Handle single-variant products (don't add '- Default' suffix)",
        "Update shopify.handleWebhook to handle variant changes"
      ]
    },
    {
      "id": "S19",
      "title": "Implement create order in Shopify mutation",
      "priority": 19,
      "passes": false,
      "ultrawork": true,
      "acceptanceCriteria": [
        "Create shopify.createOrder action in packages/backend/convex/shopify.ts",
        "Args: orderId (Id<orders>)",
        "Fetch order from Echo database with line items",
        "Fetch Shopify connection for the order's business",
        "Build Shopify order payload with: customer info, line items (variant IDs), shipping address",
        "POST to Shopify Admin API: /admin/api/2024-01/orders.json",
        "Map Echo line items to Shopify line items using shopifyVariantId",
        "Handle products without shopifyVariantId (manual products) - skip or error",
        "Store returned Shopify order ID and order number in Echo order",
        "Handle errors gracefully: if Shopify fails, Echo order still works",
        "Log Shopify order creation for debugging",
        "Return { success: boolean, shopifyOrderId: string | null, error: string | null }"
      ]
    },
    {
      "id": "S20",
      "title": "Trigger Shopify order creation on Echo order confirmation",
      "priority": 20,
      "passes": false,
      "ultrawork": false,
      "acceptanceCriteria": [
        "Update order confirmation flow to trigger Shopify order creation",
        "When Echo order status changes to 'confirmed', check if business has Shopify connection",
        "If connected and 'Create orders in Shopify' option enabled, call shopify.createOrder",
        "Run asynchronously (don't block order confirmation)",
        "Update order with shopifyOrderId and shopifyOrderNumber when created",
        "Show Shopify order link in order details if shopifyOrderId exists",
        "Handle partial failures: Echo order is source of truth"
      ]
    },
    {
      "id": "S21",
      "title": "Implement disconnect Shopify mutation",
      "priority": 21,
      "passes": false,
      "ultrawork": false,
      "acceptanceCriteria": [
        "Create shopify.disconnect mutation in packages/backend/convex/shopify.ts",
        "Args: businessId (Id<businesses>)",
        "Require authentication and validate caller owns business",
        "Unsubscribe from all webhooks via Shopify API DELETE /admin/api/2024-01/webhooks/{id}.json",
        "Revoke access token via Shopify API DELETE /admin/api/2024-01/access_tokens/current.json",
        "Delete shopifyConnections record for this business",
        "Update all products with source='shopify' to source='manual' (products remain)",
        "Clear shopifyProductId and shopifyVariantId fields",
        "Return { success: boolean }"
      ]
    },
    {
      "id": "S22",
      "title": "Create disconnect UI with confirmation",
      "priority": 22,
      "passes": false,
      "ultrawork": false,
      "acceptanceCriteria": [
        "Add 'Disconnect' button to Shopify settings page",
        "Button visible only when connected",
        "Button styled as destructive (red/warning)",
        "Clicking opens confirmation dialog",
        "Dialog explains impact: 'Products will remain but sync will stop. You can reconnect anytime.'",
        "Dialog has Cancel and Disconnect buttons",
        "On confirm: call shopify.disconnect mutation",
        "Show loading state during disconnect",
        "On success: redirect to /settings/integrations or update page to disconnected state",
        "Show success toast: 'Shopify disconnected successfully'",
        "BROWSER TEST: Verify Disconnect button visible when connected",
        "BROWSER TEST: Click Disconnect, verify confirmation dialog appears",
        "BROWSER TEST: Verify dialog explains impact",
        "BROWSER TEST: Click Cancel in dialog, verify dialog closes without action"
      ]
    }
  ]
}
