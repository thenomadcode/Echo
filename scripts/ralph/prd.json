{
  "projectName": "order-flow",
  "branchName": "feature/order-flow",
  "userStories": [
    {
      "id": "S01",
      "title": "Create orders schema and data model",
      "priority": 1,
      "passes": true,
      "ultrawork": true,
      "acceptanceCriteria": [
        "Create orders table in packages/backend/convex/schema.ts",
        "Include fields: businessId (Id<businesses>), conversationId (Id<conversations>), orderNumber (string), status (string), items (array), subtotal (number), deliveryFee (optional number), total (number), currency (string), deliveryType (string), deliveryAddress (optional string), deliveryNotes (optional string), contactPhone (string), contactName (optional string), paymentMethod (string), paymentStatus (string), paymentLinkUrl (optional string), paymentLinkExpiresAt (optional number), stripeSessionId (optional string), estimatedReadyTime (optional number), notes (optional string), createdAt (number), updatedAt (number), cancelledAt (optional number), cancellationReason (optional string)",
        "Status field supports: draft, confirmed, paid, preparing, ready, delivered, cancelled",
        "Payment status supports: pending, paid, failed, refunded",
        "Delivery type supports: delivery, pickup",
        "Payment method supports: card, cash",
        "Items is array of objects with: productId (Id<products>), name (string), quantity (number), unitPrice (number), totalPrice (number)",
        "Create index by_business on orders: [businessId, status, createdAt]",
        "Create index by_conversation on orders: [conversationId]",
        "Create index by_number on orders: [orderNumber]",
        "Create index by_payment_session on orders: [stripeSessionId]",
        "Run npx convex dev to verify schema compiles without errors"
      ]
    },
    {
      "id": "S02",
      "title": "Create order number generation utility",
      "priority": 2,
      "passes": true,
      "ultrawork": false,
      "acceptanceCriteria": [
        "Create packages/backend/convex/lib/orderNumber.ts",
        "Create generateOrderNumber function accepting businessId and db context",
        "Query business to get business name or prefix",
        "Derive 3-letter prefix from business name (first 3 letters uppercase)",
        "Query max existing order number for this business",
        "Generate next sequential number, 6 digits zero-padded",
        "Format: ORD-{prefix}-{number} (e.g., ORD-BUR-001234)",
        "Handle concurrent order creation safely (query then create pattern)"
      ]
    },
    {
      "id": "S03",
      "title": "Create orders.create mutation",
      "priority": 3,
      "passes": true,
      "ultrawork": false,
      "acceptanceCriteria": [
        "Create packages/backend/convex/orders.ts with orders.create mutation",
        "Args: businessId (Id<businesses>), conversationId (Id<conversations>), items (array of {productId, quantity}), contactPhone (string)",
        "Validate business exists",
        "Validate all products exist and belong to the business",
        "Look up product prices and names server-side",
        "Calculate unitPrice and totalPrice for each item",
        "Calculate subtotal as sum of all totalPrice values",
        "Generate unique orderNumber using the utility",
        "Create order with status 'draft', paymentStatus 'pending'",
        "Set createdAt and updatedAt to Date.now()",
        "Return the created order ID"
      ]
    },
    {
      "id": "S04",
      "title": "Create order item mutations",
      "priority": 4,
      "passes": true,
      "ultrawork": false,
      "acceptanceCriteria": [
        "Create orders.addItem mutation in packages/backend/convex/orders.ts",
        "Args: orderId, productId, quantity (default 1)",
        "Validate order exists and is in 'draft' status",
        "Validate product exists and belongs to order's business",
        "Look up product price server-side",
        "Add item to items array or increment quantity if exists",
        "Recalculate subtotal and total",
        "Create orders.removeItem mutation",
        "Args: orderId, productId",
        "Remove item from items array",
        "Recalculate subtotal and total",
        "Create orders.updateItemQuantity mutation",
        "Args: orderId, productId, quantity",
        "Update quantity of existing item, remove if quantity <= 0",
        "All mutations update updatedAt timestamp"
      ]
    },
    {
      "id": "S05",
      "title": "Create order delivery mutation",
      "priority": 5,
      "passes": true,
      "ultrawork": false,
      "acceptanceCriteria": [
        "Create orders.setDeliveryInfo mutation in packages/backend/convex/orders.ts",
        "Args: orderId, deliveryType (delivery|pickup), deliveryAddress (optional), deliveryNotes (optional), contactPhone (optional)",
        "Validate order exists",
        "If deliveryType is 'delivery', deliveryAddress is required",
        "If deliveryType is 'pickup', clear deliveryAddress",
        "Update deliveryType, deliveryAddress, deliveryNotes fields",
        "Update contactPhone if provided",
        "Update updatedAt timestamp"
      ]
    },
    {
      "id": "S06",
      "title": "Create order payment method mutation",
      "priority": 6,
      "passes": true,
      "ultrawork": false,
      "acceptanceCriteria": [
        "Create orders.setPaymentMethod mutation in packages/backend/convex/orders.ts",
        "Args: orderId, paymentMethod (card|cash)",
        "Validate order exists",
        "Update paymentMethod field",
        "If 'cash' selected, update status to 'confirmed' (ready for fulfillment)",
        "If 'card' selected, keep status as 'draft' (awaiting payment)",
        "Update updatedAt timestamp"
      ]
    },
    {
      "id": "S07",
      "title": "Create order cancel mutation",
      "priority": 7,
      "passes": true,
      "ultrawork": false,
      "acceptanceCriteria": [
        "Create orders.cancel mutation in packages/backend/convex/orders.ts",
        "Args: orderId, reason (optional string)",
        "Validate order exists",
        "Only allow cancellation if status is 'draft' or 'confirmed'",
        "If status is 'paid' or later, throw error 'Order already paid, requires manual refund'",
        "Update status to 'cancelled'",
        "Set cancelledAt to Date.now()",
        "Store cancellationReason if provided",
        "Update updatedAt timestamp"
      ]
    },
    {
      "id": "S08",
      "title": "Create order status update mutations",
      "priority": 8,
      "passes": false,
      "ultrawork": false,
      "acceptanceCriteria": [
        "Create orders.markPreparing mutation - transitions from confirmed/paid to preparing",
        "Create orders.markReady mutation - transitions from preparing to ready",
        "Create orders.markDelivered mutation - transitions from ready to delivered",
        "All mutations validate order exists and current status allows transition",
        "All mutations update updatedAt timestamp",
        "Return updated order"
      ]
    },
    {
      "id": "S09",
      "title": "Create order queries",
      "priority": 9,
      "passes": false,
      "ultrawork": false,
      "acceptanceCriteria": [
        "Create orders.get query in packages/backend/convex/orders.ts",
        "Args: orderId - returns single order or null",
        "Create orders.getByConversation query",
        "Args: conversationId - returns most recent order for conversation",
        "Create orders.getByOrderNumber query",
        "Args: orderNumber - returns order by human-readable number",
        "Create orders.listByBusiness query",
        "Args: businessId, status (optional filter), limit (default 50), cursor (optional)",
        "Return orders sorted by createdAt descending",
        "Support cursor-based pagination",
        "All queries validate caller has access to business"
      ]
    },
    {
      "id": "S10",
      "title": "Add payment environment variables",
      "priority": 10,
      "passes": false,
      "ultrawork": false,
      "acceptanceCriteria": [
        "Update packages/env/src/server.ts with payment provider env vars",
        "Add STRIPE_SECRET_KEY (z.string().optional())",
        "Add STRIPE_WEBHOOK_SECRET (z.string().optional())",
        "Add STRIPE_PUBLISHABLE_KEY (z.string().optional())",
        "Update packages/backend/.env.local.example with placeholder values",
        "Add comment explaining these are optional until payment is configured"
      ]
    },
    {
      "id": "S11",
      "title": "Create payment link generation action",
      "priority": 11,
      "passes": false,
      "ultrawork": true,
      "acceptanceCriteria": [
        "Create orders.generatePaymentLink action in packages/backend/convex/orders.ts",
        "Args: orderId",
        "Validate order exists and has items",
        "Validate order status is 'draft' or payment link expired",
        "Use Stripe API to create checkout session with order items as line items",
        "Set currency from order.currency",
        "Include orderId in session metadata for webhook reconciliation",
        "Set success_url and cancel_url to appropriate pages",
        "Store stripeSessionId on order",
        "Store paymentLinkUrl (session.url) on order",
        "Set paymentLinkExpiresAt to 24 hours from now",
        "Return the payment link URL",
        "Handle Stripe API errors gracefully with descriptive error messages"
      ]
    },
    {
      "id": "S12",
      "title": "Create Stripe webhook handler",
      "priority": 12,
      "passes": false,
      "ultrawork": true,
      "acceptanceCriteria": [
        "Create packages/backend/convex/http.ts if not exists, or update existing",
        "Add HTTP route POST /webhook/stripe",
        "Verify webhook signature using STRIPE_WEBHOOK_SECRET",
        "Return 400 if signature verification fails",
        "Handle checkout.session.completed event",
        "Look up order by stripeSessionId from session metadata",
        "Update order status to 'paid' and paymentStatus to 'paid'",
        "Handle checkout.session.expired event - update paymentStatus to 'failed'",
        "Handle payment_intent.payment_failed - update paymentStatus to 'failed'",
        "Return 200 OK for all successfully processed events",
        "Return 200 OK for unknown event types (acknowledge but ignore)",
        "Log webhook events for debugging"
      ]
    },
    {
      "id": "S13",
      "title": "Create orders list dashboard page",
      "priority": 13,
      "passes": false,
      "ultrawork": false,
      "acceptanceCriteria": [
        "Create apps/web/src/routes/dashboard/orders/index.tsx",
        "Create route as protected (requires auth)",
        "Fetch orders using orders.listByBusiness query",
        "Display orders in table with columns: Order #, Status, Items Count, Total, Date",
        "Add status badge with color coding (draft=gray, confirmed=blue, paid=green, preparing=yellow, ready=orange, delivered=teal, cancelled=red)",
        "Add status filter dropdown (All, Draft, Confirmed, Paid, Preparing, Ready, Delivered, Cancelled)",
        "Sort by date newest first",
        "Show pagination controls if more than 50 orders",
        "Click row navigates to order detail page",
        "Show empty state with message when no orders",
        "BROWSER TEST: Navigate to /dashboard/orders, verify page renders without errors",
        "BROWSER TEST: Verify table headers display (Order #, Status, Items, Total, Date)",
        "BROWSER TEST: Verify status filter dropdown is visible",
        "BROWSER TEST: Verify clicking an order row navigates to detail page"
      ]
    },
    {
      "id": "S14",
      "title": "Create order detail dashboard page",
      "priority": 14,
      "passes": false,
      "ultrawork": false,
      "acceptanceCriteria": [
        "Create apps/web/src/routes/dashboard/orders/$orderId.tsx",
        "Create route as protected (requires auth)",
        "Fetch order using orders.get query with orderId from params",
        "Display order header: Order # and status badge",
        "Display order timestamps: Created, Updated, Cancelled (if applicable)",
        "Display items section: table with Product Name, Quantity, Unit Price, Total Price",
        "Display subtotal, delivery fee (if any), and grand total",
        "Display delivery section: Type (Delivery/Pickup), Address, Notes",
        "Display customer section: Phone, Name (if any)",
        "Display payment section: Method, Status, Payment Link (if card)",
        "Add status action buttons based on current status (Mark Preparing, Mark Ready, Mark Delivered)",
        "Add Cancel Order button (visible only if cancellable)",
        "Show 404 page if order not found",
        "BROWSER TEST: Navigate to order detail page, verify all sections render",
        "BROWSER TEST: Verify items table displays correctly with prices",
        "BROWSER TEST: Verify status action buttons are visible based on status",
        "BROWSER TEST: Verify customer and delivery info sections render"
      ]
    },
    {
      "id": "S15",
      "title": "Add order status action handlers to detail page",
      "priority": 15,
      "passes": false,
      "ultrawork": false,
      "acceptanceCriteria": [
        "Wire up Mark Preparing button to orders.markPreparing mutation",
        "Wire up Mark Ready button to orders.markReady mutation",
        "Wire up Mark Delivered button to orders.markDelivered mutation",
        "Wire up Cancel Order button to orders.cancel mutation with confirmation dialog",
        "Show toast notification on success",
        "Show toast error on failure",
        "Refetch order data after mutation success",
        "Disable buttons while mutation is in progress",
        "BROWSER TEST: Click a status action button, verify toast appears",
        "BROWSER TEST: Verify buttons are disabled during loading state"
      ]
    }
  ]
}
