{
  "projectName": "conversation-dashboard",
  "branchName": "feature/conversation-dashboard",
  "userStories": [
    {
      "id": "S01",
      "title": "Update conversations schema for dashboard features",
      "priority": 1,
      "passes": true,
      "ultrawork": true,
      "acceptanceCriteria": [
        "Update conversations table in packages/backend/convex/schema.ts",
        "Add assignedTo field (v.optional(v.id('users'))) - null means AI handling, user ID means human assigned",
        "Add status field (v.union(v.literal('active'), v.literal('escalated'), v.literal('closed')))",
        "Add escalationReason field (v.optional(v.string())) - reason why AI escalated",
        "Add lastReadAt field (v.optional(v.number())) - for unread indicator",
        "Add closedAt field (v.optional(v.number())) - when conversation was closed",
        "Add index by_business_status on conversations: [businessId, status]",
        "Add index by_status on conversations: [status]",
        "Run npx convex dev to verify schema compiles without errors"
      ]
    },
    {
      "id": "S02",
      "title": "Create notifications table schema",
      "priority": 2,
      "passes": true,
      "ultrawork": false,
      "acceptanceCriteria": [
        "Create notifications table in packages/backend/convex/schema.ts",
        "Include _id (Id) field - Convex document ID",
        "Include userId (v.id('users')) field - notification recipient",
        "Include type (v.union(v.literal('escalation'), v.literal('new_order'))) field",
        "Include conversationId (v.id('conversations')) field - related conversation",
        "Include read (v.boolean()) field - has user seen it",
        "Include createdAt (v.number()) field - timestamp",
        "Add index by_user on notifications: [userId, read, createdAt]",
        "Run npx convex dev to verify schema compiles without errors"
      ]
    },
    {
      "id": "S03",
      "title": "Create conversation list query with filtering",
      "priority": 3,
      "passes": true,
      "ultrawork": false,
      "acceptanceCriteria": [
        "Create conversations.list query in packages/backend/convex/conversations.ts",
        "Args: businessId (Id<businesses>), status (optional filter), search (optional string), limit (default 50), cursor (optional)",
        "Return conversations sorted by last activity (most recent first)",
        "Escalated conversations appear at top regardless of activity time",
        "Each conversation includes: customer name/phone, last message preview, timestamp, status, assignedTo",
        "Support pagination with cursor",
        "Filter by status when status arg provided (active, escalated, closed)",
        "Search by customer phone or name when search term provided",
        "Include unread indicator (messages after lastReadAt)",
        "Validate caller has access to the business"
      ]
    },
    {
      "id": "S04",
      "title": "Create conversation detail and messages queries",
      "priority": 4,
      "passes": true,
      "ultrawork": false,
      "acceptanceCriteria": [
        "Create conversations.get query returning full conversation details",
        "Args: conversationId (Id<conversations>)",
        "Return conversation with all fields including escalationReason, assignedTo, status",
        "Include customer info (name, phone)",
        "Include related order info if an order exists for this conversation",
        "Create conversations.messages query with pagination",
        "Args: conversationId (Id<conversations>), limit (default 100), cursor (optional)",
        "Return messages with: sender type (customer/ai/human), content, timestamp, mediaUrl (if any)",
        "Sort messages by createdAt ascending (oldest first)",
        "Support cursor-based pagination for message history",
        "Validate caller has access to the conversation's business"
      ]
    },
    {
      "id": "S05",
      "title": "Create take over and hand back mutations",
      "priority": 5,
      "passes": true,
      "ultrawork": true,
      "acceptanceCriteria": [
        "Create conversations.takeOver mutation in packages/backend/convex/conversations.ts",
        "Args: conversationId (Id<conversations>)",
        "Require authentication - get current user from ctx",
        "Validate user owns or has access to the conversation's business",
        "Set assignedTo to current user's ID",
        "If status was 'escalated', change to 'active' (clear escalation)",
        "Update lastReadAt to current timestamp",
        "Create conversations.handBack mutation",
        "Args: conversationId (Id<conversations>)",
        "Require authentication",
        "Validate conversation is currently assigned to this user",
        "Set assignedTo to null (AI resumes handling)",
        "Keep status as 'active'",
        "Both mutations return the updated conversation"
      ]
    },
    {
      "id": "S06",
      "title": "Create close and reopen mutations",
      "priority": 6,
      "passes": true,
      "ultrawork": false,
      "acceptanceCriteria": [
        "Create conversations.close mutation in packages/backend/convex/conversations.ts",
        "Args: conversationId (Id<conversations>)",
        "Require authentication",
        "Validate user has access to conversation's business",
        "Set status to 'closed'",
        "Set closedAt to Date.now()",
        "Create conversations.reopen mutation",
        "Args: conversationId (Id<conversations>)",
        "Set status to 'active'",
        "Clear closedAt field",
        "Both mutations return the updated conversation"
      ]
    },
    {
      "id": "S07",
      "title": "Create send message as human mutation",
      "priority": 7,
      "passes": true,
      "ultrawork": true,
      "acceptanceCriteria": [
        "Create messages.sendAsHuman mutation in packages/backend/convex/messages.ts",
        "Args: conversationId (Id<conversations>), content (string), mediaUrl (optional string)",
        "Require authentication",
        "Validate conversation exists and is assigned to current user",
        "Save message to messages table with sender type 'human'",
        "Include userId of the human sender",
        "Set createdAt to Date.now()",
        "Trigger WhatsApp send via existing WhatsApp integration (call action/internal function)",
        "Return the created message ID",
        "Handle WhatsApp send failure gracefully - still save message but mark delivery status as failed"
      ]
    },
    {
      "id": "S08",
      "title": "Create notification mutations and queries",
      "priority": 8,
      "passes": true,
      "ultrawork": false,
      "acceptanceCriteria": [
        "Create notifications.create internal mutation in packages/backend/convex/notifications.ts",
        "Args: userId, type, conversationId",
        "Create notification record with read: false",
        "Create notifications.list query",
        "Args: limit (default 20)",
        "Return user's notifications sorted by createdAt descending",
        "Require authentication to get current user",
        "Create notifications.markRead mutation",
        "Args: notificationId (Id<notifications>)",
        "Set read to true",
        "Create notifications.markAllRead mutation",
        "Mark all user's notifications as read",
        "Create notifications.unreadCount query returning count of unread notifications"
      ]
    },
    {
      "id": "S09",
      "title": "Create StatusBadge and MessageBubble components",
      "priority": 9,
      "passes": true,
      "ultrawork": false,
      "acceptanceCriteria": [
        "Create apps/web/src/components/conversation/StatusBadge.tsx",
        "Props: status ('active' | 'escalated' | 'closed'), assignedTo (optional)",
        "Display 'AI Handling' (green) when status=active and assignedTo=null",
        "Display 'Human Active' (blue) when assignedTo is set",
        "Display 'Escalated' (red) when status=escalated",
        "Display 'Closed' (gray) when status=closed",
        "Create apps/web/src/components/conversation/MessageBubble.tsx",
        "Props: message object with sender, content, timestamp, mediaUrl",
        "Customer messages: left-aligned, light background",
        "AI messages: right-aligned, branded color, labeled 'AI'",
        "Human messages: right-aligned, different style from AI, labeled with user name",
        "Show timestamp in relative format (e.g., '2m ago')",
        "Support displaying images if mediaUrl is present",
        "BROWSER TEST: Render StatusBadge with each status, verify correct text and color",
        "BROWSER TEST: Render MessageBubble for customer/AI/human, verify alignment differs"
      ]
    },
    {
      "id": "S10",
      "title": "Create conversation list page with filtering",
      "priority": 10,
      "passes": true,
      "ultrawork": true,
      "acceptanceCriteria": [
        "Create apps/web/src/routes/dashboard/conversations/index.tsx",
        "Create route as protected (requires auth)",
        "Fetch conversations using conversations.list query",
        "Create ConversationList component displaying all conversations",
        "Each row shows: customer name/phone, last message preview (truncated), relative time, StatusBadge",
        "Escalated conversations appear at top with prominent red badge",
        "Show unread indicator dot for conversations with unread messages",
        "Add filter dropdown: All, Escalated, Active, Closed",
        "Add search input for filtering by customer phone or name",
        "Real-time updates via Convex useQuery (auto-refresh when data changes)",
        "Click conversation row to open detail (navigate to /dashboard/conversations/[id])",
        "Show empty state when no conversations match filter",
        "BROWSER TEST: Navigate to /dashboard/conversations, verify list renders",
        "BROWSER TEST: Verify filter dropdown is visible and functional",
        "BROWSER TEST: Verify search input filters conversations",
        "BROWSER TEST: Click a conversation row, verify navigation to detail page"
      ]
    },
    {
      "id": "S11",
      "title": "Create conversation detail page",
      "priority": 11,
      "passes": true,
      "ultrawork": false,
      "acceptanceCriteria": [
        "Create apps/web/src/routes/dashboard/conversations/$conversationId.tsx",
        "Create route as protected (requires auth)",
        "Fetch conversation using conversations.get query",
        "Fetch messages using conversations.messages query",
        "Display header: customer name/phone, StatusBadge",
        "Show escalation reason banner if status is 'escalated'",
        "Show order info card if order exists for this conversation",
        "Display messages using MessageBubble components",
        "Messages in chat bubble format, scrollable container",
        "Auto-scroll to bottom (most recent messages) on load",
        "Real-time updates as new messages arrive via Convex subscription",
        "Show 404 if conversation not found",
        "BROWSER TEST: Navigate to conversation detail, verify messages render",
        "BROWSER TEST: Verify escalation banner shows for escalated conversations",
        "BROWSER TEST: Verify auto-scroll positions at bottom of messages"
      ]
    },
    {
      "id": "S12",
      "title": "Create message input component with send functionality",
      "priority": 12,
      "passes": true,
      "ultrawork": false,
      "acceptanceCriteria": [
        "Create apps/web/src/components/conversation/MessageInput.tsx",
        "Props: conversationId, disabled (boolean), onSend callback",
        "Text input field at bottom of conversation detail",
        "Send button (icon) to send message",
        "Enter key sends message (Shift+Enter for newline)",
        "Call messages.sendAsHuman mutation on send",
        "Show message immediately in UI (optimistic update)",
        "Image upload button for attaching images",
        "Support paste to upload image from clipboard",
        "Input disabled when conversation not assigned to current user",
        "Show disabled state message: 'Take over to send messages'",
        "Clear input after successful send",
        "BROWSER TEST: Type in message input, verify text appears",
        "BROWSER TEST: Click send button, verify input clears",
        "BROWSER TEST: Verify input is disabled when not taken over"
      ]
    },
    {
      "id": "S13",
      "title": "Create take over and hand back UI buttons",
      "priority": 13,
      "passes": true,
      "ultrawork": false,
      "acceptanceCriteria": [
        "Add action buttons section to conversation detail page",
        "Create TakeOverButton component",
        "Button visible when conversation is AI-handled (assignedTo=null) or escalated",
        "Button text: 'Take Over'",
        "Clicking calls conversations.takeOver mutation",
        "Update UI immediately to show 'Human Active' status",
        "Create HandBackButton component",
        "Button visible when current user has taken over (assignedTo = currentUser)",
        "Button text: 'Hand Back to AI'",
        "Clicking shows confirmation dialog: 'AI will resume handling this conversation. Continue?'",
        "On confirm, calls conversations.handBack mutation",
        "Update UI to show 'AI Handling' status",
        "Show toast notifications on success/error",
        "BROWSER TEST: For AI-handled conversation, verify Take Over button visible",
        "BROWSER TEST: Click Take Over, verify status changes to Human Active",
        "BROWSER TEST: For taken-over conversation, verify Hand Back button visible",
        "BROWSER TEST: Click Hand Back, verify confirmation dialog appears"
      ]
    },
    {
      "id": "S14",
      "title": "Create close conversation UI",
      "priority": 14,
      "passes": true,
      "ultrawork": false,
      "acceptanceCriteria": [
        "Add Close button to conversation detail page action buttons",
        "Button visible for active conversations (not already closed)",
        "Button text: 'Close Conversation'",
        "Clicking calls conversations.close mutation",
        "Closed conversations show Closed badge (gray)",
        "Closed conversations appear in 'Closed' filter on list page",
        "Closed conversations still viewable and searchable",
        "Add 'Reopen' button for closed conversations",
        "Clicking Reopen calls conversations.reopen mutation",
        "Show toast notifications on success/error",
        "BROWSER TEST: Click Close button, verify status changes to Closed",
        "BROWSER TEST: Navigate to list, filter by Closed, verify conversation appears",
        "BROWSER TEST: Click Reopen on closed conversation, verify status changes to Active"
      ]
    },
    {
      "id": "S15",
      "title": "Create escalation notification trigger",
      "priority": 15,
      "passes": false,
      "ultrawork": true,
      "acceptanceCriteria": [
        "When conversation status changes to 'escalated', create notification",
        "Find business owner(s) by businessId",
        "Call notifications.create for each owner with type 'escalation'",
        "Implement in the AI conversation handler or as a Convex trigger/scheduler",
        "Notification includes conversationId for navigation",
        "Request browser notification permission on dashboard load",
        "When escalation notification created, trigger browser push notification if permitted",
        "Browser notification shows: 'Escalation: [customer name] needs help'",
        "Clicking browser notification navigates to conversation",
        "Add configurable sound alert (use Audio API)",
        "Taking over conversation marks related escalation notification as read"
      ]
    },
    {
      "id": "S16",
      "title": "Create notification bell UI component",
      "priority": 16,
      "passes": false,
      "ultrawork": false,
      "acceptanceCriteria": [
        "Create apps/web/src/components/NotificationBell.tsx",
        "Add NotificationBell to dashboard header/nav",
        "Show bell icon with unread count badge (red circle with number)",
        "Hide badge if count is 0",
        "Use notifications.unreadCount query for count",
        "Click bell opens dropdown/popover with recent notifications",
        "Each notification shows: type icon, message preview, relative time",
        "Click notification navigates to related conversation",
        "Mark notification as read when clicked",
        "Add 'Mark all as read' link at bottom of dropdown",
        "Real-time updates for new notifications via Convex subscription",
        "BROWSER TEST: Verify notification bell renders in header",
        "BROWSER TEST: If unread count > 0, verify badge shows count",
        "BROWSER TEST: Click bell, verify dropdown opens with notifications",
        "BROWSER TEST: Click a notification, verify navigation to conversation"
      ]
    },
    {
      "id": "S17",
      "title": "Add desktop split-view layout for conversations",
      "priority": 17,
      "passes": false,
      "ultrawork": false,
      "acceptanceCriteria": [
        "Update /dashboard/conversations route for split-view on desktop",
        "On screens >= 1024px: show list (left panel) + detail (right panel) side by side",
        "List panel: ~350px width, scrollable",
        "Detail panel: remaining width, shows selected conversation",
        "Clicking conversation in list updates detail panel (no full page nav)",
        "Show placeholder in detail panel when no conversation selected: 'Select a conversation'",
        "Use URL params to track selected conversation for bookmarking/sharing",
        "Keyboard navigation: arrow keys to move between conversations in list",
        "BROWSER TEST: At 1024px+ width, verify split layout renders",
        "BROWSER TEST: Click conversation in list, verify detail updates without page reload",
        "BROWSER TEST: Verify selected conversation reflected in URL"
      ]
    },
    {
      "id": "S18",
      "title": "Add mobile responsive layout",
      "priority": 18,
      "passes": false,
      "ultrawork": true,
      "acceptanceCriteria": [
        "On screens < 1024px: single column layout",
        "Conversation list shows full width on mobile",
        "Tapping conversation navigates to full-screen detail page",
        "Add back button/arrow on detail page to return to list",
        "Touch-friendly buttons: minimum 44px tap targets",
        "Touch-friendly message input with larger send button",
        "Swipe gestures optional (nice to have, not required)",
        "Test on iOS Safari and Chrome Android viewports",
        "Action buttons (Take Over, Close, etc.) accessible on mobile",
        "BROWSER TEST: At 375px width, verify single column list layout",
        "BROWSER TEST: At 375px width, tap conversation, verify full-screen detail",
        "BROWSER TEST: At 375px width, verify back button returns to list",
        "BROWSER TEST: Verify all buttons have adequate tap target size"
      ]
    },
    {
      "id": "S19",
      "title": "Add offline support with caching",
      "priority": 19,
      "passes": false,
      "ultrawork": true,
      "acceptanceCriteria": [
        "Convex provides offline support out of box - verify it works",
        "When offline, show cached conversations from Convex local cache",
        "Display offline indicator banner: 'You are offline'",
        "Messages sent while offline are queued by Convex optimistic updates",
        "When back online, queued messages sync automatically",
        "Show sync status indicator during reconnection",
        "Handle sync conflicts gracefully (server wins)",
        "Conversations list shows stale data indicator when offline",
        "Test by disabling network in DevTools",
        "BROWSER TEST: Disable network, verify offline banner appears",
        "BROWSER TEST: Disable network, verify cached conversations still visible",
        "BROWSER TEST: Re-enable network, verify offline banner disappears"
      ]
    }
  ]
}
